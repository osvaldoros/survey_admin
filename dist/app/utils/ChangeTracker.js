//>>built
define("app/utils/ChangeTracker",["dojo/_base/declare","dojo/_base/lang","dojo/Stateful","dojo/topic","app/store/StoreManager"],function(m,k,p,i,n){m=m("app.utils.ChangeTracker",[],{storeManager:n.getInstance(),__entityMap:{},recordChange:function(c,b,a,d){console.log("recordChange "+c+", property = "+b+" = "+a+", oldValue = "+d);a===!1&&(a="false");var g=this.getChangesObject(c);this.setProperty(g,b,a,d,void 0,c);a!=d&&i.publish(c+"-modified",g)},setProperty:function(c,b,a,d,g,o){if(typeof c.oldValues==
"undefined")c.oldValues={};if(b.indexOf(".")!=-1)for(var b=b.split("."),e=c,l=c.oldValues,i=0;i<b.length;i++){var f=b[i],h=void 0,j=void 0;f.indexOf("[")!=-1&&(h=f.substr(0,f.indexOf("[")),j=parseInt(f.substr(f.indexOf("[")+1,f.indexOf("]"))));if(i==b.length-1){if(typeof h!="undefined"&&!isNaN(j)){if(k.isArray(e[h])||(e[h]=[]),e[h][j]=a,g===!0)e[h][j].__replace__=!0}else if(e[f]=a,g===!0)e[f].__replace__=!0;typeof l[f]=="undefined"&&(l[f]=d)}else typeof h!="undefined"&&!isNaN(j)?(k.isArray(e[h])||
(e[h]=[]),typeof e[h][j]!="object"&&(e[h][j]={}),e=e[h][j]):(typeof e[f]!="object"&&(e[f]={}),e=e[f]),typeof l[f]!="object"&&(l[f]={}),l=l[f]}else{c[b]=a;if(g===!0)c[b].__replace__=!0;typeof c.oldValues[b]=="undefined"&&(c.oldValues[b]=d)}this.__entityMap[o]=c},isModified:function(c,b){if(typeof b=="undefined"){var a=this.getChangesObject(c),d=a.oldValues;if(typeof a=="object"&&a!=null&&typeof d=="object"&&d!=null)for(var g in a)if(g!="oldValues"&&d.hasOwnProperty(g)&&a[g]!=d[g])return!0}else if(a=
this.getChangesObject(c),typeof a!="undefined"&&a!=null&&a.hasOwnProperty(b))return!0;return!1},getChangesObject:function(c,b){if(typeof b!="undefined"&&b!=null){if(typeof b.oldValues=="undefined")b.oldValues={};this.__entityMap[c]=b}if(!this.__entityMap.hasOwnProperty(c))return{oldValues:{}};return this.__entityMap[c]},clearChangesObject:function(c){this.__entityMap.hasOwnProperty(c)&&(delete this.__entityMap[c],i.publish(c+"-cleared"))},commitChanges:function(c,b){if(typeof b=="undefined"||b==null)b=
null;var a=this.getChangesObject(c);if(a==null)return!1;var d=this.storeManager.getStore(c);delete a.oldValues;b?(this.safeCopy(b,a),this.removeNonModifiedProperties(b,a),a=d.put(b)):a=d.add(a);var g=this;a.then(function(a){g.clearChangesObject(c);typeof a=="object"&&a!=null&&!a.hasOwnProperty("error")&&(b?i.publish(c+"-saved",a):i.publish(c+"-created",a))});return a},setChange:function(c,b,a){var d=this.getChangesObject(c);this.setProperty(d,b,a,null,!0,c);i.publish(c+"-modified",d)},safeCopy:function(c,
b){for(var a in b)typeof b[a]=="object"&&typeof b[a]!="string"&&isNaN(b[a])?typeof c[a]=="undefined"||b[a].__replace__==!0?c[a]=b[a]:this.safeCopy(c[a],b[a]):c[a]=b[a]},removeNonModifiedProperties:function(c,b){var a=[],d;for(d in c)d!="id"&&d!="$ref"&&!b.hasOwnProperty(d)&&a.push(d);for(d=0;d<a.length;d++)delete c[a[d]]},mergeArrays:function(c,b){for(var a in b)if(k.isArray(b[a])&&k.isArray(c[a])){var d=k.clone(c);this.safeCopy(d[a],b[a]);b[a]=d[a]}else typeof b[a]=="object"&&typeof b[a]!="string"&&
isNaN(b[a])&&b[a]!=null&&typeof c[a]=="object"&&typeof c[a]!="string"&&isNaN(c[a])&&c[a]!=null&&this.mergeArrays(c[a],b[a])},getIds:function(c,b){if(typeof b=="object"&&typeof b!="string"&&isNaN(b)&&b!=null&&typeof c=="object"&&typeof c!="string"&&isNaN(c)&&c!=null&&c.hasOwnProperty("id"))b.id=c.id;for(var a in b)typeof b[a]=="object"&&typeof b[a]!="string"&&isNaN(b[a])&&b[a]!=null&&typeof c[a]=="object"&&typeof c[a]!="string"&&isNaN(c[a])&&c[a]!=null&&this.getIds(c[a],b[a])}});k.mixin(app.utils.ChangeTracker,
{getInstance:function(c){if(!app.utils.ChangeTracker._instance)app.utils.ChangeTracker._instance=new app.utils.ChangeTracker(c);return app.utils.ChangeTracker._instance}});return m});