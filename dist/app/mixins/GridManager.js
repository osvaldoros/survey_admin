//>>built
define("app/mixins/GridManager",["dojo/_base/declare","dojo/on","dojo/dom-attr","dojo/aspect","dojo/_base/lang","dojo/topic","dojo/store/JsonRest","app/store/StoreManager","app/utils/ChangeTracker","app/utils/HashManager","app/store/GridFormatters"],function(f,d,h,i,c,j,g,k,l,m,n){return f([],{storeManager:k.getInstance(),changeTracker:l.getInstance(),hashManager:m.getInstance(),_gridHandlersAttached:!1,_rowAspect:null,_selectAspect:null,runDefaultEdit:!0,editable:!0,configureGrid:function(a){this.__grid=
a.grid;this.__editButton=a.editButton;this.__addButton=a.addButton;this.__deleteButton=a.deleteButton;this.__searchFld=a.searchFld;this.__storeURL=null;this.__requiredPermissions=a.requiredPermissions;this._selectAspect!=null&&this._selectAspect.remove();i.after(this.__grid,"select",c.hitch(this,"afterSelection"),!0);if(typeof a.rowRenderer=="undefined")a.rowRenderer="defaultRenderer";if(typeof a.rowRenderer=="string")this._rowAspect!=null&&this._rowAspect.remove(),this._rowAspect=n.addRowRenderer(this.__grid,
a.rowRenderer);if(typeof a.gridSelectionChangeCallBack!="undefined")this.__gridSelectionChangeCallBack=a.gridSelectionChangeCallBack;if(typeof a.editEntityCallBack!="undefined")this.__editEntityCallBack=a.editEntityCallBack;if(typeof a.arrayStoreDataChangeCallBack!="undefined")this.__arrayStoreDataChangeCallBack=a.arrayStoreDataChangeCallBack;if(typeof a.runDefaultEdit!="undefined")this.runDefaultEdit=a.runDefaultEdit;this.setStore(a);this.__grid.on("dgrid-error",function(a){console.warn("error on grid: ",
a.error)});typeof this.__editButton!="undefined"&&this.__editButton!=null&&this.__editButton.set("disabled",!0);typeof this.__deleteButton!="undefined"&&this.__deleteButton!=null&&this.__deleteButton.set("disabled",!0)},getStore:function(){return this.__store},setStore:function(a,b){this.__configObject=a;if(typeof a.filterFunction!="function")a.filterFunction=c.hitch(this,"arrayStoreSearch");if(typeof a.store!="undefined"&&c.isArray(a.store))this.__store=this.storeManager.getArrayStore(a.store,c.hitch(this,
"arrayStoreDataChange"),a.getChildren,a.filterFunction,a.mayHaveChildren),this.isREST=!1;else if(typeof a.store=="string")this.__storeURL=a.store,this.isREST=!0,this.__store=this.storeManager.getStore(a.store,a.base_query);if(typeof a.edit_store!="undefined"&&c.isArray(a.edit_store))this.__edit_store=this.storeManager.getArrayStore(a.edit_store,c.hitch(this,"arrayStoreDataChange"),a.edit_getChildren,a.edit_filterFunction,a.edit_mayHaveChildren);else if(typeof a.edit_store=="string")this.__edit_storeURL=
a.edit_store,this.__edit_store=this.storeManager.getStore(a.edit_store,a.edit_base_query);typeof a.columns!="undefined"&&c.isArray(a.columns)&&this.__grid.set("columns",a.columns);typeof a.selectionMode!="undefined"?this.__grid.set("selectionMode",a.selectionMode):this.__grid.set("selectionMode","single");typeof this.__store!="undefined"&&(this.__grid.set("store",this.__store),this.__grid.set("getBeforePut",!1),this.__grid.set("noDataMessage","No records found"));typeof a.query!="undefined"&&a.query!=
null&&this.__grid.set("query",a.query);b!=!0&&typeof this.__searchFld!="undefined"&&this.__searchFld!=null&&this.__searchFld.set("value","");this.__updateButtonsEnable()},onActivate:function(){this.inherited(arguments);if(typeof this.eventHandlers=="undefined")this.eventHandlers=[];this.__storeURL!=null&&this.eventHandlers.push(j.subscribe(this.__storeURL+"-loadedComplete",c.hitch(this,"storeDataLoaded")));if(typeof this.__deleteButton!="undefined"&&this.__deleteButton!=null&&!this._deleteButtonHandler)this._deleteButtonHandler=
d(this.__deleteButton,"click",c.hitch(this,"onDeleteClicked"));if(typeof this.__editButton!="undefined"&&this.__editButton!=null&&!this._editButtonHandler)this._editButtonHandler=d(this.__editButton,"click",c.hitch(this,"onEditClicked"));if(typeof this.__addButton!="undefined"&&this.__addButton!=null&&!this._addButtonHandler)this._addButtonHandler=d(this.__addButton,"click",c.hitch(this,"onAddClicked"));typeof this.__searchFld!="undefined"&&this.__searchFld!=null&&this.eventHandlers.push(d(this.__searchFld,
"keypress",c.hitch(this,"onSearchFieldKeyUp")));if(typeof this.__grid!="undefined"&&this.__grid!=null){if(!this._gridHandlersAttached)d(this.__grid,"dgrid-select",c.hitch(this,"__gridSelectionChange")),d(this.__grid,"dgrid-deselect",c.hitch(this,"__gridSelectionChange")),d(this.__grid,"dblclick",c.hitch(this,"gridDoubleClick")),this._gridHandlersAttached=!0;this.__grid.set("showHeader",!0)}},onDeactivate:function(){this.inherited(arguments);for(var a=0;a<this.eventHandlers.length;a++){var b=this.eventHandlers[a];
typeof b!="undefined"&&b.remove()}this.eventHandlers=[]},storeDataLoaded:function(){},arrayStoreDataChange:function(a,b,c){typeof this.__arrayStoreDataChangeCallBack=="function"&&this.__arrayStoreDataChangeCallBack(a,b,c)},__gridSelectionChange:function(){this.__checkForDisabledRows();this.__updateButtonsEnable();typeof this.__gridSelectionChangeCallBack=="function"&&this.getSelectedEntities(c.hitch(this,"__gridSelectionChangeCallBack"),!0)},afterSelection:function(a,b,c){typeof c=="undefined"&&(c=
!0);if(typeof a=="string")a=this.__grid.row(a).element;h.set(a,"data-selected",c.toString())},refresh:function(){this.__grid.refresh()},__checkForDisabledRows:function(){for(var a in this.__grid.selection)this.__grid.row(a).data.disabled==!0&&this.__grid.deselect(a)},__updateButtonsEnable:function(){var a=0,b;for(b in this.__grid.selection)a++;if(this.hasPermission("edit")&&this.editable){if(typeof this.__editButton!="undefined"&&this.__editButton!=null)this.__editButton.domNode.style.visibility=
"visible"}else if(typeof this.__editButton!="undefined"&&this.__editButton!=null)this.__editButton.domNode.style.visibility="hidden";if(this.hasPermission("delete")){if(typeof this.__deleteButton!="undefined"&&this.__deleteButton!=null)this.__deleteButton.domNode.style.visibility="visible"}else if(typeof this.__deleteButton!="undefined"&&this.__deleteButton!=null)this.__deleteButton.domNode.style.visibility="hidden";a>0?(typeof this.__deleteButton!="undefined"&&this.__deleteButton!=null&&this.__deleteButton.set("disabled",
!1),typeof this.__editButton!="undefined"&&this.__editButton!=null&&this.__editButton.set("disabled",!1)):(typeof this.__deleteButton!="undefined"&&this.__deleteButton!=null&&this.__deleteButton.set("disabled",!0),typeof this.__editButton!="undefined"&&this.__editButton!=null&&this.__editButton.set("disabled",!0))},hasPermission:function(a){if(typeof this.__requiredPermissions!="object"||this.__requiredPermissions==null)return!0;if(!this.__requiredPermissions.hasOwnProperty(a))return!0;return __.authManager.hasPermission(this.__requiredPermissions[a])},
onDeleteClicked:function(){this.hasPermission("delete")?this.getSingleEntity(c.hitch(this,"__entityReadyForDelete")):(__.alert.set("message","You don't have permission to delete this item"),__.alert.show())},__entityReadyForDelete:function(a){if(typeof this._deleteConfirmMessage!="undefined")__.confirmDialog.set("confirmMessage",this._deleteConfirmMessage);else{var b="";typeof this._entityLabel!="undefined"?b+=this._entityLabel.toLowerCase():typeof a.$ref!="undefined"&&(b+=a.$ref);typeof a.name!=
"undefined"?b+=' "'+a.name+'"':b="this "+b;__.confirmDialog.set("confirmMessage","Are you sure you want to delete <br/> "+b+" ?")}__.confirmDialog.show(c.hitch(this,"deleteSelected"))},deleteSelected:function(){for(var a in this.__grid.selection)this.__store.remove(a)},onEditClicked:function(){this.hasPermission("edit")?this.editable?this.__editEntity():(__.alert.set("message","This item is not editable"),__.alert.show()):(__.alert.set("message","You don't have permission to edit this item"),__.alert.show())},
onAddClicked:function(){typeof this.setupDialog=="object"&&this.setupDialog!=null?(typeof this.setupDialog.setUpdatingEntity=="function"&&this.setupDialog.setUpdatingEntity(null,!0),typeof this.setupDialog.show=="function"&&this.setupDialog.show()):this.hashManager.setHash(this.hashManager.getModule()+"/"+this._updateStateHash+"/new/_step_0")},gridDoubleClick:function(){this.hasPermission("edit")?this.editable?this.__editEntity():(__.alert.set("message","This item is not editable"),__.alert.show()):
(__.alert.set("message","You don't have permission to edit this item"),__.alert.show())},__editEntity:function(){this.getSingleEntity(c.hitch(this,"__entityReadyForEdit"))},__entityReadyForEdit:function(a){typeof this.__editEntityCallBack=="function"&&this.__editEntityCallBack(a);this.editEntity(a)},editEntity:function(a){this.runDefaultEdit&&(typeof this.setupDialog=="object"&&this.setupDialog!=null?(typeof this.setupDialog.setUpdatingEntity=="function"&&this.setupDialog.setUpdatingEntity(a,!0),
this.isREST==!0?__.entities.setContext({entityId:a.id,entityType:a.$ref,entity:a},this.__storeURL):__.entities.setContext({entityId:a.id,entityType:a.$ref,entity:a,arrayStore:this.__store.data},""),typeof this.setupDialog.show=="function"&&this.setupDialog.show()):(this.isREST==!0?__.entities.setContext({entityId:a.id,entityType:a.$ref,entity:a},this.__storeURL):__.entities.setContext({entityId:a.id,entityType:a.$ref,entity:a,arrayStore:this.__store.data},""),this.hashManager.setHash(this.hashManager.getModule()+
"/"+this._updateStateHash+"/"+a.id+"/_step_0")))},getSelectedIds:function(){var a=[],b;for(b in this.__grid.selection)a.push(b);return a},getSingleEntity:function(a){if(typeof a=="function"){var b,c;for(c in this.__grid.selection)b=c;typeof b!="undefined"&&(b=typeof this.__edit_store=="object"&&this.__edit_store!=null?this.__edit_store.get(b):this.__store.get(b),b.then?b.then(function(b){a(b)}):a(b))}},getSelectedEntities:function(a,b){if(typeof a!="function")console.warn("You must pass a callBack function to GridManager.getSelectedEntities");
else if(typeof this.gotAllEntitiesBacllBack!="undefined"&&this.gotAllEntitiesBacllBack!=null)console.warn("Still processing a request for getSelectedEntities, please try again soon...");else{this.gotAllEntitiesBacllBack=a;this.pendingGetEntities=[];this.selectedEntities=[];for(var c in this.__grid.selection){var d=c,e;e=typeof this.__edit_store=="object"&&this.__edit_store!=null?this.__edit_store.isInstanceOf(g)&&b?this.__grid.row(d).data:this.__edit_store.get(d):this.__store.isInstanceOf(g)&&b?this.__grid.row(d).data:
this.__store.get(d);var f=this;e.then?(this.pendingGetEntities.push(d),e.then(function(a){f._gotAsyncEntity(a)})):this.selectedEntities.push(e)}this.pendingGetEntities.length==0&&this.returnEntitiesReady()}},_gotAsyncEntity:function(a){for(var b=this.pendingGetEntities.length-1;b>=0;b--)a.id==this.pendingGetEntities[b]&&(this.selectedEntities.push(a),this.pendingGetEntities.splice(b,1));this.pendingGetEntities.length==0&&this.returnEntitiesReady()},returnEntitiesReady:function(){this.selectedEntities.length==
1?this.gotAllEntitiesBacllBack(this.selectedEntities[0]):this.gotAllEntitiesBacllBack(this.selectedEntities);this.gotAllEntitiesBacllBack=null},onSearchFieldKeyUp:function(a){(a.keyIdentifier=="Enter"||a.key=="Enter"||a.keyCode==13)&&this.applyNewQuery()},applyNewQuery:function(){var a=this.__searchFld.displayedValue;this.isREST==!0?a==""?this.__grid.set("query",{}):this.__grid.set("query",{_q:a}):this.setStore(this.__configObject,!0)},arrayStoreSearch:function(a){if(typeof this.__searchFld!="undefined"&&
this.__searchFld!=null){var b=this.__searchFld.displayedValue;return b==""?!0:typeof a.name=="string"?a.name.toLowerCase().indexOf(b.toLowerCase())!=-1:!0}else return!0}})});