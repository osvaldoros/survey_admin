//>>built
define("dojo/dnd/Manager",["../main","../Evented","./common","./autoscroll","./Avatar"],function(a,e){var d=a.declare("dojo.dnd.Manager",[e],{constructor:function(){this.source=this.avatar=null;this.nodes=[];this.copy=!0;this.target=null;this.canDropFlag=!1;this.events=[]},OFFSET_X:16,OFFSET_Y:16,overSource:function(b){if(this.avatar)this.target=b&&b.targetState!="Disabled"?b:null,this.canDropFlag=Boolean(this.target),this.avatar.update();a.publish("/dnd/source/over",[b])},outSource:function(b){if(this.avatar){if(this.target==
b)this.target=null,this.canDropFlag=!1,this.avatar.update(),a.publish("/dnd/source/over",[null])}else a.publish("/dnd/source/over",[null])},startDrag:function(b,c,d){this.source=b;this.nodes=c;this.copy=Boolean(d);this.avatar=this.makeAvatar();a.body().appendChild(this.avatar.node);a.publish("/dnd/start",[b,c,this.copy]);this.events=[a.connect(a.doc,"onmousemove",this,"onMouseMove"),a.connect(a.doc,"onmouseup",this,"onMouseUp"),a.connect(a.doc,"onkeydown",this,"onKeyDown"),a.connect(a.doc,"onkeyup",
this,"onKeyUp"),a.connect(a.doc,"ondragstart",a.stopEvent),a.connect(a.body(),"onselectstart",a.stopEvent)];a.addClass(a.body(),"dojoDnd"+(d?"Copy":"Move"))},canDrop:function(a){a=Boolean(this.target&&a);if(this.canDropFlag!=a)this.canDropFlag=a,this.avatar.update()},stopDrag:function(){a.removeClass(a.body(),["dojoDndCopy","dojoDndMove"]);a.forEach(this.events,a.disconnect);this.events=[];this.avatar.destroy();this.source=this.target=this.avatar=null;this.nodes=[]},makeAvatar:function(){return new a.dnd.Avatar(this)},
updateAvatar:function(){this.avatar.update()},onMouseMove:function(b){var c=this.avatar;if(c)a.dnd.autoScrollNodes(b),c=c.node.style,c.left=b.pageX+this.OFFSET_X+"px",c.top=b.pageY+this.OFFSET_Y+"px",b=Boolean(this.source.copyState(a.isCopyKey(b))),this.copy!=b&&this._setCopyStatus(b)},onMouseUp:function(b){this.avatar&&(this.target&&this.canDropFlag?(b=[this.source,this.nodes,Boolean(this.source.copyState(a.isCopyKey(b))),this.target,b],a.publish("/dnd/drop/before",b),a.publish("/dnd/drop",b)):a.publish("/dnd/cancel"),
this.stopDrag())},onKeyDown:function(b){if(this.avatar)switch(b.keyCode){case a.keys.CTRL:b=Boolean(this.source.copyState(!0));this.copy!=b&&this._setCopyStatus(b);break;case a.keys.ESCAPE:a.publish("/dnd/cancel"),this.stopDrag()}},onKeyUp:function(b){this.avatar&&b.keyCode==a.keys.CTRL&&(b=Boolean(this.source.copyState(!1)),this.copy!=b&&this._setCopyStatus(b))},_setCopyStatus:function(b){this.copy=b;this.source._markDndStatus(this.copy);this.updateAvatar();a.replaceClass(a.body(),"dojoDnd"+(this.copy?
"Copy":"Move"),"dojoDnd"+(this.copy?"Move":"Copy"))}});a.dnd._manager=null;d.manager=a.dnd.manager=function(){if(!a.dnd._manager)a.dnd._manager=new a.dnd.Manager;return a.dnd._manager};return d});