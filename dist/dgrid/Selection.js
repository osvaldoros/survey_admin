//>>built
define("dgrid/Selection",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/Deferred","dojo/on","dojo/has","dojo/aspect","./List","dojo/has!touch?./util/touch","put-selector/put","dojo/query"],function(k,l,m,g,n,o,p,h,i){var j=n("mac")?"metaKey":"ctrlKey";return l([p],{selectionDelegate:".dgrid-row",selectionEvents:"mousedown,dgrid-cellfocusin",deselectOnRefresh:!0,allowSelectAll:!1,create:function(){this.selection={};return this.inherited(arguments)},postCreate:function(){this.inherited(arguments);
this._initSelectionEvents()},selection:{},selectionMode:"extended",_setSelectionMode:function(a){if(a!=this.selectionMode)this.clearSelection(),this._lastSelected=null,this.selectionMode=a},setSelectionMode:function(a){k.deprecated("setSelectionMode(...)",'use set("selectionMode", ...) instead',"dgrid 1.0");this.set("selectionMode",a)},_handleSelect:function(a,b){if(!(this.selectionMode=="none"||a.type=="dgrid-cellfocusin"&&a.parentType=="mousedown")){var c=a.type=="mousedown"?a[j]:a.ctrlKey;if(a.type==
"mousedown"||!a.ctrlKey||a.keyCode==32){var f=this.selectionMode,d=this.row(b),e=this._lastSelected;if(f=="single")e==b?c&&this.select(b,null,null):(this.clearSelection(),this.select(b)),this._lastSelected=b;else{var g;(a.button!=2&&f=="extended"&&!c||a.button==2&&!this.selection[d.id])&&this.clearSelection(d.id);a.shiftKey||(e=g=c?null:void 0);this.select(b,e,g);if(!e)this._lastSelected=b}a.type=="mousedown"&&(a.shiftKey||c)&&a.preventDefault()}}},_initSelectionEvents:function(){function a(a){b._handleSelect(a,
this)}var b=this,c=this.selectionDelegate;g(this.domNode,"selectstart",function(a){var b=a.target&&a.target.tagName;b!="INPUT"&&b!="TEXTAREA"&&a.preventDefault()});h?g(this.contentNode,h.selector(c,h.tap),function(a){b._handleSelect(a,this)}):g(this.contentNode,g.selector(c,this.selectionEvents),a);if(this.allowSelectAll)this.on("keydown",function(a){a[j]&&a.keyCode==65&&(a.preventDefault(),b[b.allSelected?"clearSelection":"selectAll"]())});o.before(this,"removeRow",function(a,b){b||this.row(a).id in
this.selection&&this.deselect(a)})},allowSelect:function(){return!0},_selectionEventQueue:function(a,b){var c=this,f="dgrid-"+(a?"select":"deselect"),d=this[f];if(d)return d;setTimeout(this._fireSelectionEvent=function(){if(d){var a={bubbles:!0,grid:c};a[b]=d;g.emit(c.contentNode,f,a);d=null;delete c[f]}},0);return d=this[f]=[]},select:function(a,b,c){c===void 0&&(c=!0);a.element||(a=this.row(a));if(this.allowSelect(a)){var f=this.selection,d=f[a.id];c===null&&(c=!d);var e=a.element;!c&&!this.allSelected?
delete this.selection[a.id]:f[a.id]=c;e&&(c?i(e,".dgrid-selected.ui-state-active"):i(e,"!dgrid-selected!ui-state-active"));c!=d&&e&&this._selectionEventQueue(c,"rows").push(a);if(b){b.element||(b=this.row(b));b=b.element;c=a.element;for(c=b&&(b.compareDocumentPosition?b.compareDocumentPosition(c)==2:b.sourceIndex>c.sourceIndex)?"down":"up";a.element!=b&&(a=this[c](a));)this.select(a)}}},deselect:function(a,b){this.select(a,b,!1)},clearSelection:function(a){this.allSelected=!1;for(var b in this.selection)a!==
b&&this.deselect(b)},selectAll:function(){this.allSelected=!0;this.selection={};for(var a in this._rowIdToObject)this.select(this.row(this._rowIdToObject[a]).id)},isSelected:function(a){if(!a)return!1;a.element||(a=this.row(a));return!!this.selection[a.id]},refresh:function(){this.deselectOnRefresh&&(this.clearSelection(),this._fireSelectionEvent&&this._fireSelectionEvent());this._lastSelected=null;this.inherited(arguments)},renderArray:function(){var a=this,b=this.inherited(arguments);m.when(b,function(b){var f=
a.selection,d,e,g;for(d=0;d<b.length;d++)e=a.row(b[d]),(g=e.id in f?f[e.id]:a.allSelected)&&a.select(e,null,g)});return b}})});