//>>built
define("dojox/gfx/canvasWithEvents",["dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojo/_base/Color","dojo/dom","dojo/dom-geometry","./_base","./canvas","./shape","./matrix"],function(q,i,l,v,w,r,m,g,n,o){var f=m.canvasWithEvents={};i("dojox.gfx.canvasWithEvents.Shape",g.Shape,{_testInputs:function(a,b){if(!this.canvasFill&&this.strokeStyle)this._hitTestPixel(a,b);else{this._renderShape(a);for(var c=this.getTransform(),d=0;d<b.length;++d){var e=b[d];if(!e.target){var k=e.x,h=e.y,k=
c?o.multiplyPoint(o.invert(c),k,h):{x:k,y:h};e.target=this._hitTestGeometry(a,k.x,k.y)}}}},_hitTestPixel:function(a,b){for(var c=0;c<b.length;++c){var d=b[c];if(!d.target){var e=d.x,k=d.y;a.clearRect(0,0,1,1);a.save();a.translate(-e,-k);this._render(a,!0);d.target=a.getImageData(0,0,1,1).data[0]?this:null;a.restore()}}},_hitTestGeometry:function(a,b,c){return a.isPointInPath(b,c)?this:null},_renderFill:function(a,b){a.pickingMode?"canvasFill"in this&&b&&a.fill():this.inherited(arguments)},_renderStroke:function(a){if(this.strokeStyle&&
a.pickingMode){var b=this.strokeStyle.color;try{this.strokeStyle.color=new v(a.strokeStyle),this.inherited(arguments)}finally{this.strokeStyle.color=b}}else this.inherited(arguments)},getEventSource:function(){return this.surface.getEventSource()},connect:function(a,b,c){this.surface._setupEvents(a);return arguments.length>2?l.connect(this,a,b,c):l.connect(this,a,b)},disconnect:function(a){l.disconnect(a)},oncontextmenu:function(){},onclick:function(){},ondblclick:function(){},onmouseenter:function(){},
onmouseleave:function(){},onmouseout:function(){},onmousedown:function(){},ontouchstart:function(){},touchstart:function(){},onmouseup:function(){},ontouchend:function(){},touchend:function(){},onmouseover:function(){},onmousemove:function(){},ontouchmove:function(){},touchmove:function(){},onkeydown:function(){},onkeyup:function(){}});i("dojox.gfx.canvasWithEvents.Group",[f.Shape,g.Group],{_testInputs:function(a,b){var c=this.children,d=this.getTransform(),e;if(c.length!=0){var k=[];for(e=0;e<b.length;++e){var h=
b[e];k[e]={x:h.x,y:h.y};if(!h.target){var f=h.x,g=h.y,f=d?o.multiplyPoint(o.invert(d),f,g):{x:f,y:g};h.x=f.x;h.y=f.y}}for(e=c.length-1;e>=0;--e){c[e]._testInputs(a,b);h=!0;for(d=0;d<b.length;++d)if(b[d].target==null){h=!1;break}if(h)break}for(e=0;e<b.length;++e)b[e].x=k[e].x,b[e].y=k[e].y}}});i("dojox.gfx.canvasWithEvents.Image",[f.Shape,g.Image],{_renderShape:function(a){var b=this.shape;a.pickingMode?a.fillRect(b.x,b.y,b.width,b.height):this.inherited(arguments)},_hitTestGeometry:function(a,b,c){a=
this.shape;return b>=a.x&&b<=a.x+a.width&&c>=a.y&&c<=a.y+a.height?this:null}});i("dojox.gfx.canvasWithEvents.Text",[f.Shape,g.Text],{_testInputs:function(a,b){return this._hitTestPixel(a,b)}});i("dojox.gfx.canvasWithEvents.Rect",[f.Shape,g.Rect],{});i("dojox.gfx.canvasWithEvents.Circle",[f.Shape,g.Circle],{});i("dojox.gfx.canvasWithEvents.Ellipse",[f.Shape,g.Ellipse],{});i("dojox.gfx.canvasWithEvents.Line",[f.Shape,g.Line],{});i("dojox.gfx.canvasWithEvents.Polyline",[f.Shape,g.Polyline],{});i("dojox.gfx.canvasWithEvents.Path",
[f.Shape,g.Path],{});i("dojox.gfx.canvasWithEvents.TextPath",[f.Shape,g.TextPath],{});var s={onmouseenter:"onmousemove",onmouseleave:"onmousemove",onmouseout:"onmousemove",onmouseover:"onmousemove",touchstart:"ontouchstart",touchend:"ontouchend",touchmove:"ontouchmove"},t={ontouchstart:"touchstart",ontouchend:"touchend",ontouchmove:"touchmove"},p=navigator.userAgent.toLowerCase(),x=p.search("iphone")>-1||p.search("ipad")>-1||p.search("ipod")>-1;i("dojox.gfx.canvasWithEvents.Surface",g.Surface,{constructor:function(){this._pick=
{curr:null,last:null};this._pickOfMouseUp=this._pickOfMouseDown=null},connect:function(a,b,c){return a.indexOf("touch")!==-1?(this._setupEvents(a),l.connect(this,"_on"+a+"Impl_",b,c)):(this._initMirrorCanvas(),l.connect(this.getEventSource(),a,null,n.fixCallback(this,m.fixTarget,b,c)))},_ontouchstartImpl_:function(){},_ontouchendImpl_:function(){},_ontouchmoveImpl_:function(){},_initMirrorCanvas:function(){if(!this.mirrorCanvas){var a=this._parent,b=a.ownerDocument.createElement("canvas");b.width=
1;b.height=1;b.style.position="absolute";b.style.left="-99999px";b.style.top="-99999px";a.appendChild(b);this.mirrorCanvas=b}},_setupEvents:function(a){a in s&&(a=s[a]);if(!this._eventsH||!this._eventsH[a]){this._initMirrorCanvas();if(!this._eventsH)this._eventsH={};this._eventsH[a]=l.connect(this.getEventSource(),a,n.fixCallback(this,m.fixTarget,this,"_"+a));if(a==="onclick"||a==="ondblclick")this._eventsH.onmousedown||(this._eventsH.onmousedown=l.connect(this.getEventSource(),"onmousedown",n.fixCallback(this,
m.fixTarget,this,"_onmousedown"))),this._eventsH.onmouseup||(this._eventsH.onmouseup=l.connect(this.getEventSource(),"onmouseup",n.fixCallback(this,m.fixTarget,this,"_onmouseup")))}},destroy:function(){g.Surface.destroy.apply(this);for(var a in this._eventsH)l.disconnect(this._eventsH[a]);this._eventsH=this.mirrorCanvas=null},getEventSource:function(){return this.rawNode},_invokeHandler:function(a,b,c){var d=a[b];d&&d.after?d.apply(a,[c]):b in t&&(d=a[t[b]])&&d.after&&d.apply(a,[c]);!d&&b.indexOf("touch")!==
-1&&(b="_"+b+"Impl_",(d=a[b])&&d.apply(a,[c]));!u(c)&&a.parent&&this._invokeHandler(a.parent,b,c)},_oncontextmenu:function(a){this._pick.curr&&this._invokeHandler(this._pick.curr,"oncontextmenu",a)},_ondblclick:function(a){this._pickOfMouseUp&&this._invokeHandler(this._pickOfMouseUp,"ondblclick",a)},_onclick:function(a){this._pickOfMouseUp&&this._pickOfMouseUp==this._pickOfMouseDown&&this._invokeHandler(this._pickOfMouseUp,"onclick",a)},_onmousedown:function(a){(this._pickOfMouseDown=this._pick.curr)&&
this._invokeHandler(this._pick.curr,"onmousedown",a)},_ontouchstart:function(a){this._pick.curr&&this._fireTouchEvent(a)},_onmouseup:function(a){(this._pickOfMouseUp=this._pick.curr)&&this._invokeHandler(this._pick.curr,"onmouseup",a)},_ontouchend:function(a){if(this._pick.curr)for(var b=0;b<this._pick.curr.length;++b)if(this._pick.curr[b].target)a.gfxTarget=this._pick.curr[b].target,this._invokeHandler(this._pick.curr[b].target,"ontouchend",a)},_onmousemove:function(a){this._pick.last&&this._pick.last!=
this._pick.curr&&(this._invokeHandler(this._pick.last,"onmouseleave",a),this._invokeHandler(this._pick.last,"onmouseout",a));this._pick.curr&&(this._pick.last==this._pick.curr?this._invokeHandler(this._pick.curr,"onmousemove",a):(this._invokeHandler(this._pick.curr,"onmouseenter",a),this._invokeHandler(this._pick.curr,"onmouseover",a)))},_ontouchmove:function(a){this._pick.curr&&this._fireTouchEvent(a)},_fireTouchEvent:function(a){for(var b=[],c=0;c<this._pick.curr.length;++c){var d=this._pick.curr[c];
if(d.target){var e=d.target.__gfxtt;if(!e)e=[],d.target.__gfxtt=e;e.push(d.t);if(!d.target.__inToFire)b.push(d.target),d.target.__inToFire=!0}}if(b.length===0)this._invokeHandler(this,"on"+a.type,a);else for(c=0;c<b.length;++c)(function(){var d=b[c].__gfxtt,e=q.delegate(a,{gfxTarget:b[c]});if(x)e.preventDefault=function(){a.preventDefault()},e.stopPropagation=function(){a.stopPropagation()};e.__defineGetter__("targetTouches",function(){return d});delete b[c].__gfxtt;delete b[c].__inToFire;this._invokeHandler(b[c],
"on"+a.type,e)}).call(this)},_onkeydown:function(){},_onkeyup:function(){},_whatsUnderEvent:function(a){var b=r.position(this.rawNode,!0),c=[],d=a.changedTouches,e=a.touches;if(d)for(a=0;a<d.length;++a)c.push({t:d[a],x:d[a].pageX-b.x,y:d[a].pageY-b.y});else if(e)for(a=0;a<e.length;++a)c.push({t:e[a],x:e[a].pageX-b.x,y:e[a].pageY-b.y});else c.push({x:a.pageX-b.x,y:a.pageY-b.y});var a=this.mirrorCanvas,b=a.getContext("2d"),f=this.children;b.clearRect(0,0,a.width,a.height);b.save();b.strokeStyle="rgba(127,127,127,1.0)";
b.fillStyle="rgba(127,127,127,1.0)";b.pickingMode=!0;for(a=f.length-1;a>=0;a--){f[a]._testInputs(b,c);var g=!0;for(j=0;j<c.length;++j)if(c[j].target==null){g=!1;break}if(g)break}b.restore();return e||d?c:c[0].target}});f.createSurface=function(a,b,c){if(!b&&!c)var d=r.position(a),b=b||d.w,c=c||d.h;typeof b=="number"&&(b+="px");typeof c=="number"&&(c+="px");var d=new f.Surface,a=w.byId(a),e=a.ownerDocument.createElement("canvas");e.width=m.normalizedLength(b);e.height=m.normalizedLength(c);a.appendChild(e);
d.rawNode=e;d._parent=a;return d.surface=d};var u=function(a){if(a.cancelBubble!==void 0)return a.cancelBubble;return!1};f.fixTarget=function(a,b){if(u(a))return!1;if(!a.gfxTarget&&(b._pick.last=b._pick.curr,b._pick.curr=b._whatsUnderEvent(a),!q.isArray(b._pick.curr)))a.gfxTarget=b._pick.curr;return!0};return f});