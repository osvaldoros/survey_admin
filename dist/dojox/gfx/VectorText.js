//>>built
define("dojox/gfx/VectorText",["dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/loader","dojo/_base/xhr","./_base","dojox/xml/DomParser","dojox/html/metrics","./matrix"],function(q,y,l,D,z,i,A,B,r){var C=function(a){var b;z.get({url:a,sync:!0,load:function(a){b=a}});return b};q.getObject("dojox.gfx.VectorText",!0);q.mixin(i,{vectorFontFitting:{NONE:0,FLOW:1,FIT:2},defaultVectorText:{type:"vectortext",x:0,y:0,width:null,height:null,text:"",align:"start",decoration:"none",fitting:0,
leading:1.5},defaultVectorFont:{type:"vectorfont",size:"10pt",family:null},_vectorFontCache:{},_svgFontCache:{},getVectorFont:function(a){if(i._vectorFontCache[a])return i._vectorFontCache[a];return new i.VectorFont(a)}});return y("dojox.gfx.VectorFont",null,{_entityRe:/&(quot|apos|lt|gt|amp|#x[^;]+|#\d+);/g,_decodeEntitySequence:function(a){if(a.match(this._entityRe)){for(var b={amp:"&",apos:"'",quot:'"',lt:"<",gt:">"},d,f="";(d=this._entityRe.exec(a))!==null;)f+=d[1].charAt(1)=="x"?String.fromCharCode(parseInt(d[1].slice(2),
16)):isNaN(parseInt(d[1].slice(1),10))?b[d[1]]||"":String.fromCharCode(parseInt(d[1].slice(1),10));return f}},_parse:function(a,b){var d=i._svgFontCache[b]||A.parse(a),f=d.documentElement.byName("font")[0],c=d.documentElement.byName("font-face")[0],g=parseFloat(c.getAttribute("units-per-em")||1E3,10),h={x:parseFloat(f.getAttribute("horiz-adv-x"),10),y:parseFloat(f.getAttribute("vert-adv-y")||0,10)};if(!h.y)h.y=g;var f={horiz:{x:parseFloat(f.getAttribute("horiz-origin-x")||0,10),y:parseFloat(f.getAttribute("horiz-origin-y")||
0,10)},vert:{x:parseFloat(f.getAttribute("vert-origin-x")||0,10),y:parseFloat(f.getAttribute("vert-origin-y")||0,10)}},e=c.getAttribute("font-family"),m=c.getAttribute("font-style")||"all",k=c.getAttribute("font-variant")||"normal",r=c.getAttribute("font-weight")||"all",n=c.getAttribute("font-stretch")||"normal",p=c.getAttribute("unicode-range")||"U+0-10FFFF";c.getAttribute("panose-1");c.getAttribute("cap-height");var u=parseFloat(c.getAttribute("ascent")||g-f.vert.y,10),v=parseFloat(c.getAttribute("descent")||
f.vert.y,10),o={},j=e;c.byName("font-face-name")[0]&&(j=c.byName("font-face-name")[0].getAttribute("name"));if(!i._vectorFontCache[j]){l.forEach(["alphabetic","ideographic","mathematical","hanging"],function(a){var b=c.getAttribute(a);b!==null&&(o[a]=parseFloat(b,10))});var s=parseFloat(d.documentElement.byName("missing-glyph")[0].getAttribute("horiz-adv-x")||h.x,10),w={},t={},x=d.documentElement.byName("glyph");l.forEach(x,function(a){var b=a.getAttribute("unicode"),d=a.getAttribute("glyph-name"),
c=parseFloat(a.getAttribute("horiz-adv-x")||h.x,10),a=a.getAttribute("d");b.match(this._entityRe)&&(b=this._decodeEntitySequence(b));c={code:b,name:d,xAdvance:c,path:a};w[b]=c;t[d]=c},this);x=d.documentElement.byName("hkern");l.forEach(x,function(a){var b=-parseInt(a.getAttribute("k"),10),d=a.getAttribute("u1"),c=a.getAttribute("g1"),e=a.getAttribute("u2"),a=a.getAttribute("g2"),f;d?(d=this._decodeEntitySequence(d),w[d]&&(f=w[d])):t[c]&&(f=t[c]);if(f){if(!f.kern)f.kern={};e?(e=this._decodeEntitySequence(e),
f.kern[e]={x:b}):t[a]&&(f.kern[t[a].code]={x:b})}},this);q.mixin(this,{family:e,name:j,style:m,variant:k,weight:r,stretch:n,range:p,viewbox:{width:g,height:g},origin:f,advance:q.mixin(h,{missing:{x:s,y:s}}),ascent:u,descent:v,baseline:o,glyphs:w});i._vectorFontCache[j]=this;i._vectorFontCache[b]=this;j!=e&&!i._vectorFontCache[e]&&(i._vectorFontCache[e]=this);i._svgFontCache[b]||(i._svgFontCache[b]=d)}},_clean:function(){var a=this.name,b=this.family;l.forEach(["family","name","style","variant","weight",
"stretch","range","viewbox","origin","advance","ascent","descent","baseline","glyphs"],function(a){try{delete this[a]}catch(b){}},this);i._vectorFontCache[a]&&delete i._vectorFontCache[a];i._vectorFontCache[b]&&delete i._vectorFontCache[b];return this},constructor:function(a){this._defaultLeading=1.5;a!==void 0&&this.load(a)},load:function(a){this.onLoadBegin(a.toString());this._parse(i._svgFontCache[a.toString()]||C(a.toString()),a.toString());this.onLoad(this);return this},initialized:function(){return this.glyphs!==
null},_round:function(a){return Math.round(1E3*a)/1E3},_leading:function(a){return this.viewbox.height*(a||this._defaultLeading)},_normalize:function(a){return a.replace(/\s+/g,String.fromCharCode(32))},_getWidth:function(a){var b=0,d=0,f=null;l.forEach(a,function(c,g){d=c.xAdvance;a[g]&&c.kern&&c.kern[a[g].code]&&(d+=c.kern[a[g].code].x);b+=d;f=c});f&&f.code==" "&&(b-=f.xAdvance);return this._round(b)},_getLongestLine:function(a){var b=0,d=0;l.forEach(a,function(a,c){var g=Math.max(b,this._getWidth(a));
g>b&&(b=g,d=c)},this);return{width:b,index:d,line:a[d]}},_trim:function(a){var b=function(a){a.length&&(a[a.length-1].code==" "&&a.splice(a.length-1,1),a.length&&a[0].code==" "&&a.splice(0,1))};q.isArray(a[0])?l.forEach(a,b):b(a);return a},_split:function(a,b){for(var d=this._getWidth(a),d=Math.floor(d/b),f=[],c=0,g=[],h=!1,e=0,i=a.length;e<i;e++){a[e].code==" "&&(h=!0);c+=a[e].xAdvance;e+1<i&&a[e].kern&&a[e].kern[a[e+1].code]&&(c+=a[e].kern[a[e+1].code].x);if(c>=d){for(c=a[e];h&&c.code!=" "&&e>=
0;)c=g.pop(),e--;f.push(g);g=[];c=0;h=!1}g.push(a[e])}g.length&&f.push(g);return this._trim(f)},_getSizeFactor:function(a){a+="";var b=B.getCachedFontMeasurements(),d=this.viewbox.height,f=b["1em"],f=parseFloat(a,10);return a.indexOf("em")>-1?this._round(b["1em"]*f/d):a.indexOf("ex")>-1?this._round(b["1ex"]*f/d):a.indexOf("pt")>-1?this._round(b["12pt"]/12*f/d):a.indexOf("px")>-1?this._round(b["16px"]/16*f/d):a.indexOf("%")>-1?this._round(b["1em"]*(f/100)/d):(f=b[a]||b.medium,this._round(f/d))},_getFitFactor:function(a,
b,d,f){if(d){var c=this._getLongestLine(a).width;return this._round(Math.min(b/c,d/(a.length*this.viewbox.height*f-(this.viewbox.height*f-this.viewbox.height))))}else return this._round(b/this._getWidth(a))},_getBestFit:function(a,b,d,f){for(var c=32,g=0,h=c;c>0;){var e=this._getFitFactor(this._split(a,c),b,d,f);e>g&&(g=e,h=c);c--}return{scale:g,lines:this._split(a,h)}},_getBestFlow:function(a,b,d){for(var f=[],c=0,g=[],h=!1,e=0,i=a.length;e<i;e++){a[e].code==" "&&(h=!0);var k=a[e].xAdvance;e+1<i&&
a[e].kern&&a[e].kern[a[e+1].code]&&(k+=a[e].kern[a[e+1].code].x);c+=d*k;if(c>=b){for(c=a[e];h&&c.code!=" "&&e>=0;)c=g.pop(),e--;f.push(g);g=[];c=0;h=!1}g.push(a[e])}g.length&&f.push(g);return this._trim(f)},getWidth:function(a,b){return this._getWidth(l.map(this._normalize(a).split(""),function(a){return this.glyphs[a]||{xAdvance:this.advance.missing.x}},this))*(b||1)},getLineHeight:function(a){return this.viewbox.height*(a||1)},getCenterline:function(a){return(a||1)*(this.viewbox.height/2)},getBaseline:function(a){return(a||
1)*(this.viewbox.height+this.descent)},draw:function(a,b,d,f,c){if(!this.initialized())throw Error("dojox.gfx.VectorFont.draw(): we have not been initialized yet.");var g=a.createGroup();if(b.x||b.y)a.applyTransform({dx:b.x||0,dy:b.y||0});var h=l.map(this._normalize(b.text).split(""),function(a){return this.glyphs[a]||{path:null,xAdvance:this.advance.missing.x}},this),a=d.size,e=b.fitting,m=b.width,k=b.height,d=b.align,b=b.leading||this._defaultLeading;if(e&&(e==i.vectorFontFitting.FLOW&&!m||e==i.vectorFontFitting.FIT&&
(!m||!k)))e=i.vectorFontFitting.NONE;switch(e){case i.vectorFontFitting.FIT:h=this._getBestFit(h,m,k,b);a=h.scale;h=h.lines;break;case i.vectorFontFitting.FLOW:a=this._getSizeFactor(a);h=this._getBestFlow(h,m,a);break;default:a=this._getSizeFactor(a),h=[h]}for(var h=l.filter(h,function(a){return a.length>0}),m=0,e=this._getLongestLine(h).width,k=0,q=h.length;k<q;k++){for(var n=0,p=h[k],u=this._getWidth(p),v=g.createGroup(),o=0;o<p.length;o++){var j=p[o];if(j.path!==null){var s=v.createPath(j.path).setFill(f);
c&&s.setStroke(c);s.setTransform([r.flipY,r.translate(n,-this.viewbox.height-this.descent)])}n+=j.xAdvance;o+1<p.length&&j.kern&&j.kern[p[o+1].code]&&(n+=j.kern[p[o+1].code].x)}n=0;d=="middle"?n=e/2-u/2:d=="end"&&(n=e-u);v.setTransform({dx:n,dy:m});m+=this.viewbox.height*b}g.setTransform(r.scale(a));return g},onLoadBegin:function(){},onLoad:function(){}})});