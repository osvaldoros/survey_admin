//>>built
define(["dijit","dojo","dojox","dojo/require!dojox/cometd/_base"],function(f,c,b){c.provide("dojox.cometd.longPollTransportJsonEncoded");c.require("dojox.cometd._base");b.cometd.longPollTransportJsonEncoded=new function(){this._connectionType="long-polling";this._cometd=null;this.check=function(a,b,d){return!d&&c.indexOf(a,"long-polling")>=0};this.tunnelInit=function(){var a={channel:"/meta/connect",clientId:this._cometd.clientId,connectionType:this._connectionType,id:""+this._cometd.messageId++},
a=this._cometd._extendOut(a);this.openTunnelWith([a])};this.tunnelCollapse=function(){this._cometd._initialized&&(this._cometd._advice&&this._cometd._advice.reconnect=="none"||(this._cometd._status=="connected"?setTimeout(c.hitch(this,function(){this._connect()}),this._cometd._interval()):setTimeout(c.hitch(this._cometd,function(){this.init(this.url,this._props)}),this._cometd._interval())))};this._connect=function(){if(this._cometd._initialized&&!this._cometd._polling)if(this._cometd._advice&&this._cometd._advice.reconnect==
"handshake")this._cometd._status="unconnected",this._initialized=!1,this._cometd.init(this._cometd.url,this._cometd._props);else if(this._cometd._status=="connected"){var a={channel:"/meta/connect",connectionType:this._connectionType,clientId:this._cometd.clientId,id:""+this._cometd.messageId++};if(this._cometd.connectTimeout>=this._cometd.expectedNetworkDelay)a.advice={timeout:this._cometd.connectTimeout-this._cometd.expectedNetworkDelay};a=this._cometd._extendOut(a);this.openTunnelWith([a])}};this.deliver=
function(){};this.openTunnelWith=function(a,b){this._cometd._polling=!0;var d={url:b||this._cometd.url,postData:c.toJson(a),contentType:"text/json;charset=UTF-8",handleAs:this._cometd.handleAs,load:c.hitch(this,function(a){this._cometd._polling=!1;this._cometd.deliver(a);this._cometd._backon();this.tunnelCollapse()}),error:c.hitch(this,function(a){this._cometd._polling=!1;this._cometd._publishMeta("connect",!1,{failure:!0,error:a,advice:this._cometd._advice});this._cometd._backoff();this.tunnelCollapse()})},
e=this._cometd._connectTimeout();if(e>0)d.timeout=e;this._poll=c.rawXhrPost(d)};this.sendMessages=function(a){for(var b=0;b<a.length;b++)a[b].clientId=this._cometd.clientId,a[b].id=""+this._cometd.messageId++,a[b]=this._cometd._extendOut(a[b]);return c.rawXhrPost({url:this._cometd.url||c.config.cometdRoot,handleAs:this._cometd.handleAs,load:c.hitch(this._cometd,"deliver"),postData:c.toJson(a),contentType:"text/json;charset=UTF-8",error:c.hitch(this,function(){this._cometd._publishMeta("publish",!1,
{messages:a})}),timeout:this._cometd.expectedNetworkDelay})};this.startup=function(){this._cometd._status!="connected"&&this.tunnelInit()};this.disconnect=function(){var a={channel:"/meta/disconnect",clientId:this._cometd.clientId,id:""+this._cometd.messageId++},a=this._cometd._extendOut(a);c.rawXhrPost({url:this._cometd.url||c.config.cometdRoot,handleAs:this._cometd.handleAs,postData:c.toJson([a]),contentType:"text/json;charset=UTF-8"})};this.cancelConnect=function(){if(this._poll)this._poll.cancel(),
this._cometd._polling=!1,this._cometd._publishMeta("connect",!1,{cancel:!0}),this._cometd._backoff(),this.disconnect(),this.tunnelCollapse()}};b.cometd.longPollTransport=b.cometd.longPollTransportJsonEncoded;b.cometd.connectionTypes.register("long-polling",b.cometd.longPollTransport.check,b.cometd.longPollTransportJsonEncoded);b.cometd.connectionTypes.register("long-polling-json-encoded",b.cometd.longPollTransport.check,b.cometd.longPollTransportJsonEncoded)});