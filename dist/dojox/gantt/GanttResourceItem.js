//>>built
define(["dijit","dojo","dojox","dojo/require!dojo/date/locale"],function(j,b){b.provide("dojox.gantt.GanttResourceItem");b.require("dojo.date.locale");b.declare("dojox.gantt.GanttResourceItem",null,{constructor:function(a){this.ganttChart=a;this.ownerItem=[];this.ownerNameItem=[];this.ownerTaskNodeMapping={};this.ownerTaskNodeMapping_time={};this.resourceInfo={};this.ownerTimeConsume={}},clearAll:function(){this.clearData();this.clearItems()},clearData:function(){this.ownerItem=[];this.ownerNameItem=
[];this.ownerTaskNodeMapping={};this.ownerTaskNodeMapping_time={};this.resourceInfo={};this.ownerTimeConsume={}},clearItems:function(){this.content.firstChild&&b.destroy(this.content.firstChild)},buildResource:function(){var a={};b.forEach(this.ganttChart.arrProjects,function(c){b.forEach(c.arrTasks,function(b){b.buildResourceInfo(a)},this)},this);return a},buildOwnerTimeConsume:function(){var a={},b;for(b in this.resourceInfo){for(var d=this.resourceInfo[b],e={},f=0;f<d.length;f++){var h=d[f],g=
h.taskItem.startTime.getTime(),h=h.taskItem.duration*864E5/this.ganttChart.hsPerDay;e.min=e.min?Math.min(e.min,g):g;e.max=e.max?Math.max(e.max,g+h):g+h}e.dur=(e.max-e.min)*this.ganttChart.hsPerDay/864E5;e.min=new Date(e.min);e.max=new Date(e.max);a[b]=e}return a},refresh:function(){this.ownerTimeConsume=this.buildOwnerTimeConsume();this.contentData.firstChild.style.width=Math.max(1200,this.ganttChart.pixelsPerDay*this.ganttChart.totalDays)+"px";for(var a in this.resourceInfo)this.refreshOwnerEntry(a)},
reConstruct:function(){this.clearAll();this.resourceInfo=this.buildResource();this.ownerTimeConsume=this.buildOwnerTimeConsume();this.tableControl=b.create("table",{cellPadding:"0",cellSpacing:"0",className:"ganttResourceTableControl"});var a=this.tableControl.insertRow(this.tableControl.rows.length);this.contentHeight=this.content.offsetHeight;this.contentWidth=this.content.offsetWidth;this.content.appendChild(this.tableControl);this.contentData=b.create("div",{className:"ganttResourceContentDataContainer"});
this.contentData.appendChild(this.createPanelOwners());b.style(this.contentData,"height",this.contentHeight-this.ganttChart.panelTimeHeight+"px");var c=b.create("td",{vAlign:"top"});this.panelNames=b.create("div",{className:"ganttResourcePanelNames"});this.panelNames.appendChild(this.createPanelNamesOwners());c.appendChild(this.panelNames);a.appendChild(c);var c=b.create("td",{vAlign:"top"}),d=b.create("div",{className:"ganttResourceDivCell"});d.appendChild(this.contentData);c.appendChild(d);a.appendChild(c);
b.style(this.panelNames,{height:this.contentHeight-this.ganttChart.panelTimeHeight-this.ganttChart.scrollBarWidth+"px",width:this.ganttChart.maxWidthPanelNames+"px"});this.contentData.style.width=this.contentWidth-this.ganttChart.maxWidthPanelNames+"px";this.contentData.firstChild.style.width=this.ganttChart.pixelsPerDay*this.ganttChart.panelTime.firstChild.firstChild.rows[3].cells.length+"px";var e=this;this.contentData.onscroll=function(){if(e.panelNames)e.panelNames.scrollTop=this.scrollTop};this.contentData.scrollLeft=
this.ganttChart.contentData.scrollLeft;for(var f in this.resourceInfo)this.createOwnerEntry(f);this.postAdjustment()},create:function(){var a=b.create("div",{innerHTML:"Resource Chart:",className:"ganttResourceHeader"},this.ganttChart.content,"after");b.style(a,"width",this.ganttChart.contentWidth+"px");a=b.create("div",{className:"ganttResourceContent"},a,"after");b.style(a,{width:this.ganttChart.contentWidth+"px",height:(this.ganttChart.resourceChartHeight||this.ganttChart.contentHeight*0.8)+"px"});
this.content=a||this.content;this.reConstruct()},postAdjustment:function(){this.contentData.firstChild.style.height=this.ownerItem.length*23+"px";this.panelNames.firstChild.style.height=this.ownerItem.length*23+"px"},refreshOwnerEntry:function(a){this.refreshOwnerItem(a);b.forEach(this.resourceInfo[a],function(b,d){this.refreshDetailedTaskEntry(a,this.ownerTaskNodeMapping[a].tasks[d][0],b)},this)},createOwnerEntry:function(a){var c=this.contentData.firstChild,d=this.ownerItem[this.ownerItem.length-
1];this.ownerTaskNodeMapping[a]={};this.ownerTaskNodeMapping[a][a]=[];b.position(c);var d=(d?parseInt(d.style.top):-17)+this.ganttChart.heightTaskItem+11,e=this.createOwnerItem(a,d);c.appendChild(e);this.ownerItem.push(e);this.ownerTaskNodeMapping[a][a].push(e);this.panelNames&&(c=this.createOwnerNameItem(a,d),this.panelNames.firstChild.appendChild(c),this.ownerNameItem.push(c),this.ownerTaskNodeMapping[a][a].push(c));var f=this.ownerNameItem[this.ownerNameItem.length-1];this.panelNames&&(this.checkWidthTaskNameItem(f),
c=this.createTreeImg(f),this.panelNames.firstChild.appendChild(c),this.ownerTaskNodeMapping[a][a].push(c));this.ownerTaskNodeMapping[a].taskCount=this.resourceInfo[a].length;this.ownerTaskNodeMapping[a].isOpen=!1;this.ownerTaskNodeMapping[a].tasks=[];b.forEach(this.resourceInfo[a],function(b){this.ownerTaskNodeMapping[a].tasks.push(this.createDetailedTaskEntry(a,f,b))},this);return this},createOwnerNameItem:function(a,c){var d=b.create("div",{id:a,title:a,innerHTML:a,className:"ganttOwnerNameItem"});
b.style(d,"top",c+"px");return d},refreshOwnerItem:function(a){var c=this.ownerTaskNodeMapping[a][a][0],d=this.ownerTimeConsume[a].dur,e=this.ganttChart.getPosOnDate(this.ownerTimeConsume[a].min);c.style.left=e+"px";c.style.width=d*this.ganttChart.pixelsPerWorkHour+"px";b.forEach(this.resourceInfo[a],function(a,d){var g=this.ganttChart.getPosOnDate(a.taskItem.startTime);b.style(c.childNodes[d],{left:g-e+"px",width:a.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px"})},this)},createOwnerItem:function(a,
c){var d=this.ownerTimeConsume[a].dur,e=this.ganttChart.getPosOnDate(this.ownerTimeConsume[a].min),f=b.create("div",{id:a,owner:!0,className:"ganttOwnerBar"});b.style(f,{left:e+"px",top:c+"px",width:d*this.ganttChart.pixelsPerWorkHour+"px",height:this.ganttChart.heightTaskItem+"px"});b.forEach(this.resourceInfo[a],function(c){var d=b.create("div",{id:a,className:"ganttOwnerTaskBar"},f),i=this.ganttChart.getPosOnDate(c.taskItem.startTime);b.style(d,{left:i-e+"px",width:c.taskItem.duration*this.ganttChart.pixelsPerWorkHour+
"px",height:this.ganttChart.heightTaskItem+"px"})},this);return f},refreshDetailedTaskEntry:function(a,b,d){this.refreshTaskItem(b,d)},createDetailedTaskEntry:function(a,c,d){var a=[],e=this.contentData.firstChild,f=parseInt(c.style.top),h=this.createTaskItem(d,f);h.style.display="none";e.appendChild(h);this.ownerItem.push(h);a.push(h);if(this.panelNames)d=this.createTaskNameItem(d.taskItem.name,f),this.panelNames.firstChild.appendChild(d),d.style.display="none",this.ownerNameItem.push(d),a.push(d);
if(this.panelNames)this.ownerNameItem[this.ownerNameItem.length-1].style.left=b.style(c,"left")+15+"px",c=this.createConnectingLinesPN(c,this.ownerNameItem[this.ownerNameItem.length-1]),b.forEach(c,function(a){a.style.display="none"},this),a.push({v:c[0],h:c[1]}),this.checkWidthTaskNameItem(this.ownerNameItem[this.ownerNameItem.length-1]);return a},createTaskNameItem:function(a,c){var d=b.create("div",{id:a,className:"ganttTaskNameItem",title:a,innerHTML:a});b.style(d,"top",c+"px");return d},refreshTaskItem:function(a,
c){var d=this.ganttChart.getPosOnDate(c.taskItem.startTime);b.style(a,{left:d+"px",width:c.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px"})},createTaskItem:function(a,c){var d=this.ganttChart.getPosOnDate(a.taskItem.startTime),e=b.create("div",{id:a.taskItem.name,className:"ganttTaskBar"});b.style(e,{left:d+"px",top:c+"px",width:a.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px",height:this.ganttChart.heightTaskItem+"px"});return e},createConnectingLinesPN:function(a,c){var d=[],
e=b.create("div",{innerHTML:"&nbsp;",className:"ganttResourceLineVerticalLeft"},this.panelNames.firstChild);e.cNode=c;e.pNode=a;var f=b.create("div",{noShade:!0,color:"#000",className:"ganttResourceLineHorizontalLeft"},this.panelNames.firstChild);f.cNode=c;f.pNode=a;this.panelNames.firstChild.appendChild(f);d.push(e);d.push(f);return d},createTreeImg:function(a){var c=b.create("div",{id:a.id,className:"ganttImageTreeExpand"});b.attr(c,"tabIndex",0);var d=this.ownerTaskNodeMapping[a.id];b.forEach(["onclick",
"onkeydown"],function(e){this.ganttChart._events.push(b.connect(c,e,this,function(f){var h=!1,g,i;if(!(e=="onkeydown"&&f.keyCode!=b.keys.ENTER))if(d.isOpen)for(g in b.removeClass(c,"ganttImageTreeCollapse"),b.addClass(c,"ganttImageTreeExpand"),d.isOpen=!1,this.ownerTaskNodeMapping)i=this.ownerTaskNodeMapping[g],h?(b.forEach(i[g],function(a){b.style(a,"top",b.style(a,"top")-d.taskCount*23+"px")}),b.forEach(i.tasks,function(a){b.forEach(a,function(a){b.forEach(!a.v&&!a.h?[a]:[a.v,a.h],function(a){b.style(a,
"top",b.style(a,"top")-d.taskCount*23+"px")})})})):g==a.id&&(h=!0,b.forEach(i.tasks,function(a){b.forEach(a,function(a){this.styleOwnerItem(a,i[g][0],"none",0)},this)},this));else for(g in b.removeClass(c,"ganttImageTreeExpand"),b.addClass(c,"ganttImageTreeCollapse"),d.isOpen=!0,this.ownerTaskNodeMapping)i=this.ownerTaskNodeMapping[g],h?(b.forEach(i[g],function(a){b.style(a,"top",b.style(a,"top")+d.taskCount*23+"px")}),b.forEach(i.tasks,function(a){b.forEach(a,function(a){b.forEach(!a.v&&!a.h?[a]:
[a.v,a.h],function(a){b.style(a,"top",b.style(a,"top")+d.taskCount*23+"px")})})})):g==a.id&&(h=!0,b.forEach(i.tasks,function(a,c){b.forEach(a,function(a){this.styleOwnerItem(a,i[g][0],"inline",(c+1)*23)},this)},this))}))},this);b.addClass(c,"ganttResourceTreeImage");b.style(c,{left:b.style(a,"left")-12+"px",top:b.style(a,"top")+3+"px"});return c},styleOwnerItem:function(a,c,d,e){a.v||a.h?(b.style(a.v,{height:Math.max(1,a.v.cNode.offsetTop-a.v.pNode.offsetTop)+"px",top:a.v.pNode.offsetTop+5+"px",left:a.v.pNode.offsetLeft-
9+"px",display:d}),b.style(a.h,{width:Math.max(1,a.h.cNode.offsetLeft-a.h.pNode.offsetLeft+4)+"px",top:a.h.cNode.offsetTop+5+"px",left:a.h.pNode.offsetLeft-9+"px",display:d})):b.style(a,{display:d,top:parseInt(c.style.top)+e+"px"})},checkWidthTaskNameItem:function(a){if(a&&a.offsetWidth+a.offsetLeft>this.ganttChart.maxWidthPanelNames){var b=a.id.substring(0,a.firstChild.length-Math.round((a.offsetWidth+a.offsetLeft-this.ganttChart.maxWidthPanelNames)/(a.offsetWidth/a.firstChild.length))-3);a.innerHTML=
b+"..."}},createPanelOwners:function(){var a=b.create("div",{className:"ganttOwnerPanel"});b.style(a,{height:this.contentHeight-this.ganttChart.panelTimeHeight-this.ganttChart.scrollBarWidth+"px"});return a},createPanelNamesOwners:function(){var a=b.create("div",{innerHTML:"&nbsp;",className:"ganttResourcePanelNamesOwners"});b.style(a,{height:this.contentHeight-this.ganttChart.panelTimeHeight-this.ganttChart.scrollBarWidth+"px",width:this.ganttChart.maxWidthPanelNames+"px"});return a}})});