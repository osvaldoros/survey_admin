//>>built
define(["dijit","dojo","dojox","dojo/require!dojo/date/locale,dijit/focus"],function(l,c){c.provide("dojox.gantt.GanttTaskItem");c.require("dojo.date.locale");c.require("dijit.focus");c.declare("dojox.gantt.GanttTaskControl",null,{constructor:function(a,b,d){this.ganttChart=d;this.project=b;this.taskItem=a;this.moveChild=this.checkResize=this.checkMove=!1;this.minWidthResize=this.maxWidthResize=this.minPosXMove=this.maxPosXMove=-1;this.taskItemWidth=this.mouseX=this.posY=this.posX=0;this.isHide=!1;
this.hideTasksHeight=0;this.isExpanded=!0;this.predTask=this.parentTask=this.cTaskNameItem=this.cTaskItem=this.descrTask=null;this.childTask=[];this.childPredTask=[];this.previousParentTask=this.nextParentTask=this.previousChildTask=this.nextChildTask=null},createConnectingLinesPN:function(){var a=[],b=c.create("div",{innerHTML:"&nbsp;",className:"ganttTaskLineVerticalLeft"},this.ganttChart.panelNames.firstChild),d=this.cTaskNameItem[0],e=this.parentTask.cTaskNameItem[0];c.style(b,{height:d.offsetTop-
e.offsetTop+"px",top:e.offsetTop+5+"px",left:e.offsetLeft-9+"px"});var f=c.create("div",{noShade:!0,color:"#000000",className:"ganttTaskLineHorizontalLeft"},this.ganttChart.panelNames.firstChild);c.style(f,{left:e.offsetLeft-9+"px",top:d.offsetTop+5+"px",height:"1px",width:d.offsetLeft-e.offsetLeft+4+"px"});a.push(b);a.push(f);return a},createConnectingLinesDS:function(){var a=this.ganttChart.contentData.firstChild,b=[],d=new Image,d=c.create("div",{className:"ganttImageArrow"}),e=document.createElement("div"),
f=document.createElement("div"),g=c.style(this.predTask.cTaskItem[0],"left"),i=c.style(this.predTask.cTaskItem[0],"top"),h=c.style(this.cTaskItem[0],"left"),j=this.posY+2;parseInt(this.predTask.cTaskItem[0].firstChild.firstChild.width);var k=parseInt(this.predTask.cTaskItem[0].firstChild.firstChild.width);i<j?(c.addClass(e,"ganttTaskLineVerticalRight"),c.style(e,{height:j-this.ganttChart.heightTaskItem/2-i-3+"px",width:"1px",left:g+k-20+"px",top:i+this.ganttChart.heightTaskItem+"px"}),c.addClass(f,
"ganttTaskLineHorizontal"),c.style(f,{width:15+(h-(k+g))+"px",left:g+k-20+"px",top:j+2+"px"}),c.addClass(d,"ganttTaskArrowImg")):(c.addClass(e,"ganttTaskLineVerticalRightPlus"),c.style(e,{height:i+2-j+"px",width:"1px",left:g+k-20+"px",top:j+2+"px"}),c.addClass(f,"ganttTaskLineHorizontalPlus"),c.style(f,{width:15+(h-(k+g))+"px",left:g+k-20+"px",top:j+2+"px"}),c.addClass(d,"ganttTaskArrowImgPlus"));c.style(d,{left:h-7+"px",top:j-1+"px"});a.appendChild(e);a.appendChild(f);a.appendChild(d);b.push(e);
b.push(d);b.push(f);return b},showChildTasks:function(a,b){if(b)for(var d=0;d<a.childTask.length;d++){var c=a.childTask[d],f=c.cTaskItem[0],g=c.cTaskNameItem[0],i=c.cTaskItem[1],h=c.cTaskNameItem[1],j=c.cTaskNameItem[2];if(f.style.display=="none"){f.style.display="inline";g.style.display="inline";c.showDescTask();a.isHide=!1;if(j)j.style.display="inline",b=c.isExpanded;for(f=0;f<i.length;f++)i[f].style.display="inline";for(f=0;f<h.length;f++)h[f].style.display="inline";c.taskIdentifier&&(c.taskIdentifier.style.display=
"inline");this.hideTasksHeight+=this.ganttChart.heightTaskItem+this.ganttChart.heightTaskItemExtra;c.childTask.length>0&&this.showChildTasks(c,b)}}},hideChildTasks:function(a){for(var b=0;b<a.childTask.length;b++){var d=a.childTask[b],c=d.cTaskItem[0],f=d.cTaskNameItem[0],g=d.cTaskItem[1],i=d.cTaskNameItem[1],h=d.cTaskNameItem[2];if(c.style.display!="none"){c.style.display="none";f.style.display="none";d.hideDescTask();a.isHide=!0;if(h)h.style.display="none";for(c=0;c<g.length;c++)g[c].style.display=
"none";for(c=0;c<i.length;c++)i[c].style.display="none";d.taskIdentifier&&(d.taskIdentifier.style.display="none");this.hideTasksHeight+=this.ganttChart.heightTaskItem+this.ganttChart.heightTaskItemExtra;d.childTask.length>0&&this.hideChildTasks(d)}}},shiftCurrentTasks:function(a,b){this.shiftNextTask(this,b);a.project.shiftNextProject(a.project,b)},shiftTask:function(a,b){a.posY+=b;var c=a.cTaskItem[0],e=a.cTaskNameItem[0],f=a.cTaskItem[1],g=a.cTaskNameItem[1],i=a.cTaskNameItem[2];e.style.top=parseInt(e.style.top)+
b+"px";if(i)i.style.top=parseInt(i.style.top)+b+"px";if(a.parentTask)parseInt(this.cTaskNameItem[0].style.top)>parseInt(a.parentTask.cTaskNameItem[0].style.top)&&g[0].style.display!="none"?g[0].style.height=parseInt(g[0].style.height)+b+"px":g[0].style.top=parseInt(g[0].style.top)+b+"px",g[1].style.top=parseInt(g[1].style.top)+b+"px";c.style.top=parseInt(c.style.top)+b+"px";a.descrTask.style.top=parseInt(a.descrTask.style.top)+b+"px";if(a.predTask)(parseInt(this.cTaskItem[0].style.top)>parseInt(a.predTask.cTaskItem[0].style.top)||
this.cTaskItem[0].id==a.predTask.taskItem.id)&&f[0].style.display!="none"?f[0].style.height=parseInt(f[0].style.height)+b+"px":f[0].style.top=parseInt(f[0].style.top)+b+"px",f[1].style.top=parseInt(f[1].style.top)+b+"px",f[2].style.top=parseInt(f[2].style.top)+b+"px"},shiftNextTask:function(a,b){a.nextChildTask?(this.shiftTask(a.nextChildTask,b),this.shiftChildTask(a.nextChildTask,b),this.shiftNextTask(a.nextChildTask,b)):a.parentTask?this.shiftNextTask(a.parentTask,b):a.nextParentTask&&(this.shiftTask(a.nextParentTask,
b),this.shiftChildTask(a.nextParentTask,b),this.shiftNextTask(a.nextParentTask,b))},shiftChildTask:function(a,b){c.forEach(a.childTask,function(a){this.shiftTask(a,b);a.childTask.length>0&&this.shiftChildTask(a,b)},this)},endMove:function(){var a=this.cTaskItem[0],b=c.style(a,"left")-this.posX,b=this.getDateOnPosition(c.style(a,"left")),b=this.checkPos(b);this.checkMove&&(b=this.ganttChart.getPosOnDate(b)-this.posX,this.moveCurrentTaskItem(b,this.moveChild),this.project.shiftProjectItem());this.checkMove=
!1;this.posX=0;this.minPosXMove=this.maxPosXMove=-1;a.childNodes[1].firstChild.rows[0].cells[0].innerHTML="";this.adjustPanelTime();this.ganttChart.resource&&this.ganttChart.resource.refresh()},checkPos:function(a){var b=this.cTaskItem[0],c=a.getHours();c>=12?(a.setDate(a.getDate()+1),a.setHours(0),parseInt(b.firstChild.firstChild.width)+this.ganttChart.getPosOnDate(a)>this.maxPosXMove&&this.maxPosXMove!=-1&&(a.setDate(a.getDate()-1),a.setHours(0))):c<12&&c!=0&&(a.setHours(0),this.ganttChart.getPosOnDate(a)<
this.minPosXMove&&a.setDate(a.getDate()+1));b.style.left=this.ganttChart.getPosOnDate(a)+"px";return a},getMaxPosPredChildTaskItem:function(){for(var a=0,b=0,c=0;c<this.childPredTask.length;c++)b=this.getMaxPosPredChildTaskItemInTree(this.childPredTask[c]),b>a&&(a=b);return a},getMaxPosPredChildTaskItemInTree:function(a){var b=a.cTaskItem[0],b=parseInt(b.firstChild.firstChild.width)+c.style(b,"left"),d=0,e=0;c.forEach(a.childPredTask,function(a){e=this.getMaxPosPredChildTaskItemInTree(a);e>d&&(d=
e)},this);return d>b?d:b},moveCurrentTaskItem:function(a,b){var d=this.cTaskItem[0];this.taskItem.startTime=new Date(this.ganttChart.startDate);this.taskItem.startTime.setHours(this.taskItem.startTime.getHours()+parseInt(d.style.left)/this.ganttChart.pixelsPerHour);this.showDescTask();d=this.cTaskItem[1];if(d.length>0)d[2].style.width=parseInt(d[2].style.width)+a+"px",d[1].style.left=parseInt(d[1].style.left)+a+"px";c.forEach(this.childTask,function(c){c.predTask||this.moveChildTaskItems(c,a,b)},
this);c.forEach(this.childPredTask,function(c){this.moveChildTaskItems(c,a,b)},this)},moveChildTaskItems:function(a,b,d){var e=a.cTaskItem[0];if(d){e.style.left=parseInt(e.style.left)+b+"px";a.adjustPanelTime();a.taskItem.startTime=new Date(this.ganttChart.startDate);a.taskItem.startTime.setHours(a.taskItem.startTime.getHours()+parseInt(e.style.left)/this.ganttChart.pixelsPerHour);var f=a.cTaskItem[1];c.forEach(f,function(a){a.style.left=parseInt(a.style.left)+b+"px"},this);c.forEach(a.childTask,
function(a){a.predTask||this.moveChildTaskItems(a,b,d)},this);c.forEach(a.childPredTask,function(a){this.moveChildTaskItems(a,b,d)},this)}else if(f=a.cTaskItem[1],f.length>0)e=f[0],f=f[2],f.style.left=parseInt(f.style.left)+b+"px",f.style.width=parseInt(f.style.width)-b+"px",e.style.left=parseInt(e.style.left)+b+"px";a.moveDescTask()},adjustPanelTime:function(){var a=this.cTaskItem[0],a=parseInt(a.style.left)+parseInt(a.firstChild.firstChild.width)+this.ganttChart.panelTimeExpandDelta;a+=this.descrTask.offsetWidth;
this.ganttChart.adjustPanelTime(a)},getDateOnPosition:function(a){var b=new Date(this.ganttChart.startDate);b.setHours(b.getHours()+a/this.ganttChart.pixelsPerHour);return b},moveItem:function(a){var a=this.posX+(a.screenX-this.mouseX),b=parseInt(this.cTaskItem[0].childNodes[0].firstChild.width);this.checkMove&&this.minPosXMove<=a&&(a+b<=this.maxPosXMove||this.maxPosXMove==-1)&&this.moveTaskItem(a)},moveTaskItem:function(a){var b=this.cTaskItem[0];b.style.left=a+"px";b.childNodes[1].firstChild.rows[0].cells[0].innerHTML=
this.getDateOnPosition(a).getDate()+"."+(this.getDateOnPosition(a).getMonth()+1)+"."+this.getDateOnPosition(a).getUTCFullYear()},resizeItem:function(a){this.checkResize&&(a=this.taskItemWidth+(a.screenX-this.mouseX),a>=this.taskItemWidth?a<=this.maxWidthResize||this.maxWidthResize==-1?this.resizeTaskItem(a):this.maxWidthResize!=-1&&a>this.maxWidthResize&&this.resizeTaskItem(this.maxWidthResize):a<=this.taskItemWidth&&(a>=this.minWidthResize?this.resizeTaskItem(a):a<this.minWidthResize&&this.resizeTaskItem(this.minWidthResize)))},
resizeTaskItem:function(a){var b=this.cTaskItem[0],c=Math.round(a/this.ganttChart.pixelsPerWorkHour),e=b.childNodes[0].firstChild.rows[0],f=e.cells[0],e=e.cells[1];f&&(f.firstChild.style.width=parseInt(f.width)*a/100+"px");e&&(e.firstChild.style.width=parseInt(e.width)*a/100+"px");b.childNodes[0].firstChild.width=a+"px";b.childNodes[1].firstChild.width=a+"px";this.cTaskItem[0].childNodes[1].firstChild.rows[0].cells[0].innerHTML=c;b=b.childNodes[2];b.childNodes[0].style.width=a+"px";b.childNodes[1].style.left=
a-10+"px"},endResizeItem:function(){var a=this.cTaskItem[0];if(this.taskItemWidth!=parseInt(a.childNodes[0].firstChild.width)){var b=a.offsetLeft,c=a.offsetLeft+parseInt(a.childNodes[0].firstChild.width);this.taskItem.duration=Math.round((c-b)/this.ganttChart.pixelsPerWorkHour);if(this.childPredTask.length>0)for(b=0;b<this.childPredTask.length;b++){var e=this.childPredTask[b].cTaskItem[1],c=e[0],e=e[2],f=a.childNodes[0];e.style.width=parseInt(e.style.width)-(parseInt(f.firstChild.width)-this.taskItemWidth)+
"px";e.style.left=parseInt(e.style.left)+(parseInt(f.firstChild.width)-this.taskItemWidth)+"px";c.style.left=parseInt(c.style.left)+(parseInt(f.firstChild.width)-this.taskItemWidth)+"px"}}this.cTaskItem[0].childNodes[1].firstChild.rows[0].cells[0].innerHTML="";this.checkResize=!1;this.mouseX=this.taskItemWidth=0;this.showDescTask();this.project.shiftProjectItem();this.adjustPanelTime();this.ganttChart.resource&&this.ganttChart.resource.refresh()},startMove:function(a){this.moveChild=a.ctrlKey;this.mouseX=
a.screenX;this.getMoveInfo();this.checkMove=!0;this.hideDescTask()},showDescTask:function(){this.descrTask.style.left=parseInt(this.cTaskItem[0].style.left)+this.taskItem.duration*this.ganttChart.pixelsPerWorkHour+10+"px";this.descrTask.innerHTML=this.objKeyToStr(this.getTaskOwner());this.descrTask.style.visibility="visible"},hideDescTask:function(){c.style(this.descrTask,"visibility","hidden")},buildResourceInfo:function(a){if(this.childTask&&this.childTask.length>0)for(var b=0;b<this.childTask.length;b++)this.childTask[b].buildResourceInfo(a);
if(c.trim(this.taskItem.taskOwner).length>0)for(var d=this.taskItem.taskOwner.split(";"),b=0;b<d.length;b++){var e=d[b];c.trim(e).length<=0||(a[e]?a[e].push(this):a[e]=[this])}},objKeyToStr:function(a,b){var c="",b=b||" ";if(a)for(var e in a)c+=b+e;return c},getTaskOwner:function(){var a={};if(c.trim(this.taskItem.taskOwner).length>0)for(var b=this.taskItem.taskOwner.split(";"),d=0;d<b.length;d++)a[b[d]]=1;c.forEach(this.childTask,function(b){c.mixin(a,b.getTaskOwner())},this);return a},moveDescTask:function(){this.descrTask.style.left=
parseInt(this.cTaskItem[0].style.left)+this.taskItem.duration*this.ganttChart.pixelsPerWorkHour+10+"px"},getMoveInfo:function(){this.posX=parseInt(this.cTaskItem[0].style.left);var a=parseInt(this.cTaskItem[0].childNodes[0].firstChild.width),b=!this.parentTask?0:parseInt(this.parentTask.cTaskItem[0].style.left),d=!this.predTask?0:parseInt(this.predTask.cTaskItem[0].style.left)+parseInt(this.predTask.cTaskItem[0].childNodes[0].firstChild.width),e=!this.parentTask?0:parseInt(this.parentTask.cTaskItem[0].childNodes[0].firstChild.width),
f=0,g=0,i=0;if(this.childPredTask.length>0){var h=null;c.forEach(this.childPredTask,function(a){if(!h||h&&h>parseInt(a.cTaskItem[0].style.left))h=parseInt(a.cTaskItem[0].style.left)},this);f=h}if(this.childTask.length>0){var j=null;c.forEach(this.childTask,function(a){if(!j||j&&j>parseInt(a.cTaskItem[0].style.left))j=parseInt(a.cTaskItem[0].style.left)},this);i=j;h=null;c.forEach(this.childTask,function(a){if(!h||h&&h<parseInt(a.cTaskItem[0].style.left)+parseInt(a.cTaskItem[0].firstChild.firstChild.width))h=
parseInt(a.cTaskItem[0].style.left)+parseInt(a.cTaskItem[0].firstChild.firstChild.width)},this);g=h}if(this.moveChild){if(b>0&&d==0)this.minPosXMove=b,this.maxPosXMove=b+e;else if(b==0&&d==0)this.minPosXMove=this.ganttChart.initialPos,this.maxPosXMove=-1;else if(b>0&&d>0)this.minPosXMove=d,this.maxPosXMove=b+e;else if(b==0&&d>0)this.minPosXMove=d,this.maxPosXMove=-1;if(this.parentTask&&this.childPredTask.length>0)h=this.getMaxPosPredChildTaskItem(this),b=parseInt(this.parentTask.cTaskItem[0].style.left)+
parseInt(this.parentTask.cTaskItem[0].firstChild.firstChild.width),this.maxPosXMove=this.posX+a+b-h}else{if(this.childPredTask.length>0&&this.maxPosXMove<f)this.maxPosXMove=f;if(this.childTask.length>0){this.childPredTask.length>0&&this.maxPosXMove-a>i&&(this.maxPosXMove-=this.maxPosXMove-a-i);if(!(this.childPredTask.length>0))this.maxPosXMove=i+a;this.minPosXMove=g-a}if(b>0){if(!(this.childPredTask.length>0)&&this.childTask.length>0&&this.maxPosXMove>b+e)this.maxPosXMove=b+e;if(this.minPosXMove<=
b)this.minPosXMove=b;if(!(this.childTask.length>0)&&!(this.childPredTask.length>0))this.maxPosXMove=b+e;else if(!(this.childTask.length>0)&&this.childPredTask.length>0&&b+e>d)this.maxPosXMove=f}if(d>0&&this.minPosXMove<=d)this.minPosXMove=d;if(d==0&&b==0&&this.minPosXMove<=this.ganttChart.initialPos)this.minPosXMove=this.ganttChart.initialPos}},startResize:function(a){this.mouseX=a.screenX;this.getResizeInfo();this.hideDescTask();this.checkResize=!0;this.taskItemWidth=parseInt(this.cTaskItem[0].firstChild.firstChild.width)},
getResizeInfo:function(){var a=this.cTaskItem[0],b=!this.parentTask?0:parseInt(this.parentTask.cTaskItem[0].style.left),d=!this.parentTask?0:parseInt(this.parentTask.cTaskItem[0].childNodes[0].firstChild.width),a=parseInt(a.style.left),e=0,f=0;if(this.childPredTask.length>0){var g=null;c.forEach(this.childPredTask,function(a){if(!g||g&&g>parseInt(a.cTaskItem[0].style.left))g=parseInt(a.cTaskItem[0].style.left)},this);e=g}this.childTask.length>0&&(g=null,c.forEach(this.childTask,function(a){if(!g||
g&&g<parseInt(a.cTaskItem[0].style.left)+parseInt(a.cTaskItem[0].firstChild.firstChild.width))g=parseInt(a.cTaskItem[0].style.left)+parseInt(a.cTaskItem[0].firstChild.firstChild.width)},this),f=g);this.minWidthResize=this.ganttChart.pixelsPerDay;if(this.childTask.length>0)this.minWidthResize=f-a;if(this.childPredTask.length>0&&!this.parentTask)this.maxWidthResize=e-a;else if(this.childPredTask.length>0&&this.parentTask)this.maxWidthResize=Math.min(b+d-a,e-a);else if(this.childPredTask.length==0&&
this.parentTask)this.maxWidthResize=b+d-a},createTaskItem:function(){this.posX=this.ganttChart.getPosOnDate(this.taskItem.startTime);var a=c.create("div",{id:this.taskItem.id,className:"ganttTaskItemControl"});c.style(a,{left:this.posX+"px",top:this.posY+"px"});var b=c.create("div",{className:"ganttTaskDivTaskItem"},a),b=c.create("table",{cellPadding:"0",cellSpacing:"0",width:this.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px",className:"ganttTaskTblTaskItem"},b),b=b.insertRow(b.rows.length);
if(this.taskItem.percentage!=0){var d=c.create("td",{height:this.ganttChart.heightTaskItem+"px",width:this.taskItem.percentage+"%"},b);d.style.lineHeight="1px";d=c.create("div",{className:"ganttImageTaskProgressFilled"},d);c.style(d,{width:this.taskItem.percentage*this.taskItem.duration*this.ganttChart.pixelsPerWorkHour/100+"px",height:this.ganttChart.heightTaskItem+"px"})}if(this.taskItem.percentage!=100)d=c.create("td",{height:this.ganttChart.heightTaskItem+"px",width:100-this.taskItem.percentage+
"%"},b),d.style.lineHeight="1px",b=c.create("div",{className:"ganttImageTaskProgressBg"},d),c.style(b,{width:(100-this.taskItem.percentage)*this.taskItem.duration*this.ganttChart.pixelsPerWorkHour/100+"px",height:this.ganttChart.heightTaskItem+"px"});this.ganttChart.isContentEditable&&(b=c.create("div",{className:"ganttTaskDivTaskInfo"},a),b=c.create("table",{cellPadding:"0",cellSpacing:"0",height:this.ganttChart.heightTaskItem+"px",width:this.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px"},
b).insertRow(0),c.create("td",{align:"center",vAlign:"top",height:this.ganttChart.heightTaskItem+"px",className:"ganttMoveInfo"},b),d=c.create("div",{className:"ganttTaskDivTaskName"},a),b=c.create("div",{},d),c.create("input",{className:"ganttTaskDivMoveInput",type:"text"},b),c.isIE&&c.style(b,{background:"#000000",filter:"alpha(opacity=0)"}),c.style(b,{height:this.ganttChart.heightTaskItem+"px",width:this.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px"}),d=c.create("div",{className:"ganttTaskDivResize"},
d),c.create("input",{className:"ganttTaskDivResizeInput",type:"text"},d),c.style(d,{left:this.taskItem.duration*this.ganttChart.pixelsPerWorkHour-10+"px",height:this.ganttChart.heightTaskItem+"px",width:"10px"}),this.ganttChart._events.push(c.connect(b,"onmousedown",this,function(a){this.moveMoveConn=c.connect(document,"onmousemove",this,function(a){this.checkMove&&this.moveItem(a)});this.moveUpConn=c.connect(document,"onmouseup",this,function(){if(this.checkMove)this.endMove(),this.ganttChart.isMoving=
!1,document.body.releaseCapture&&document.body.releaseCapture(),c.disconnect(this.moveMoveConn),c.disconnect(this.moveUpConn)});this.startMove(a);this.ganttChart.isMoving=!0;document.body.setCapture&&document.body.setCapture(!1)})),this.ganttChart._events.push(c.connect(b,"onmouseover",this,function(a){a.target&&(a.target.style.cursor="move")})),this.ganttChart._events.push(c.connect(b,"onmouseout",this,function(a){a.target.style.cursor=""})),this.ganttChart._events.push(c.connect(d,"onmousedown",
this,function(a){this.resizeMoveConn=c.connect(document,"onmousemove",this,function(a){this.checkResize&&this.resizeItem(a)});this.resizeUpConn=c.connect(document,"onmouseup",this,function(){if(this.checkResize)this.endResizeItem(),this.ganttChart.isResizing=!1,document.body.releaseCapture&&document.body.releaseCapture(),c.disconnect(this.resizeMoveConn),c.disconnect(this.resizeUpConn)});this.startResize(a);this.ganttChart.isResizing=!0;document.body.setCapture&&document.body.setCapture(!1)})),this.ganttChart._events.push(c.connect(d,
"onmouseover",this,function(a){!this.ganttChart.isMoving&&!this.ganttChart.isResizing&&a.target&&(a.target.style.cursor="e-resize")})),this.ganttChart._events.push(c.connect(d,"onmouseout",this,function(a){!this.checkResize&&a.target&&(a.target.style.cursor="")})));return a},createTaskNameItem:function(){var a=c.create("div",{id:this.taskItem.id,className:"ganttTaskTaskNameItem",title:this.taskItem.name+", id: "+this.taskItem.id+" ",innerHTML:this.taskItem.name});c.style(a,"top",this.posY+"px");c.attr(a,
"tabIndex",0);this.ganttChart.isShowConMenu&&(this.ganttChart._events.push(c.connect(a,"onmouseover",this,function(b){c.addClass(a,"ganttTaskTaskNameItemHover");clearTimeout(this.ganttChart.menuTimer);this.ganttChart.tabMenu.clear();this.ganttChart.tabMenu.show(b.target,this)})),this.ganttChart._events.push(c.connect(a,"onkeydown",this,function(a){a.keyCode==c.keys.ENTER&&(this.ganttChart.tabMenu.clear(),this.ganttChart.tabMenu.show(a.target,this));this.ganttChart.tabMenu.isShow&&(a.keyCode==c.keys.LEFT_ARROW||
a.keyCode==c.keys.RIGHT_ARROW)&&l.focus(this.ganttChart.tabMenu.menuPanel.firstChild.rows[0].cells[0]);this.ganttChart.tabMenu.isShow&&a.keyCode==c.keys.ESCAPE&&this.ganttChart.tabMenu.hide()})),this.ganttChart._events.push(c.connect(a,"onmouseout",this,function(){c.removeClass(a,"ganttTaskTaskNameItemHover");clearTimeout(this.ganttChart.menuTimer);this.ganttChart.menuTimer=setTimeout(c.hitch(this,function(){this.ganttChart.tabMenu.hide()}),200)})),this.ganttChart._events.push(c.connect(this.ganttChart.tabMenu.menuPanel,
"onmouseover",this,function(){clearTimeout(this.ganttChart.menuTimer)})),this.ganttChart._events.push(c.connect(this.ganttChart.tabMenu.menuPanel,"onkeydown",this,function(a){this.ganttChart.tabMenu.isShow&&a.keyCode==c.keys.ESCAPE&&this.ganttChart.tabMenu.hide()})),this.ganttChart._events.push(c.connect(this.ganttChart.tabMenu.menuPanel,"onmouseout",this,function(){clearTimeout(this.ganttChart.menuTimer);this.ganttChart.menuTimer=setTimeout(c.hitch(this,function(){this.ganttChart.tabMenu.hide()}),
200)})));return a},createTaskDescItem:function(){var a=this.posX+this.taskItem.duration*this.ganttChart.pixelsPerWorkHour+10,b=c.create("div",{innerHTML:this.objKeyToStr(this.getTaskOwner()),className:"ganttTaskDescTask"});c.style(b,{left:a+"px",top:this.posY+"px"});return this.descrTask=b},checkWidthTaskNameItem:function(){if(this.cTaskNameItem[0].offsetWidth+this.cTaskNameItem[0].offsetLeft>this.ganttChart.maxWidthTaskNames){var a=this.taskItem.name.substring(0,this.cTaskNameItem[0].firstChild.length-
Math.round((this.cTaskNameItem[0].offsetWidth+this.cTaskNameItem[0].offsetLeft-this.ganttChart.maxWidthTaskNames)/(this.cTaskNameItem[0].offsetWidth/this.cTaskNameItem[0].firstChild.length))-3);a+="...";this.cTaskNameItem[0].innerHTML=a}},refreshTaskItem:function(a){this.posX=this.ganttChart.getPosOnDate(this.taskItem.startTime);c.style(a,{left:this.posX+"px"});var b=a.childNodes[0].firstChild;b.width=(!this.taskItem.duration?1:this.taskItem.duration*this.ganttChart.pixelsPerWorkHour)+"px";b=b.rows[0];
if(this.taskItem.percentage!=0){var d=b.firstChild;d.height=this.ganttChart.heightTaskItem+"px";d.width=this.taskItem.percentage+"%";d.style.lineHeight="1px";c.style(d.firstChild,{width:(!this.taskItem.duration?1:this.taskItem.percentage*this.taskItem.duration*this.ganttChart.pixelsPerWorkHour/100)+"px",height:this.ganttChart.heightTaskItem+"px"})}if(this.taskItem.percentage!=100)d=b.lastChild,d.height=this.ganttChart.heightTaskItem+"px",d.width=100-this.taskItem.percentage+"%",d.style.lineHeight=
"1px",c.style(d.firstChild,{width:(!this.taskItem.duration?1:(100-this.taskItem.percentage)*this.taskItem.duration*this.ganttChart.pixelsPerWorkHour/100)+"px",height:this.ganttChart.heightTaskItem+"px"});if(this.ganttChart.isContentEditable)b=a.childNodes[1].firstChild,b.height=this.ganttChart.heightTaskItem+"px",b.width=(!this.taskItem.duration?1:this.taskItem.duration*this.ganttChart.pixelsPerWorkHour)+"px",b.rows[0].firstChild.height=this.ganttChart.heightTaskItem+"px",b=a.childNodes[2],d=b.firstChild,
d.style.height=this.ganttChart.heightTaskItem+"px",d.style.width=(!this.taskItem.duration?1:this.taskItem.duration*this.ganttChart.pixelsPerWorkHour)+"px",b=b.lastChild,c.style(b,{left:this.taskItem.duration*this.ganttChart.pixelsPerWorkHour-10+"px"}),b.style.height=this.ganttChart.heightTaskItem+"px",b.style.width="10px";return a},refreshTaskDesc:function(a){c.style(a,{left:this.posX+this.taskItem.duration*this.ganttChart.pixelsPerWorkHour+10+"px"});return a},refreshConnectingLinesDS:function(a){var b=
a[1],d=a[0],e=a[2],f=c.style(this.predTask.cTaskItem[0],"left"),g=c.style(this.predTask.cTaskItem[0],"top"),i=c.style(this.cTaskItem[0],"left"),h=this.posY+2;parseInt(this.predTask.cTaskItem[0].firstChild.firstChild.width);var j=parseInt(this.predTask.cTaskItem[0].firstChild.firstChild.width);g<h?c.style(d,{height:h-this.ganttChart.heightTaskItem/2-g-3+"px",left:f+j-20+"px"}):c.style(d,{height:g+2-h+"px",left:f+j-20+"px"});c.style(e,{width:15+(i-(j+f))+"px",left:f+j-20+"px"});c.style(b,{left:i-7+
"px"});return a},postLoadData:function(){},refresh:function(){this.childTask&&this.childTask.length>0&&c.forEach(this.childTask,function(a){a.refresh()},this);this.refreshTaskItem(this.cTaskItem[0]);this.refreshTaskDesc(this.cTaskItem[0].nextSibling);this.taskItem.previousTask&&this.predTask&&this.refreshConnectingLinesDS(this.cTaskItem[1]);return this},create:function(){var a=this.ganttChart.contentData.firstChild,b=this.taskItem.previousTask,d=this.taskItem.parentTask,e=this.taskItem.cldTasks.length>
0?!0:!1;this.cTaskItem=[];this.cTaskNameItem=[];if(!d)if(this.taskItem.previousParentTask){this.previousParentTask=this.project.getTaskById(this.taskItem.previousParentTask.id);var f=this.ganttChart.getLastChildTask(this.previousParentTask);this.posY=parseInt(f.cTaskItem[0].style.top)+this.ganttChart.heightTaskItem+this.ganttChart.heightTaskItemExtra;this.previousParentTask.nextParentTask=this}else this.posY=parseInt(this.project.projectItem[0].style.top)+this.ganttChart.heightTaskItem+this.ganttChart.heightTaskItemExtra;
if(d){var g=this.project.getTaskById(this.taskItem.parentTask.id);this.parentTask=g;this.taskItem.previousChildTask?(this.previousChildTask=this.project.getTaskById(this.taskItem.previousChildTask.id),f=this.ganttChart.getLastChildTask(this.previousChildTask),this.posY=c.style(f.cTaskItem[0],"top")+this.ganttChart.heightTaskItem+this.ganttChart.heightTaskItemExtra,this.previousChildTask.nextChildTask=this):this.posY=c.style(g.cTaskItem[0],"top")+this.ganttChart.heightTaskItem+this.ganttChart.heightTaskItemExtra;
g.childTask.push(this)}if(b)this.predTask=g=this.project.getTaskById(b.id),g.childPredTask.push(this);this.cTaskItem.push(this.createTaskItem());a.appendChild(this.cTaskItem[0]);this.ganttChart.panelNames&&(this.cTaskNameItem.push(this.createTaskNameItem()),this.ganttChart.panelNames.firstChild.appendChild(this.cTaskNameItem[0]));a.appendChild(this.createTaskDescItem());a=[];b&&(a=this.createConnectingLinesDS());this.cTaskItem.push(a);if(this.ganttChart.panelNames){b=[];if(d)this.cTaskNameItem[0].style.left=
c.style(this.parentTask.cTaskNameItem[0],"left")+15+"px",b=this.createConnectingLinesPN();this.checkWidthTaskNameItem();this.checkPosition();d=null;e&&(d=this.createTreeImg());this.cTaskNameItem.push(b);this.cTaskNameItem.push(d)}this.adjustPanelTime();return this},checkPosition:function(){if(this.ganttChart.withTaskId){var a=c.coords(this.cTaskNameItem[0],!0);this.taskIdentifier?this.childTask&&this.childTask.length>0&&c.forEach(this.childTask,function(a){a.checkPosition()},this):this.taskIdentifier=
c.create("div",{id:"TaskId_"+this.taskItem.id,className:"ganttTaskIdentifier",title:this.taskItem.id,innerHTML:this.taskItem.id},this.cTaskNameItem[0].parentNode);c.style(this.taskIdentifier,{left:a.l+a.w+4+"px",top:a.t-1+"px"})}},createTreeImg:function(){var a=c.create("div",{id:this.taskItem.id,className:"ganttImageTreeCollapse"});c.attr(a,"tabIndex",0);c.forEach(["onclick","onkeydown"],function(b){this.ganttChart._events.push(c.connect(a,b,this,function(d){if(!(b=="onkeydown"&&d.keyCode!=c.keys.ENTER))this.isExpanded?
(c.removeClass(a,"ganttImageTreeCollapse"),c.addClass(a,"ganttImageTreeExpand"),this.isExpanded=!1,this.hideChildTasks(this),this.shiftCurrentTasks(this,-this.hideTasksHeight)):(c.removeClass(a,"ganttImageTreeExpand"),c.addClass(a,"ganttImageTreeCollapse"),this.isExpanded=!0,this.shiftCurrentTasks(this,this.hideTasksHeight),this.showChildTasks(this,!0),this.hideTasksHeight=0),this.ganttChart.checkPosition()}))},this);this.ganttChart.panelNames.firstChild.appendChild(a);c.addClass(a,"ganttTaskTreeImage");
c.style(a,{left:c.style(this.cTaskNameItem[0],"left")-12+"px",top:c.style(this.cTaskNameItem[0],"top")+3+"px"});return a},setPreviousTask:function(a){if(a=="")this.clearPredTask();else{var b=this.taskItem;if(b.id==a)return!1;var c=this.project.getTaskById(a);if(!c)return!1;var e=c.taskItem,f=e.parentTask==null,g=b.parentTask==null;if(f&&!g||!f&&g||!f&&!g&&e.parentTask.id!=b.parentTask.id)return!1;f=b.startTime.getTime();if(e.startTime.getTime()+e.duration*864E5/c.ganttChart.hsPerDay>f)return!1;this.clearPredTask();
this.ganttChart.checkPosPreviousTask(e,b)||this.ganttChart.correctPosPreviousTask(e,b,this);b.previousTaskId=a;b.previousTask=e;this.predTask=c;c.childPredTask.push(this);this.cTaskItem[1]=this.createConnectingLinesDS()}return!0},clearPredTask:function(){if(this.predTask){for(var a=this.predTask.childPredTask,b=0;b<a.length;b++)if(a[b]==this){a.splice(b,1);break}for(b=0;b<this.cTaskItem[1].length;b++)this.cTaskItem[1][b].parentNode.removeChild(this.cTaskItem[1][b]);this.cTaskItem[1]=[];this.taskItem.previousTaskId=
null;this.predTask=this.taskItem.previousTask=null}},setStartTime:function(a,b){this.moveChild=b;this.getMoveInfo();var c=this.ganttChart.getPosOnDate(a);if(parseInt(this.cTaskItem[0].firstChild.firstChild.width)+c>this.maxPosXMove&&this.maxPosXMove!=-1)return this.minPosXMove=this.maxPosXMove=-1,!1;if(c<this.minPosXMove)return this.minPosXMove=this.maxPosXMove=-1,!1;this.cTaskItem[0].style.left=c;this.moveCurrentTaskItem(c-this.posX,b);this.project.shiftProjectItem();this.descrTask.innerHTML=this.objKeyToStr(this.getTaskOwner());
this.adjustPanelTime();this.posX=0;this.minPosXMove=this.maxPosXMove=-1;return!0},setDuration:function(a){this.getResizeInfo();a=this.ganttChart.getWidthOnDuration(a);return a>this.maxWidthResize&&this.maxWidthResize!=-1?!1:a<this.minWidthResize?!1:(this.taskItemWidth=parseInt(this.cTaskItem[0].firstChild.firstChild.width),this.resizeTaskItem(a),this.endResizeItem(),this.descrTask.innerHTML=this.objKeyToStr(this.getTaskOwner()),!0)},setTaskOwner:function(a){this.taskItem.taskOwner=a==null||a==void 0?
"":a;this.descrTask.innerHTML=this.objKeyToStr(this.getTaskOwner());return!0},setPercentCompleted:function(a){a=parseInt(a);if(isNaN(a)||a>100||a<0)return!1;var b=this.cTaskItem[0].childNodes[0].firstChild.rows[0],d=b.cells[0],e=b.cells[1];if(a!=0&&a!=100)if(this.taskItem.percentage!=0&&this.taskItem.percentage!=100)d.width=a+"%",e.width=100-a+"%";else{if(this.taskItem.percentage==0||this.taskItem.percentage==100)d.parentNode.removeChild(d),d=c.create("td",{height:this.ganttChart.heightTaskItem+"px",
width:a+"%"},b),d.style.lineHeight="1px",d=c.create("div",{className:"ganttImageTaskProgressFilled"},d),c.style(d,{width:a*this.taskItem.duration*this.ganttChart.pixelsPerWorkHour/100+"px",height:this.ganttChart.heightTaskItem+"px"}),d=c.create("td",{height:this.ganttChart.heightTaskItem+"px",width:100-a+"%"},b),d.style.lineHeight="1px",d=c.create("div",{className:"ganttImageTaskProgressBg"},d),c.style(d,{width:(100-a)*this.taskItem.duration*this.ganttChart.pixelsPerWorkHour/100+"px",height:this.ganttChart.heightTaskItem+
"px"})}else if(a==0)this.taskItem.percentage!=0&&this.taskItem.percentage!=100?(d.parentNode.removeChild(d),e.width="100%"):(c.removeClass(d.firstChild,"ganttImageTaskProgressFilled"),c.addClass(d.firstChild,"ganttImageTaskProgressBg"));else if(a==100)this.taskItem.percentage!=0&&this.taskItem.percentage!=100?(e.parentNode.removeChild(e),d.width="100%"):(c.removeClass(d.firstChild,"ganttImageTaskProgressBg"),c.addClass(d.firstChild,"ganttImageTaskProgressFilled"));this.taskItem.percentage=a;this.taskItemWidth=
parseInt(this.cTaskItem[0].firstChild.firstChild.width);this.resizeTaskItem(this.taskItemWidth);this.endResizeItem();this.descrTask.innerHTML=this.objKeyToStr(this.getTaskOwner());return!0},setName:function(a){if(a)this.taskItem.name=a,this.cTaskNameItem[0].innerHTML=a,this.cTaskNameItem[0].title=a,this.checkWidthTaskNameItem(),this.checkPosition(),this.descrTask.innerHTML=this.objKeyToStr(this.getTaskOwner()),this.adjustPanelTime()}});c.declare("dojox.gantt.GanttTaskItem",null,{constructor:function(a){this.id=
a.id;this.name=a.name||this.id;this.startTime=a.startTime||new Date;this.duration=a.duration||8;this.percentage=a.percentage||0;this.previousTaskId=a.previousTaskId||"";this.taskOwner=a.taskOwner||"";this.cldTasks=[];this.cldPreTasks=[];this.previousParentTask=this.nextParentTask=this.previousChildTask=this.nextChildTask=this.project=this.previousTask=this.parentTask=null},addChildTask:function(a){this.cldTasks.push(a);a.parentTask=this},setProject:function(a){this.project=a;for(var b=0;b<this.cldTasks.length;b++)this.cldTasks[b].setProject(a)}})});