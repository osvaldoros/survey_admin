//>>built
define("dojox/editor/plugins/FindReplace",["dojo","dijit","dojox","dijit/_base/manager","dijit/_base/popup","dijit/_Widget","dijit/_TemplatedMixin","dijit/_KeyNavContainer","dijit/_WidgetsInTemplateMixin","dijit/TooltipDialog","dijit/Toolbar","dijit/form/CheckBox","dijit/form/_TextBoxMixin","dijit/form/TextBox","dijit/_editor/_Plugin","dijit/form/Button","dijit/form/DropDownButton","dijit/form/ToggleButton","dojox/editor/plugins/ToolbarLineBreak","dojo/_base/connect","dojo/_base/declare","dojo/i18n",
"dojo/string","dojo/i18n!dojox/editor/plugins/nls/FindReplace"],function(c,b,e){c.experimental("dojox.editor.plugins.FindReplace");c.declare("dojox.editor.plugins._FindReplaceCloseBox",[b._Widget,b._TemplatedMixin,b._WidgetsInTemplateMixin],{btnId:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='float: right' class='dijitInline' tabindex='-1'><button class='dijit dijitReset dijitInline' id='${btnId}' dojoAttachPoint='button' dojoType='dijit.form.Button' tabindex='-1' iconClass='dijitEditorIconsFindReplaceClose' showLabel='false'>X</button></span>",
postMixInProperties:function(){this.id=b.getUniqueId(this.declaredClass.replace(/\./g,"_"));this.btnId=this.id+"_close";this.inherited(arguments)},startup:function(){this.connect(this.button,"onClick","onClick")},onClick:function(){}});c.declare("dojox.editor.plugins._FindReplaceTextBox",[b._Widget,b._TemplatedMixin,b._WidgetsInTemplateMixin],{textId:"",label:"",toolTip:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='white-space: nowrap' class='dijit dijitReset dijitInline dijitEditorFindReplaceTextBox' title='${tooltip}' tabindex='-1'><label class='dijitLeft dijitInline' for='${textId}' tabindex='-1'>${label}</label><input dojoType='dijit.form.TextBox' intermediateChanges='true' class='focusTextBox' tabIndex='0' id='${textId}' dojoAttachPoint='textBox, focusNode' value='' dojoAttachEvent='onKeyPress: _onKeyPress'/></span>",
postMixInProperties:function(){this.id=b.getUniqueId(this.declaredClass.replace(/\./g,"_"));this.textId=this.id+"_text";this.inherited(arguments)},postCreate:function(){this.textBox.set("value","");this.disabled=this.textBox.get("disabled");this.connect(this.textBox,"onChange","onChange");c.attr(this.textBox.textbox,"formnovalidate","true")},_setValueAttr:function(a){this.value=a;this.textBox.set("value",a)},focus:function(){this.textBox.focus()},_setDisabledAttr:function(a){this.disabled=a;this.textBox.set("disabled",
a)},onChange:function(a){this.value=a},_onKeyPress:function(a){var d=0,f=0;if(a.target&&!a.ctrlKey&&!a.altKey&&!a.shiftKey)if(a.keyCode==c.keys.LEFT_ARROW)d=a.target.selectionStart,f=a.target.selectionEnd,d<f&&(b.selectInputText(a.target,d,d),c.stopEvent(a));else if(a.keyCode==c.keys.RIGHT_ARROW)d=a.target.selectionStart,f=a.target.selectionEnd,d<f&&(b.selectInputText(a.target,f,f),c.stopEvent(a))}});c.declare("dojox.editor.plugins._FindReplaceCheckBox",[b._Widget,b._TemplatedMixin,b._WidgetsInTemplateMixin],
{checkId:"",label:"",tooltip:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='white-space: nowrap' tabindex='-1' class='dijit dijitReset dijitInline dijitEditorFindReplaceCheckBox' title='${tooltip}' ><input dojoType='dijit.form.CheckBox' tabIndex='0' id='${checkId}' dojoAttachPoint='checkBox, focusNode' value=''/><label tabindex='-1' class='dijitLeft dijitInline' for='${checkId}'>${label}</label></span>",postMixInProperties:function(){this.id=b.getUniqueId(this.declaredClass.replace(/\./g,
"_"));this.checkId=this.id+"_check";this.inherited(arguments)},postCreate:function(){this.checkBox.set("checked",!1);this.disabled=this.checkBox.get("disabled");this.checkBox.isFocusable=function(){return!1}},_setValueAttr:function(a){this.checkBox.set("value",a)},_getValueAttr:function(){return this.checkBox.get("value")},focus:function(){this.checkBox.focus()},_setDisabledAttr:function(a){this.disabled=a;this.checkBox.set("disabled",a)}});c.declare("dojox.editor.plugins._FindReplaceToolbar",b.Toolbar,
{postCreate:function(){this.connectKeyNavHandlers([],[]);this.connect(this.containerNode,"onclick","_onToolbarEvent");this.connect(this.containerNode,"onkeydown","_onToolbarEvent");c.addClass(this.domNode,"dijitToolbar")},addChild:function(){b._KeyNavContainer.superclass.addChild.apply(this,arguments)},_onToolbarEvent:function(a){a.stopPropagation()}});c.declare("dojox.editor.plugins.FindReplace",[b._editor._Plugin],{buttonClass:b.form.ToggleButton,iconClassPrefix:"dijitEditorIconsFindReplace",editor:null,
button:null,_frToolbar:null,_closeBox:null,_findField:null,_replaceField:null,_findButton:null,_replaceButton:null,_replaceAllButton:null,_caseSensitive:null,_backwards:null,_promDialog:null,_promDialogTimeout:null,_strings:null,_initButton:function(){this._strings=c.i18n.getLocalization("dojox.editor.plugins","FindReplace");this.button=new b.form.ToggleButton({label:this._strings.findReplace,showLabel:!1,iconClass:this.iconClassPrefix+" dijitEditorIconFindString",tabIndex:"-1",onChange:c.hitch(this,
"_toggleFindReplace")});c.isOpera&&this.button.set("disabled",!0);this.connect(this.button,"set",c.hitch(this,function(a,d){a==="disabled"&&this._toggleFindReplace(!d&&this._displayed,!0,!0)}))},setEditor:function(a){this.editor=a;this._initButton()},toggle:function(){this.button.set("checked",!this.button.get("checked"))},_toggleFindReplace:function(a,d,b){var h=c.marginBox(this.editor.domNode);if(a&&!c.isOpera){if(c.style(this._frToolbar.domNode,"display","block"),this._populateFindField(),!d)this._displayed=
!0}else{c.style(this._frToolbar.domNode,"display","none");if(!d)this._displayed=!1;b||this.editor.focus()}this.editor.resize({h:h.h})},_populateFindField:function(){var a=c.withGlobal(this.editor.window,"getSelectedText",b._editor.selection,[null]);this._findField&&this._findField.textBox&&(a&&this._findField.textBox.set("value",a),this._findField.textBox.focus(),b.selectInputText(this._findField.textBox.focusNode))},setToolbar:function(a){this.inherited(arguments);if(!c.isOpera){var d=this._frToolbar=
new e.editor.plugins._FindReplaceToolbar;c.style(d.domNode,"display","none");c.place(d.domNode,a.domNode,"after");d.startup();this._closeBox=new e.editor.plugins._FindReplaceCloseBox;d.addChild(this._closeBox);this._findField=new e.editor.plugins._FindReplaceTextBox({label:this._strings.findLabel,tooltip:this._strings.findTooltip});d.addChild(this._findField);this._replaceField=new e.editor.plugins._FindReplaceTextBox({label:this._strings.replaceLabel,tooltip:this._strings.replaceTooltip});d.addChild(this._replaceField);
d.addChild(new e.editor.plugins.ToolbarLineBreak);this._findButton=new b.form.Button({label:this._strings.findButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconFind"});this._findButton.titleNode.title=this._strings.findButtonTooltip;d.addChild(this._findButton);this._replaceButton=new b.form.Button({label:this._strings.replaceButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconReplace"});this._replaceButton.titleNode.title=this._strings.replaceButtonTooltip;d.addChild(this._replaceButton);
this._replaceAllButton=new b.form.Button({label:this._strings.replaceAllButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconReplaceAll"});this._replaceAllButton.titleNode.title=this._strings.replaceAllButtonTooltip;d.addChild(this._replaceAllButton);this._caseSensitive=new e.editor.plugins._FindReplaceCheckBox({label:this._strings.matchCase,tooltip:this._strings.matchCaseTooltip});d.addChild(this._caseSensitive);this._backwards=new e.editor.plugins._FindReplaceCheckBox({label:this._strings.backwards,
tooltip:this._strings.backwardsTooltip});d.addChild(this._backwards);this._findButton.set("disabled",!0);this._replaceButton.set("disabled",!0);this._replaceAllButton.set("disabled",!0);this.connect(this._findField,"onChange","_checkButtons");this.connect(this._findField,"onKeyDown","_onFindKeyDown");this.connect(this._replaceField,"onKeyDown","_onReplaceKeyDown");this.connect(this._findButton,"onClick","_find");this.connect(this._replaceButton,"onClick","_replace");this.connect(this._replaceAllButton,
"onClick","_replaceAll");this.connect(this._closeBox,"onClick","toggle");this._promDialog=new b.TooltipDialog;this._promDialog.startup();this._promDialog.set("content","")}},_checkButtons:function(){this._findField.get("value")?(this._findButton.set("disabled",!1),this._replaceButton.set("disabled",!1),this._replaceAllButton.set("disabled",!1)):(this._findButton.set("disabled",!0),this._replaceButton.set("disabled",!0),this._replaceAllButton.set("disabled",!0))},_onFindKeyDown:function(a){a.keyCode==
c.keys.ENTER&&(this._find(),c.stopEvent(a))},_onReplaceKeyDown:function(a){a.keyCode==c.keys.ENTER&&(this._replace()||this._replace(),c.stopEvent(a))},_find:function(a){var d=this._findField.get("value")||"";if(d){var f=this._caseSensitive.get("value"),h=this._backwards.get("value"),d=this._findText(d,f,h);if(!d&&a)this._promDialog.set("content",c.string.substitute(this._strings.eofDialogText,{0:this._strings.eofDialogTextFind})),b.popup.open({popup:this._promDialog,around:this._findButton.domNode}),
this._promDialogTimeout=setTimeout(c.hitch(this,function(){clearTimeout(this._promDialogTimeout);this._promDialogTimeout=null;b.popup.close(this._promDialog)}),3E3),setTimeout(c.hitch(this,function(){this.editor.focus()}),0);return d}return!1},_replace:function(a){var d=!1,f=this.editor;f.focus();var h=this._findField.get("value")||"",g=this._replaceField.get("value")||"";if(h){var e=this._caseSensitive.get("value"),j=this._backwards.get("value"),i=c.withGlobal(f.window,"getSelectedText",b._editor.selection,
[null]);c.isMoz&&(h=c.trim(h),i=c.trim(i));h=this._filterRegexp(h,!e);i&&h.test(i)&&(f.execCommand("inserthtml",g),d=!0,j&&(this._findText(g,e,j),c.withGlobal(f.window,"collapse",b._editor.selection,[!0])));if(!this._find(!1)&&a)this._promDialog.set("content",c.string.substitute(this._strings.eofDialogText,{0:this._strings.eofDialogTextReplace})),b.popup.open({popup:this._promDialog,around:this._replaceButton.domNode}),this._promDialogTimeout=setTimeout(c.hitch(this,function(){clearTimeout(this._promDialogTimeout);
this._promDialogTimeout=null;b.popup.close(this._promDialog)}),3E3),setTimeout(c.hitch(this,function(){this.editor.focus()}),0);return d}return null},_replaceAll:function(a){var d=0;this._backwards.get("value")?this.editor.placeCursorAtEnd():this.editor.placeCursorAtStart();this._replace(!1)&&d++;var f=c.hitch(this,function(){if(this._replace(!1))d++,setTimeout(f,10);else if(a)this._promDialog.set("content",c.string.substitute(this._strings.replaceDialogText,{0:""+d})),b.popup.open({popup:this._promDialog,
around:this._replaceAllButton.domNode}),this._promDialogTimeout=setTimeout(c.hitch(this,function(){clearTimeout(this._promDialogTimeout);this._promDialogTimeout=null;b.popup.close(this._promDialog)}),3E3),setTimeout(c.hitch(this,function(){this._findField.focus();this._findField.textBox.focusNode.select()}),0)});f()},_findText:function(a,d,c){var b=this.editor,g=b.window,e=!1;if(a)g.find?e=g.find(a,d,c,!1,!1,!1,!1):(g=b.document,g.selection&&(this.editor.focus(),b=g.body.createTextRange(),(e=g.selection?
g.selection.createRange():null)&&(c?b.setEndPoint("EndToStart",e):b.setEndPoint("StartToEnd",e)),d=d?4:0,c&&(d|=1),(e=b.findText(a,b.text.length,d))&&b.select()));return e},_filterRegexp:function(a,c){for(var b="",e=null,g=0;g<a.length;g++)switch(e=a.charAt(g),e){case "\\":b+=e;g++;b+=a.charAt(g);break;case "$":case "^":case "/":case "+":case ".":case "|":case "(":case ")":case "{":case "}":case "[":case "]":b+="\\";default:b+=e}b="^"+b+"$";return c?RegExp(b,"mi"):RegExp(b,"m")},updateState:function(){this.button.set("disabled",
this.get("disabled"))},destroy:function(){this.inherited(arguments);if(this._promDialogTimeout)clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,b.popup.close(this._promDialog);if(this._frToolbar)this._frToolbar.destroyRecursive(),this._frToolbar=null;if(this._promDialog)this._promDialog.destroyRecursive(),this._promDialog=null}});c.subscribe(b._scopeName+".Editor.getPlugin",null,function(a){if(!a.plugin&&a.args.name.toLowerCase()==="findreplace")a.plugin=new e.editor.plugins.FindReplace({})});
return e.editor.plugins.FindReplace});