//>>built
define(["dijit","dojo","dojox","dojo/i18n!dojox/editor/plugins/nls/SpellCheck","dojo/require!dijit/_base/popup,dijit/_Widget,dijit/_Templated,dijit/form/TextBox,dijit/form/DropDownButton,dijit/TooltipDialog,dijit/form/MultiSelect,dojo/io/script,dijit/Menu"],function(j,c,m){c.provide("dojox.editor.plugins.SpellCheck");c.require("dijit._base.popup");c.require("dijit._Widget");c.require("dijit._Templated");c.require("dijit.form.TextBox");c.require("dijit.form.DropDownButton");c.require("dijit.TooltipDialog");
c.require("dijit.form.MultiSelect");c.require("dojo.io.script");c.require("dijit.Menu");c.requireLocalization("dojox.editor.plugins","SpellCheck");c.experimental("dojox.editor.plugins.SpellCheck");c.declare("dojox.editor.plugins._spellCheckControl",[j._Widget,j._Templated],{widgetsInTemplate:!0,templateString:"<table class='dijitEditorSpellCheckTable'><tr><td colspan='3' class='alignBottom'><label for='${textId}' id='${textId}_label'>${unfound}</label><div class='dijitEditorSpellCheckBusyIcon' id='${id}_progressIcon'></div></td></tr><tr><td class='dijitEditorSpellCheckBox'><input dojoType='dijit.form.TextBox' required='false' intermediateChanges='true' class='dijitEditorSpellCheckBox' dojoAttachPoint='unfoundTextBox' id='${textId}'/></td><td><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='skipButton'>${skip}</button></td><td><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='skipAllButton'>${skipAll}</button></td></tr><tr><td class='alignBottom'><label for='${selectId}'>${suggestions}</td></label><td colspan='2'><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='toDicButton'>${toDic}</button></td></tr><tr><td><select dojoType='dijit.form.MultiSelect' id='${selectId}' class='dijitEditorSpellCheckBox listHeight' dojoAttachPoint='suggestionSelect'></select></td><td colspan='2'><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='replaceButton'>${replace}</button><div class='topMargin'><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='replaceAllButton'>${replaceAll}</button><div></td></tr><tr><td><div class='topMargin'><button dojoType='dijit.form.Button' dojoAttachPoint='cancelButton'>${cancel}</button></div></td><td></td><td></td></tr></table>",
constructor:function(){this.isOpen=this.isChanged=this.ignoreChange=!1;this.closable=!0},postMixInProperties:function(){this.id=j.getUniqueId(this.declaredClass.replace(/\./g,"_"));this.textId=this.id+"_textBox";this.selectId=this.id+"_select"},postCreate:function(){var a=this.suggestionSelect;c.removeAttr(a.domNode,"multiple");a.addItems=function(a){var d=this,e=null;a&&a.length>0&&c.forEach(a,function(a,b){e=c.create("option",{innerHTML:a,value:a},d.domNode);if(b==0)e.selected=!0})};a.removeItems=
function(){c.empty(this.domNode)};a.deselectAll=function(){this.containerNode.selectedIndex=-1};this.connect(this,"onKeyPress","_cancel");this.connect(this.unfoundTextBox,"onKeyPress","_enter");this.connect(this.unfoundTextBox,"onChange","_unfoundTextBoxChange");this.connect(this.suggestionSelect,"onKeyPress","_enter");this.connect(this.skipButton,"onClick","onSkip");this.connect(this.skipAllButton,"onClick","onSkipAll");this.connect(this.toDicButton,"onClick","onAddToDic");this.connect(this.replaceButton,
"onClick","onReplace");this.connect(this.replaceAllButton,"onClick","onReplaceAll");this.connect(this.cancelButton,"onClick","onCancel")},onSkip:function(){},onSkipAll:function(){},onAddToDic:function(){},onReplace:function(){},onReplaceAll:function(){},onCancel:function(){},onEnter:function(){},focus:function(){this.unfoundTextBox.focus()},_cancel:function(a){a.keyCode==c.keys.ESCAPE&&(this.onCancel(),c.stopEvent(a))},_enter:function(a){a.keyCode==c.keys.ENTER&&(this.onEnter(),c.stopEvent(a))},_unfoundTextBoxChange:function(){var a=
this.textId+"_label";this.ignoreChange?c.byId(a).innerHTML=this.unfound:(c.byId(a).innerHTML=this.replaceWith,this.isChanged=!0,this.suggestionSelect.deselectAll())},_setUnfoundWordAttr:function(a){this.unfoundTextBox.set("value",a||"")},_getUnfoundWordAttr:function(){return this.unfoundTextBox.get("value")},_setSuggestionListAttr:function(a){var b=this.suggestionSelect,a=a||[];b.removeItems();b.addItems(a)},_getSelectedWordAttr:function(){var a=this.suggestionSelect.getSelected();return a&&a.length>
0?a[0].value:this.unfoundTextBox.get("value")},_setDisabledAttr:function(a){this.skipButton.set("disabled",a);this.skipAllButton.set("disabled",a);this.toDicButton.set("disabled",a);this.replaceButton.set("disabled",a);this.replaceAllButton.set("disabled",a)},_setInProgressAttr:function(a){c[a?"removeClass":"addClass"](this.id+"_progressIcon","hidden")}});c.declare("dojox.editor.plugins._SpellCheckScriptMultiPart",null,{ACTION_QUERY:"query",ACTION_UPDATE:"update",callbackHandle:"callback",maxBufferLength:100,
delimiter:" ",label:"response",_timeout:3E4,SEC:1E3,constructor:function(){this.serviceEndPoint="";this._queue=[];this.isWorking=!1;this.exArgs=null;this._counter=0},send:function(a,b){var d=this,e=this.delimiter,f=this.maxBufferLength,g=this.label,j=this.serviceEndPoint,p=this.callbackHandle,o=this.exArgs,q=this._timeout,n=0,h=0;if(!this._result)this._result=[];var b=b||this.ACTION_QUERY,i=function(){var l=[],k=0;if(a&&a.length>0){d.isWorking=!0;var i=a.length;do{n=h+1;if((h+=f)>i)h=i;else for(;e&&
a.charAt(h)!=e&&h<=i;)h++;l.push({l:n,r:h});k++}while(h<i);c.forEach(l,function(f,e){var h={url:j,action:b,timeout:q,callbackParamName:p,handle:function(a){if(++d._counter<=this.size&&!(a instanceof Error)&&a[g]&&c.isArray(a[g])){var b=this.offset;c.forEach(a[g],function(a){a.offset+=b});d._result[this.number]=a[g]}if(d._counter==this.size)d._finalizeCollection(this.action),d.isWorking=!1,d._queue.length>0&&d._queue.shift()()}};h.content=o?c.mixin(o,{action:b,content:a.substring(f.l-1,f.r)}):{action:b,
content:a.substring(f.l-1,f.r)};h.size=k;h.number=e;h.offset=f.l-1;c.io.script.get(h)})}};d.isWorking?d._queue.push(i):i()},_finalizeCollection:function(a){for(var b=this._result,d=b.length,c=0;c<d;c++)var f=b.shift(),b=b.concat(f);if(a==this.ACTION_QUERY)this.onLoad(b);this._counter=0;this._result=[]},onLoad:function(){},setWaitingTime:function(a){this._timeout=a*this.SEC}});c.declare("dojox.editor.plugins.SpellCheck",[j._editor._Plugin],{url:"",bufferLength:100,interactive:!1,timeout:30,button:null,
_editor:null,exArgs:null,_cursorSpan:'<span class="cursorPlaceHolder"></span>',_cursorSelector:"cursorPlaceHolder",_incorrectWordsSpan:"<span class='incorrectWordPlaceHolder'>${text}</span>",_ignoredIncorrectStyle:{cursor:"inherit",borderBottom:"none",backgroundColor:"transparent"},_normalIncorrectStyle:{cursor:"pointer",borderBottom:"1px dotted red",backgroundColor:"yellow"},_highlightedIncorrectStyle:{borderBottom:"1px dotted red",backgroundColor:"#b3b3ff"},_selector:"incorrectWordPlaceHolder",
_maxItemNumber:3,constructor:function(){this._spanList=[];this._cache={};this._enabled=!0;this._iterator=0},setEditor:function(a){this._editor=a;this._initButton();this._setNetwork();this._connectUp()},_initButton:function(){var a=this,b=this._strings=c.i18n.getLocalization("dojox.editor.plugins","SpellCheck"),d=this._dialog=new j.TooltipDialog;d.set("content",this._dialogContent=new m.editor.plugins._spellCheckControl({unfound:b.unfound,skip:b.skip,skipAll:b.skipAll,toDic:b.toDic,suggestions:b.suggestions,
replaceWith:b.replaceWith,replace:b.replace,replaceAll:b.replaceAll,cancel:b.cancel}));this.button=new j.form.DropDownButton({label:b.widgetLabel,showLabel:!1,iconClass:"dijitEditorSpellCheckIcon",dropDown:d,id:j.getUniqueId(this.declaredClass.replace(/\./g,"_"))+"_dialogPane",closeDropDown:function(b){if(a._dialogContent.closable){a._dialogContent.isOpen=!1;if(c.isIE){var d=a._iterator,g=a._spanList;d<g.length&&d>=0&&c.style(g[d],a._normalIncorrectStyle)}if(this._opened)j.popup.close(this.dropDown),
b&&this.focus(),this._opened=!1,this.state=""}}});a._dialogContent.isOpen=!1;d.domNode.setAttribute("aria-label",this._strings.widgetLabel)},_setNetwork:function(){var a=this.exArgs;if(!this._service){var b=this._service=new m.editor.plugins._SpellCheckScriptMultiPart;b.serviceEndPoint=this.url;b.maxBufferLength=this.bufferLength;b.setWaitingTime(this.timeout);if(a)delete a.name,delete a.url,delete a.interactive,delete a.timeout,b.exArgs=a}},_connectUp:function(){var a=this._editor,b=this._dialogContent;
this.connect(this.button,"set","_disabled");this.connect(this._service,"onLoad","_loadData");this.connect(this._dialog,"onOpen","_openDialog");this.connect(a,"onKeyPress","_keyPress");this.connect(a,"onLoad","_submitContent");this.connect(b,"onSkip","_skip");this.connect(b,"onSkipAll","_skipAll");this.connect(b,"onAddToDic","_add");this.connect(b,"onReplace","_replace");this.connect(b,"onReplaceAll","_replaceAll");this.connect(b,"onCancel","_cancel");this.connect(b,"onEnter","_enter");a.contentPostFilters.push(this._spellCheckFilter);
c.publish(j._scopeName+".Editor.plugin.SpellCheck.getParser",[this]);this.parser||console.error("Can not get the word parser!")},_disabled:function(a,b){if(a=="disabled")b?(this._iterator=0,this._spanList=[]):this.interactive&&!b&&this._service&&this._submitContent(!0),this._enabled=!b},_keyPress:function(a){if(this.interactive){var b=a.charCode;!a.altKey&&b==c.keys.SPACE?this._submitContent():(a.ctrlKey&&(b==118||b==86)||!a.ctrlKey&&a.charCode)&&this._submitContent(!0)}},_loadData:function(a){var b=
this._cache,d=this._editor.get("value"),e=this._dialogContent;this._iterator=0;c.forEach(a,function(a){b[a.text]=a.suggestion;b[a.text].correct=!1});if(this._enabled&&(e.closable=!1,this._markIncorrectWords(d,b),e.closable=!0,this._dialogContent.isOpen))this._iterator=-1,this._skip()},_openDialog:function(){var a=this._dialogContent;a.ignoreChange=!0;a.set("unfoundWord","");a.set("suggestionList",null);a.set("disabled",!0);a.set("inProgress",!0);a.isOpen=!0;a.closable=!1;this._submitContent();a.closable=
!0},_skip:function(a,b){var d=this._dialogContent,e=this._spanList||[],f=e.length,g=this._iterator;d.closable=!1;d.isChanged=!1;d.ignoreChange=!0;for(!b&&g>=0&&g<f&&this._skipWord(g);++g<f&&e[g].edited==!0;);g<f?(this._iterator=g,this._populateDialog(g),this._selectWord(g)):(this._iterator=-1,d.set("unfoundWord",this._strings.msg),d.set("suggestionList",null),d.set("disabled",!0),d.set("inProgress",!1));setTimeout(function(){c.isWebKit&&d.skipButton.focus();d.focus();d.ignoreChange=!1;d.closable=
!0},0)},_skipAll:function(){this._dialogContent.closable=!1;this._skipWordAll(this._iterator);this._skip()},_add:function(){var a=this._dialogContent;a.closable=!1;a.isOpen=!0;this._addWord(this._iterator,a.get("unfoundWord"));this._skip()},_replace:function(){var a=this._dialogContent,b=this._iterator,d=a.get("selectedWord");a.closable=!1;this._replaceWord(b,d);this._skip(null,!0)},_replaceAll:function(){var a=this._dialogContent,b=this._spanList,d=b.length,c=b[this._iterator].innerHTML.toLowerCase(),
f=a.get("selectedWord");a.closable=!1;for(a=0;a<d;a++)b[a].innerHTML.toLowerCase()==c&&this._replaceWord(a,f);this._skip(null,!0)},_cancel:function(){this._dialogContent.closable=!0;this._editor.focus()},_enter:function(){this._dialogContent.isChanged?this._replace():this._skip()},_query:function(a){var b=this._service,d=this._cache,a=this.parser.parseIntoWords(this._html2Text(a))||[],e=[];c.forEach(a,function(a){a=a.toLowerCase();if(!d[a])d[a]=[],d[a].correct=!0,e.push(a)});e.length>0?b.send(e.join(" ")):
b.isWorking||this._loadData([])},_html2Text:function(a){for(var b=[],d=!1,c=a?a.length:0,f=0;f<c;f++)a.charAt(f)=="<"&&(d=!0),d==!0?b.push(" "):b.push(a.charAt(f)),a.charAt(f)==">"&&(d=!1);return b.join("")},_getBookmark:function(a){var b=this._editor,d=this._cursorSpan;b.execCommand("inserthtml",d);for(var b=b.get("value"),d=b.indexOf(d),c=-1;++c<d&&a.charAt(c)==b.charAt(c););return c},_moveToBookmark:function(){var a=this._editor,b=c.withGlobal(a.window,"query",c,["."+this._cursorSelector]);if(b=
b&&b[0])a._sCall("selectElement",[b]),a._sCall("collapse",[!0]),(a=b.parentNode)&&a.removeChild(b)},_submitContent:function(a){if(a){var b=this;if(this._delayHandler)clearTimeout(this._delayHandler),this._delayHandler=null;setTimeout(function(){b._query(b._editor.get("value"))},3E3)}else this._query(this._editor.get("value"))},_populateDialog:function(a){var b=this._spanList,d=this._cache,c=this._dialogContent;c.set("disabled",!1);if(a<b.length&&b.length>0)a=b[a].innerHTML,c.set("unfoundWord",a),
c.set("suggestionList",d[a.toLowerCase()]),c.set("inProgress",!1)},_markIncorrectWords:function(a,b){for(var d=this,e=this.parser,f=this._editor,g=this._incorrectWordsSpan,m=this._normalIncorrectStyle,p=this._selector,o=e.parseIntoWords(this._html2Text(a).toLowerCase()),e=e.getIndices(),q=this._cursorSpan,n=this._getBookmark(a),h=!1,i=a.split(""),l=null,l=o.length-1;l>=0;l--){var k=o[l];if(b[k]&&!b[k].correct){var k=e[l],s=o[l].length,r=k+s;r<=n&&!h&&(i.splice(n,0,q),h=!0);i.splice(k,s,c.string.substitute(g,
{text:a.substring(k,r)}));k<n&&n<r&&!h&&(h=i[k].split(""),h.splice(39+n-k,0,q),i[k]=h.join(""),h=!0)}}h||(i.splice(n,0,q),h=!0);f.set("value",i.join(""));f._cursorToStart=!1;this._moveToBookmark();l=this._spanList=c.withGlobal(f.window,"query",c,["."+this._selector]);c.forEach(l,function(a,b){a.id=p+b});this.interactive||delete m.cursor;l.style(m);if(this.interactive){if(d._contextMenu)d._contextMenu.uninitialize(),d._contextMenu=null;d._contextMenu=new j.Menu({targetNodeIds:[f.iframe],bindDomNode:function(a){var a=
c.byId(a),e,g,h;a.tagName.toLowerCase()=="iframe"?(g=a,h=this._iframeContentWindow(g),e=c.withGlobal(h,c.body)):e=a==c.body()?c.doc.documentElement:a;var i={node:a,iframe:g};c.attr(a,"_dijitMenu"+this.id,this._bindings.push(i));var k=c.hitch(this,function(a){return[c.connect(a,this.leftClickToOpen?"onclick":"oncontextmenu",this,function(a){var e=a.target,h=d._strings;if(c.hasClass(e,p)&&!e.edited){c.stopEvent(a);var i=d._maxItemNumber,k=e.id.substring(p.length),l=b[e.innerHTML.toLowerCase()],n=l.length;
this.destroyDescendants();if(n==0)this.addChild(new j.MenuItem({label:h.iMsg,disabled:!0}));else for(var m=0;m<i&&m<n;m++)this.addChild(new j.MenuItem({label:l[m],onClick:function(){var a=l[m];return function(){d._replaceWord(k,a);f.focus()}}()}));this.addChild(new j.MenuSeparator);this.addChild(new j.MenuItem({label:h.iSkip,onClick:function(){d._skipWord(k);f.focus()}}));this.addChild(new j.MenuItem({label:h.iSkipAll,onClick:function(){d._skipWordAll(k);f.focus()}}));this.addChild(new j.MenuSeparator);
this.addChild(new j.MenuItem({label:h.toDic,onClick:function(){d._addWord(k);f.focus()}}));this._scheduleOpen(e,g,{x:a.pageX,y:a.pageY})}}),c.connect(a,"onkeydown",this,function(a){a.shiftKey&&a.keyCode==c.keys.F10&&(c.stopEvent(a),this._scheduleOpen(a.target,g))})]});i.connects=e?k(e):[];if(g)i.onloadHandler=c.hitch(this,function(){var a=this._iframeContentWindow(g);e=c.withGlobal(a,c.body);i.connects=k(e)}),g.addEventListener?g.addEventListener("load",i.onloadHandler,!1):g.attachEvent("onload",
i.onloadHandler)}})}},_selectWord:function(a){var b=this._spanList,d=this._editor.window;a<b.length&&b.length>0&&(c.withGlobal(d,"selectElement",j._editor.selection,[b[a]]),c.withGlobal(d,"collapse",j._editor.selection,[!0]),this._findText(b[a].innerHTML,!1,!1),c.isIE&&c.style(b[a],this._highlightedIncorrectStyle))},_replaceWord:function(a,b){var d=this._spanList;d[a].innerHTML=b;c.style(d[a],this._ignoredIncorrectStyle);d[a].edited=!0},_skipWord:function(a){var b=this._spanList;c.style(b[a],this._ignoredIncorrectStyle);
this._cache[b[a].innerHTML.toLowerCase()].correct=!0;b[a].edited=!0},_skipWordAll:function(a,b){for(var c=this._spanList,e=c.length,b=b||c[a].innerHTML.toLowerCase(),f=0;f<e;f++)!c[f].edited&&c[f].innerHTML.toLowerCase()==b&&this._skipWord(f)},_addWord:function(a,b){var c=this._service;c.send(b||this._spanList[a].innerHTML.toLowerCase(),c.ACTION_UPDATE);this._skipWordAll(a,b)},_findText:function(a,b,c){var e=this._editor,f=e.window,g=!1;if(a)f.find?g=f.find(a,b,c,!1,!1,!1,!1):(f=e.document,f.selection&&
(this._editor.focus(),e=f.body.createTextRange(),(g=f.selection?f.selection.createRange():null)&&(c?e.setEndPoint("EndToStart",g):e.setEndPoint("StartToEnd",g)),b=b?4:0,c&&(b|=1),(g=e.findText(a,e.text.length,b))&&e.select()));return g},_spellCheckFilter:function(a){return a.replace(/<span class=["']incorrectWordPlaceHolder["'].*?>(.*?)<\/span>/g,"$1")}});c.subscribe(j._scopeName+".Editor.getPlugin",null,function(a){if(!a.plugin&&a.args.name.toLowerCase()==="spellcheck")a.plugin=new m.editor.plugins.SpellCheck({url:"url"in
a.args?a.args.url:"",interactive:"interactive"in a.args?a.args.interactive:!1,bufferLength:"bufferLength"in a.args?a.args.bufferLength:100,timeout:"timeout"in a.args?a.args.timeout:30,exArgs:a.args})})});