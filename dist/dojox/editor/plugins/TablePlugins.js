//>>built
define("dojox/editor/plugins/TablePlugins",["dojo","dijit","dojox","dijit/_base/popup","dijit/_Widget","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/Menu","dijit/MenuItem","dijit/MenuSeparator","dijit/TooltipDialog","dijit/form/Button","dijit/form/DropDownButton","dijit/Dialog","dijit/form/TextBox","dijit/form/FilteringSelect","dijit/popup","dijit/_editor/_Plugin","dijit/_editor/range","dijit/_editor/selection","dijit/ColorPalette","dojox/widget/ColorPicker","dojo/_base/connect",
"dojo/_base/declare","dojo/i18n","dojo/i18n!dojox/editor/plugins/nls/TableDialog"],function(b,d,f){b.experimental("dojox.editor.plugins.TablePlugins");b.declare("dojox.editor.plugins._TableHandler",d._editor._Plugin,{tablesConnected:!1,currentlyAvailable:!1,alwaysAvailable:!1,availableCurrentlySet:!1,initialized:!1,tableData:null,shiftKeyDown:!1,editorDomNode:null,undoEnabled:!0,refCount:0,doMixins:function(){b.mixin(this.editor,{getAncestorElement:function(a){return b.withGlobal(this.window,"getAncestorElement",
d._editor.selection,[a])},hasAncestorElement:function(a){return b.withGlobal(this.window,"hasAncestorElement",d._editor.selection,[a])},selectElement:function(a){b.withGlobal(this.window,"selectElement",d._editor.selection,[a])},byId:function(a){return b.withGlobal(this.window,"byId",b,[a])},query:function(a,c,e){a=b.withGlobal(this.window,"query",b,[a,c]);return e?a[0]:a}})},initialize:function(a){this.refCount++;a.customUndo=!0;if(!this.initialized)this.initialized=!0,this.editor=a,this.editor._tablePluginHandler=
this,a.onLoadDeferred.addCallback(b.hitch(this,function(){this.editorDomNode=this.editor.editNode||this.editor.iframe.document.body.firstChild;this._myListeners=[];this._myListeners.push(b.connect(this.editorDomNode,"mouseup",this.editor,"onClick"));this._myListeners.push(b.connect(this.editor,"onDisplayChanged",this,"checkAvailable"));this._myListeners.push(b.connect(this.editor,"onBlur",this,"checkAvailable"));this.doMixins();this.connectDraggable()}))},getTableInfo:function(a){a&&this._tempStoreTableData(!1);
if(this.tableData)return this.tableData;var c,e,i,d,f,g,h;if(e=this.editor.getAncestorElement("td"))c=e.parentNode;d=this.editor.getAncestorElement("table");i=b.query("td",d);i.forEach(function(a,c){e==a&&(g=c)});a=b.query("tr",d);a.forEach(function(a,b){c==a&&(h=b)});f=i.length/a.length;this.tableData={tbl:d,td:e,tr:c,trs:a,tds:i,rows:a.length,cols:f,tdIndex:g,trIndex:h,colIndex:g%f};this._tempStoreTableData(500);return this.tableData},connectDraggable:function(){if(b.isIE)this.editorDomNode.ondragstart=
b.hitch(this,"onDragStart"),this.editorDomNode.ondragend=b.hitch(this,"onDragEnd")},onDragStart:function(){var a=window.event;if(!a.srcElement.id)a.srcElement.id="tbl_"+(new Date).getTime()},onDragEnd:function(){var a=window.event.srcElement,c=a.id,e=this.editor.window;a.tagName.toLowerCase()=="table"&&setTimeout(function(){var a=b.withGlobal(e,"byId",b,[c]);b.removeAttr(a,"align")},100)},checkAvailable:function(){if(this.availableCurrentlySet)return this.currentlyAvailable;if(!this.editor)return!1;
if(this.alwaysAvailable)return!0;(this.currentlyAvailable=this.editor.focused?this.editor.hasAncestorElement("table"):!1)?this.connectTableKeys():this.disconnectTableKeys();this._tempAvailability(500);b.publish(this.editor.id+"_tablePlugins",[this.currentlyAvailable]);return this.currentlyAvailable},_prepareTable:function(a){var c=this.editor.query("td",a);console.log("prep:",c,a);c[0].id||c.forEach(function(a,c){if(!a.id)a.id="tdid"+c+this.getTimeStamp()},this);return c},getTimeStamp:function(){return(new Date).getTime()},
_tempStoreTableData:function(a){if(a!==!0)a===!1?this.tableData=null:a===void 0?console.warn("_tempStoreTableData must be passed an argument"):setTimeout(b.hitch(this,function(){this.tableData=null}),a)},_tempAvailability:function(a){a===!0?this.availableCurrentlySet=!0:a===!1?this.availableCurrentlySet=!1:a===void 0?console.warn("_tempAvailability must be passed an argument"):(this.availableCurrentlySet=!0,setTimeout(b.hitch(this,function(){this.availableCurrentlySet=!1}),a))},connectTableKeys:function(){if(!this.tablesConnected){this.tablesConnected=
!0;var a=this.editor.iframe?this.editor.document:this.editor.editNode;this.cnKeyDn=b.connect(a,"onkeydown",this,"onKeyDown");this.cnKeyUp=b.connect(a,"onkeyup",this,"onKeyUp");this._myListeners.push(b.connect(a,"onkeypress",this,"onKeyUp"))}},disconnectTableKeys:function(){b.disconnect(this.cnKeyDn);b.disconnect(this.cnKeyUp);this.tablesConnected=!1},onKeyDown:function(a){var c=a.keyCode;if(c==16)this.shiftKeyDown=!0;if(c==9)c=this.getTableInfo(),c.tdIndex=this.shiftKeyDown?c.tdIndex-1:tabTo=c.tdIndex+
1,c.tdIndex>=0&&c.tdIndex<c.tds.length?(this.editor.selectElement(c.tds[c.tdIndex]),this.currentlyAvailable=!0,this._tempAvailability(!0),this._tempStoreTableData(!0),this.stopEvent=!0):(this.stopEvent=!1,this.onDisplayChanged()),this.stopEvent&&b.stopEvent(a)},onKeyUp:function(a){var c=a.keyCode;if(c==16)this.shiftKeyDown=!1;if(c==37||c==38||c==39||c==40)this.onDisplayChanged();c==9&&this.stopEvent&&b.stopEvent(a)},onDisplayChanged:function(){this.currentlyAvailable=!1;this._tempStoreTableData(!1);
this._tempAvailability(!1);this.checkAvailable()},uninitialize:function(a){if(this.editor==a){this.refCount--;if(!this.refCount&&this.initialized)this.tablesConnected&&this.disconnectTableKeys(),this.initialized=!1,b.forEach(this._myListeners,function(a){b.disconnect(a)}),delete this._myListeners,delete this.editor._tablePluginHandler,delete this.editor;this.inherited(arguments)}}});b.declare("dojox.editor.plugins.TablePlugins",d._editor._Plugin,{iconClassPrefix:"editorIcon",useDefaultCommand:!1,
buttonClass:d.form.Button,commandName:"",label:"",alwaysAvailable:!1,undoEnabled:!0,onDisplayChanged:function(a){if(!this.alwaysAvailable)this.available=a,this.button.set("disabled",!this.available)},setEditor:function(a){this.editor=a;this.editor.customUndo=!0;this.inherited(arguments);this._availableTopic=b.subscribe(this.editor.id+"_tablePlugins",this,"onDisplayChanged");this.onEditorLoaded()},onEditorLoaded:function(){this.editor._tablePluginHandler?this.editor._tablePluginHandler.initialize(this.editor):
(new f.editor.plugins._TableHandler).initialize(this.editor)},selectTable:function(){var a=this.getTableInfo();a&&a.tbl&&b.withGlobal(this.editor.window,"selectElement",d._editor.selection,[a.tbl])},_initButton:function(){this.command=this.commandName;this.label=this.editor.commands[this.command]=this._makeTitle(this.command);this.inherited(arguments);delete this.command;this.connect(this.button,"onClick","modTable");this.onDisplayChanged(!1)},modTable:function(a){this.begEdit();var c=this.getTableInfo(),
e=b.isString(a)?a:this.commandName,d,f,a=!1;b.isIE&&this.editor.focus();switch(e){case "insertTableRowBefore":e=c.tbl.insertRow(c.trIndex);for(f=0;f<c.cols;f++)d=e.insertCell(-1),d.innerHTML="&nbsp;";break;case "insertTableRowAfter":e=c.tbl.insertRow(c.trIndex+1);for(f=0;f<c.cols;f++)d=e.insertCell(-1),d.innerHTML="&nbsp;";break;case "insertTableColumnBefore":c.trs.forEach(function(a){d=a.insertCell(c.colIndex);d.innerHTML="&nbsp;"});a=!0;break;case "insertTableColumnAfter":c.trs.forEach(function(a){d=
a.insertCell(c.colIndex+1);d.innerHTML="&nbsp;"});a=!0;break;case "deleteTableRow":c.tbl.deleteRow(c.trIndex);console.log("TableInfo:",this.getTableInfo());break;case "deleteTableColumn":c.trs.forEach(function(a){a.deleteCell(c.colIndex)}),a=!0}a&&this.makeColumnsEven();this.endEdit()},begEdit:function(){if(this.editor._tablePluginHandler.undoEnabled)this.editor.customUndo?this.editor.beginEditing():this.valBeforeUndo=this.editor.getValue()},endEdit:function(){if(this.editor._tablePluginHandler.undoEnabled){if(this.editor.customUndo)this.editor.endEditing();
else{var a=this.editor.getValue();this.editor.setValue(this.valBeforeUndo);this.editor.replaceValue(a)}this.editor.onDisplayChanged()}},makeColumnsEven:function(){setTimeout(b.hitch(this,function(){var a=this.getTableInfo(!0),c=Math.floor(100/a.cols);a.tds.forEach(function(a){b.attr(a,"width",c+"%")})}),10)},getTableInfo:function(a){return this.editor._tablePluginHandler.getTableInfo(a)},_makeTitle:function(a){var c=[];b.forEach(a,function(a,b){a.charCodeAt(0)<91&&b>0&&c[b-1].charCodeAt(0)!=32&&c.push(" ");
b===0&&(a=a.toUpperCase());c.push(a)});return c.join("")},getSelectedCells:function(){var a=[];this.editor._tablePluginHandler._prepareTable(this.getTableInfo().tbl);var c=this.editor,e=b.withGlobal(c.window,"getSelectedHtml",d._editor.selection,[null]).match(/id="*\w*"*/g);b.forEach(e,function(b){b=b.substring(3,b.length);b.charAt(0)=='"'&&b.charAt(b.length-1)=='"'&&(b=b.substring(1,b.length-1));(b=c.byId(b))&&b.tagName.toLowerCase()=="td"&&a.push(b)},this);if(!a.length&&(e=d.range.getSelection(c.window),
e.rangeCount))for(e=e.getRangeAt(0).startContainer;e&&e!=c.editNode&&e!=c.document;){if(e.nodeType===1&&(e.tagName?e.tagName.toLowerCase():"")==="td")return[e];e=e.parentNode}return a},updateState:function(){this.button&&((this.available||this.alwaysAvailable)&&!this.get("disabled")?this.button.set("disabled",!1):this.button.set("disabled",!0))},destroy:function(){this.inherited(arguments);b.unsubscribe(this._availableTopic);this.editor._tablePluginHandler.uninitialize(this.editor)}});b.declare("dojox.editor.plugins.TableContextMenu",
f.editor.plugins.TablePlugins,{constructor:function(){this.connect(this,"setEditor",function(a){a.onLoadDeferred.addCallback(b.hitch(this,function(){this._createContextMenu()}));this.button.domNode.style.display="none"})},destroy:function(){this.menu&&(this.menu.destroyRecursive(),delete this.menu);this.inherited(arguments)},_initButton:function(){this.inherited(arguments);if(this.commandName=="tableContextMenu")this.button.domNode.display="none"},_createContextMenu:function(){var a=new d.Menu({targetNodeIds:[this.editor.iframe]}),
c=b.i18n.getLocalization("dojox.editor.plugins","TableDialog",this.lang);a.addChild(new d.MenuItem({label:c.selectTableLabel,onClick:b.hitch(this,"selectTable")}));a.addChild(new d.MenuSeparator);a.addChild(new d.MenuItem({label:c.insertTableRowBeforeLabel,onClick:b.hitch(this,"modTable","insertTableRowBefore")}));a.addChild(new d.MenuItem({label:c.insertTableRowAfterLabel,onClick:b.hitch(this,"modTable","insertTableRowAfter")}));a.addChild(new d.MenuItem({label:c.insertTableColumnBeforeLabel,onClick:b.hitch(this,
"modTable","insertTableColumnBefore")}));a.addChild(new d.MenuItem({label:c.insertTableColumnAfterLabel,onClick:b.hitch(this,"modTable","insertTableColumnAfter")}));a.addChild(new d.MenuSeparator);a.addChild(new d.MenuItem({label:c.deleteTableRowLabel,onClick:b.hitch(this,"modTable","deleteTableRow")}));a.addChild(new d.MenuItem({label:c.deleteTableColumnLabel,onClick:b.hitch(this,"modTable","deleteTableColumn")}));this.menu=a}});b.declare("dojox.editor.plugins.InsertTable",f.editor.plugins.TablePlugins,
{alwaysAvailable:!0,modTable:function(){var a=new f.editor.plugins.EditorTableDialog({});a.show();var c=b.connect(a,"onBuildTable",this,function(a){b.disconnect(c);this.editor.execCommand("inserthtml",a.htmlText)})}});b.declare("dojox.editor.plugins.ModifyTable",f.editor.plugins.TablePlugins,{modTable:function(){if(this.editor._tablePluginHandler.checkAvailable()){var a=this.getTableInfo(),a=new f.editor.plugins.EditorModifyTableDialog({table:a.tbl});a.show();this.connect(a,"onSetTable",function(a){var e=
this.getTableInfo();b.attr(e.td,"bgcolor",a)})}}});b.declare("dojox.editor.plugins._CellColorDropDown",[d._Widget,d._TemplatedMixin,d._WidgetsInTemplateMixin],{templateString:"<div style='display: none; position: absolute; top: -10000; z-index: -10000'><div dojoType='dijit.TooltipDialog' dojoAttachPoint='dialog' class='dojoxEditorColorPicker'><div dojoType='dojox.widget.ColorPicker' dojoAttachPoint='_colorPicker'></div><div style='margin: 0.5em 0em 0em 0em'><button dojoType='dijit.form.Button' type='button' dojoAttachPoint='_setButton'>${buttonSet}</button>&nbsp;<button dojoType='dijit.form.Button' type='button' dojoAttachPoint='_cancelButton'>${buttonCancel}</button></div></div></div>",
widgetsInTemplate:!0,constructor:function(){var a=b.i18n.getLocalization("dojox.editor.plugins","TableDialog");b.mixin(this,a)},startup:function(){this._started||(this.inherited(arguments),this.connect(this._setButton,"onClick",function(){this.onChange(this.get("value"))}),this.connect(this._cancelButton,"onClick",function(){d.popup.close(this.dialog);this.onCancel()}),b.style(this.domNode,"display","block"))},_setValueAttr:function(a,b){this._colorPicker.set("value",a,b)},_getValueAttr:function(){return this._colorPicker.get("value")},
setColor:function(a){this._colorPicker.setColor(a,!1)},onChange:function(){},onCancel:function(){}});b.declare("dojox.editor.plugins.ColorTableCell",f.editor.plugins.TablePlugins,{constructor:function(){this.closable=!0;this.buttonClass=d.form.DropDownButton;var a=new f.editor.plugins._CellColorDropDown;b.body().appendChild(a.domNode);a.startup();this.dropDown=a.dialog;this.connect(a,"onChange",function(a){this.modTable(null,a);this.editor.focus()});this.connect(a,"onCancel",function(){this.editor.focus()});
this.connect(a.dialog,"onOpen",function(){var c=this.getSelectedCells(this.getTableInfo().tbl);if(c&&c.length>0){for(var c=c[0]==this.lastObject?c[0]:c[c.length-1],e;c&&((e=b.style(c,"backgroundColor"))=="transparent"||e.indexOf("rgba")==0);)c=c.parentNode;e=b.style(c,"backgroundColor");e!="transparent"&&e.indexOf("rgba")!=0&&a.setColor(e)}});this.connect(this,"setEditor",function(a){a.onLoadDeferred.addCallback(b.hitch(this,function(){this.connect(this.editor.editNode,"onmouseup",function(a){this.lastObject=
a.target})}))})},_initButton:function(){this.command=this.commandName;this.label=this.editor.commands[this.command]=this._makeTitle(this.command);this.inherited(arguments);delete this.command;this.onDisplayChanged(!1)},modTable:function(a,c){this.begEdit();var e=this.getSelectedCells(this.getTableInfo().tbl);b.forEach(e,function(a){b.style(a,"backgroundColor",c)});this.endEdit()}});b.declare("dojox.editor.plugins.EditorTableDialog",[d.Dialog,d._TemplatedMixin,d._WidgetsInTemplateMixin],{baseClass:"EditorTableDialog",
templateString:b.cache("dojox.editor.plugins","resources/insertTable.html"),postMixInProperties:function(){var a=b.i18n.getLocalization("dojox.editor.plugins","TableDialog",this.lang);b.mixin(this,a);this.inherited(arguments)},postCreate:function(){b.addClass(this.domNode,this.baseClass);this.inherited(arguments)},onInsert:function(){console.log("insert");for(var a=this.selectRow.get("value")||1,c=this.selectCol.get("value")||1,e=this.selectWidth.get("value"),d=this.selectWidthType.get("value"),f=
this.selectBorder.get("value"),j=this.selectPad.get("value"),g=this.selectSpace.get("value"),h="tbl_"+(new Date).getTime(),e='<table id="'+h+'"width="'+e+(d=="percent"?"%":"")+'" border="'+f+'" cellspacing="'+g+'" cellpadding="'+j+'">\n',d=0;d<a;d++){e+="\t<tr>\n";for(f=0;f<c;f++)e+='\t\t<td width="'+Math.floor(100/c)+'%">&nbsp;</td>\n';e+="\t</tr>\n"}e+="</table><br />";this.onBuildTable({htmlText:e,id:h});var k=b.connect(this,"onHide",function(){b.disconnect(k);var a=this;setTimeout(function(){a.destroyRecursive()},
10)});this.hide()},onCancel:function(){var a=b.connect(this,"onHide",function(){b.disconnect(a);var c=this;setTimeout(function(){c.destroyRecursive()},10)})},onBuildTable:function(){}});b.declare("dojox.editor.plugins.EditorModifyTableDialog",[d.Dialog,d._TemplatedMixin,d._WidgetsInTemplateMixin],{baseClass:"EditorTableDialog",table:null,tableAtts:{},templateString:b.cache("dojox.editor.plugins","resources/modifyTable.html"),postMixInProperties:function(){var a=b.i18n.getLocalization("dojox.editor.plugins",
"TableDialog",this.lang);b.mixin(this,a);this.inherited(arguments)},postCreate:function(){b.addClass(this.domNode,this.baseClass);this.inherited(arguments);this._cleanupWidgets=[];var a=new d.ColorPalette({});this.connect(a,"onChange",function(b){d.popup.close(a);this.setBrdColor(b)});this.connect(a,"onBlur",function(){d.popup.close(a)});this.connect(this.borderCol,"click",function(){d.popup.open({popup:a,around:this.borderCol});a.focus()});var c=new d.ColorPalette({});this.connect(c,"onChange",function(a){d.popup.close(c);
this.setBkColor(a)});this.connect(c,"onBlur",function(){d.popup.close(c)});this.connect(this.backgroundCol,"click",function(){d.popup.open({popup:c,around:this.backgroundCol});c.focus()});this._cleanupWidgets.push(a);this._cleanupWidgets.push(c);this.setBrdColor(b.attr(this.table,"bordercolor"));this.setBkColor(b.attr(this.table,"bgcolor"));var e=b.attr(this.table,"width");if(!e)e=this.table.style.width;var f="pixels";b.isString(e)&&e.indexOf("%")>-1&&(f="percent",e=e.replace(/%/,""));e?(this.selectWidth.set("value",
e),this.selectWidthType.set("value",f)):(this.selectWidth.set("value",""),this.selectWidthType.set("value","percent"));this.selectBorder.set("value",b.attr(this.table,"border"));this.selectPad.set("value",b.attr(this.table,"cellPadding"));this.selectSpace.set("value",b.attr(this.table,"cellSpacing"));this.selectAlign.set("value",b.attr(this.table,"align"))},setBrdColor:function(a){this.brdColor=a;b.style(this.borderCol,"backgroundColor",a)},setBkColor:function(a){this.bkColor=a;b.style(this.backgroundCol,
"backgroundColor",a)},onSet:function(){b.attr(this.table,"borderColor",this.brdColor);b.attr(this.table,"bgColor",this.bkColor);this.selectWidth.get("value")&&(b.style(this.table,"width",""),b.attr(this.table,"width",this.selectWidth.get("value")+(this.selectWidthType.get("value")=="pixels"?"":"%")));b.attr(this.table,"border",this.selectBorder.get("value"));b.attr(this.table,"cellPadding",this.selectPad.get("value"));b.attr(this.table,"cellSpacing",this.selectSpace.get("value"));b.attr(this.table,
"align",this.selectAlign.get("value"));var a=b.connect(this,"onHide",function(){b.disconnect(a);var c=this;setTimeout(function(){c.destroyRecursive()},10)});this.hide()},onCancel:function(){var a=b.connect(this,"onHide",function(){b.disconnect(a);var c=this;setTimeout(function(){c.destroyRecursive()},10)})},onSetTable:function(){},destroy:function(){this.inherited(arguments);b.forEach(this._cleanupWidgets,function(a){a&&a.destroy&&a.destroy()});delete this._cleanupWidgets}});b.subscribe(d._scopeName+
".Editor.getPlugin",null,function(a){if(!a.plugin&&a.args&&a.args.command){var b=a.args.command.charAt(0).toLowerCase()+a.args.command.substring(1,a.args.command.length);switch(b){case "insertTableRowBefore":case "insertTableRowAfter":case "insertTableColumnBefore":case "insertTableColumnAfter":case "deleteTableRow":case "deleteTableColumn":a.plugin=new f.editor.plugins.TablePlugins({commandName:b});break;case "colorTableCell":a.plugin=new f.editor.plugins.ColorTableCell({commandName:b});break;case "modifyTable":a.plugin=
new f.editor.plugins.ModifyTable({commandName:b});break;case "insertTable":a.plugin=new f.editor.plugins.InsertTable({commandName:b});break;case "tableContextMenu":a.plugin=new f.editor.plugins.TableContextMenu({commandName:b})}}});return f.editor.plugins.TablePlugins});