//>>built
define("dojox/grid/enhanced/plugins/filter/FilterDefDialog",["dojo/_base/declare","dojo/_base/array","dojo/_base/connect","dojo/_base/lang","dojo/_base/event","dojo/_base/html","dojo/_base/sniff","dojo/cache","dojo/keys","dojo/string","dojo/window","dojo/date/locale","./FilterBuilder","../Dialog","dijit/form/ComboBox","dijit/form/TextBox","dijit/form/NumberTextBox","dijit/form/DateTextBox","dijit/form/TimeTextBox","dijit/form/Button","dijit/layout/AccordionContainer","dijit/layout/ContentPane","dijit/_Widget",
"dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/focus","dojox/html/metrics","dijit/a11y","dijit/Tooltip","dijit/form/Select","dijit/form/RadioButton","dojox/html/ellipsis","../../../cells/dijit"],function(l,i,n,h,u,f,m,p,k,o,w,x,y,z,A,B,C,D,E,F,G,H,q,r,s,t,I,J){var j={relSelect:60,accordionTitle:70,removeCBoxBtn:-1,colSelect:90,condSelect:95,valueBox:10,addCBoxBtn:20,filterBtn:30,clearBtn:40,cancelBtn:50},K=l("dojox.grid.enhanced.plugins.filter.AccordionContainer",G,{nls:null,addChild:function(a){var c=
arguments[0]=a._pane=new H({content:a});this.inherited(arguments);this._modifyChild(c)},removeChild:function(a){var c=a,b=!1;if(a._pane)b=!0,c=arguments[0]=a._pane;this.inherited(arguments);b&&(this._hackHeight(!1,this._titleHeight),b=this.getChildren(),b.length===1&&f.style(b[0]._removeCBoxBtn.domNode,"display","none"));c.destroyRecursive()},selectChild:function(a){if(a._pane)arguments[0]=a._pane;this.inherited(arguments)},resize:function(){this.inherited(arguments);i.forEach(this.getChildren(),
this._setupTitleDom)},startup:function(){this._started||(this.inherited(arguments),parseInt(m("ie"),10)==7&&i.some(this._connects,function(a){if(a[0][1]=="onresize")return this.disconnect(a),!0},this),i.forEach(this.getChildren(),function(a){this._modifyChild(a,!0)},this))},_onKeyPress:function(a,c){if(!this.disabled&&!(a.altKey||!c&&!a.ctrlKey)){var b=a.charOrCode,d=f._isBodyLtr(),e=null;if(c&&b==k.UP_ARROW||a.ctrlKey&&b==k.PAGE_UP)e=!1;else if(c&&b==k.DOWN_ARROW||a.ctrlKey&&(b==k.PAGE_DOWN||b==
k.TAB))e=!0;else if(b==(d?k.LEFT_ARROW:k.RIGHT_ARROW))e=this._focusOnRemoveBtn?null:!1,this._focusOnRemoveBtn=!this._focusOnRemoveBtn;else if(b==(d?k.RIGHT_ARROW:k.LEFT_ARROW))e=this._focusOnRemoveBtn?!0:null,this._focusOnRemoveBtn=!this._focusOnRemoveBtn;else return;e!==null&&this._adjacent(e)._buttonWidget._onTitleClick();u.stop(a);w.scrollIntoView(this.selectedChildWidget._buttonWidget.domNode.parentNode);m("ie")&&this.selectedChildWidget._removeCBoxBtn.focusNode.setAttribute("tabIndex",this._focusOnRemoveBtn?
j.accordionTitle:-1);t.focus(this.selectedChildWidget[this._focusOnRemoveBtn?"_removeCBoxBtn":"_buttonWidget"].focusNode)}},_modifyChild:function(a,c){if(a&&this._started){f.style(a.domNode,"overflow","hidden");a._buttonWidget.connect(a._buttonWidget,"_setSelectedAttr",function(){this.focusNode.setAttribute("tabIndex",this.selected?j.accordionTitle:"-1")});var b=this;a._buttonWidget.connect(a._buttonWidget.domNode,"onclick",function(){b._focusOnRemoveBtn=!1});(a._removeCBoxBtn=new F({label:this.nls.removeRuleButton,
showLabel:!1,iconClass:"dojoxGridFCBoxRemoveCBoxBtnIcon",tabIndex:j.removeCBoxBtn,onClick:h.hitch(a.content,"onRemove"),onKeyPress:function(c){b._onKeyPress(c,a._buttonWidget.contentWidget)}})).placeAt(a._buttonWidget.domNode);var d,e=this.getChildren();if(e.length===1)a._buttonWidget.set("selected",!0),f.style(a._removeCBoxBtn.domNode,"display","none");else for(d=0;d<e.length;++d)e[d]._removeCBoxBtn&&f.style(e[d]._removeCBoxBtn.domNode,"display","");this._setupTitleDom(a);if(!this._titleHeight)for(d=
0;d<e.length;++d)if(e[d]!=this.selectedChildWidget){this._titleHeight=f.marginBox(e[d]._buttonWidget.domNode.parentNode).h;break}c||this._hackHeight(!0,this._titleHeight)}},_hackHeight:function(a,c){var b=this.getChildren(),d=this.domNode,e=f.style(d,"height");if(a)if(b.length>1)d.style.height=e+c+"px";else return;else d.style.height=e-c+"px";this.resize()},_setupTitleDom:function(a){var c=f.contentBox(a._buttonWidget.titleNode).w;m("ie")<8&&(c-=8);f.style(a._buttonWidget.titleTextNode,"width",c+
"px")}}),L=l("dojox.grid.enhanced.plugins.filter.FilterDefPane",[q,r,s],{templateString:p("dojox.grid","enhanced/templates/FilterDefPane.html"),widgetsInTemplate:!0,dlg:null,postMixInProperties:function(){this.plugin=this.dlg.plugin;var a=this.plugin.nls;this._addRuleBtnLabel=a.addRuleButton;this._cancelBtnLabel=a.cancelButton;this._clearBtnLabel=a.clearButton;this._filterBtnLabel=a.filterButton;this._relAll=a.relationAll;this._relAny=a.relationAny;this._relMsgFront=a.relationMsgFront;this._relMsgTail=
a.relationMsgTail},postCreate:function(){this.inherited(arguments);this.connect(this.domNode,"onkeypress","_onKey");(this.cboxContainer=new K({nls:this.plugin.nls})).placeAt(this.criteriaPane);this._relSelect.set("tabIndex",j.relSelect);this._addCBoxBtn.set("tabIndex",j.addCBoxBtn);this._cancelBtn.set("tabIndex",j.cancelBtn);this._clearFilterBtn.set("tabIndex",j.clearBtn);this._filterBtn.set("tabIndex",j.filterBtn);var a=this.plugin.nls;this._relSelect.domNode.setAttribute("aria-label",a.waiRelAll);
this._addCBoxBtn.domNode.setAttribute("aria-label",a.waiAddRuleButton);this._cancelBtn.domNode.setAttribute("aria-label",a.waiCancelButton);this._clearFilterBtn.domNode.setAttribute("aria-label",a.waiClearButton);this._filterBtn.domNode.setAttribute("aria-label",a.waiFilterButton);this._relSelect.set("value",this.dlg._relOpCls==="logicall"?"0":"1")},uninitialize:function(){this.cboxContainer.destroyRecursive();this.dlg=this.plugin=null},_onRelSelectChange:function(a){this.dlg._relOpCls=a=="0"?"logicall":
"logicany";this._relSelect.domNode.setAttribute("aria-label",this.plugin.nls[a=="0"?"waiRelAll":"waiRelAny"])},_onAddCBox:function(){this.dlg.addCriteriaBoxes(1)},_onCancel:function(){this.dlg.onCancel()},_onClearFilter:function(){this.dlg.onClearFilter()},_onFilter:function(){this.dlg.onFilter()},_onKey:function(a){if(a.keyCode==k.ENTER)this.dlg.onFilter()}}),v=l("dojox.grid.enhanced.plugins.filter.CriteriaBox",[q,r,s],{templateString:p("dojox.grid","enhanced/templates/CriteriaBox.html"),widgetsInTemplate:!0,
dlg:null,postMixInProperties:function(){this.plugin=this.dlg.plugin;this._curValueBox=null;var a=this.plugin.nls;this._colSelectLabel=a.columnSelectLabel;this._condSelectLabel=a.conditionSelectLabel;this._valueBoxLabel=a.valueBoxLabel;this._anyColumnOption=a.anyColumnOption},postCreate:function(){var a=this.dlg,c=this.plugin.grid;this._colSelect.set("tabIndex",j.colSelect);this._colOptions=this._getColumnOptions();this._colSelect.addOption([{label:this.plugin.nls.anyColumnOption,value:"anycolumn",
selected:a.curColIdx<0},{value:""}].concat(this._colOptions));this._condSelect.set("tabIndex",j.condSelect);this._condSelect.addOption(this._getUsableConditions(a.getColumnType(a.curColIdx)));this._showSelectOrLabel(this._condSelect,this._condSelectAlt);this.connect(c.layout,"moveColumn","onMoveColumn")},_getColumnOptions:function(){var a=this.dlg.curColIdx>=0?String(this.dlg.curColIdx):"anycolumn";return i.map(i.filter(this.plugin.grid.layout.cells,function(a){return!(a.filterable===!1||a.hidden)}),
function(c){return{label:c.name||c.field,value:String(c.index),selected:a==String(c.index)}})},onMoveColumn:function(){var a=this._onChangeColumn;this._onChangeColumn=function(){};var c=this._colSelect.get("selectedOptions");this._colSelect.removeOption(this._colOptions);this._colOptions=this._getColumnOptions();this._colSelect.addOption(this._colOptions);for(var b=0;b<this._colOptions.length;++b)if(this._colOptions[b].label==c.label)break;b<this._colOptions.length&&this._colSelect.set("value",this._colOptions[b].value);
var d=this;setTimeout(function(){d._onChangeColumn=a},0)},onRemove:function(){this.dlg.removeCriteriaBoxes(this)},uninitialize:function(){if(this._curValueBox)this._curValueBox.destroyRecursive(),this._curValueBox=null;this.dlg=this.plugin=null},_showSelectOrLabel:function(a,c){var b=a.getOptions();b.length==1?(c.innerHTML=b[0].label,f.style(a.domNode,"display","none"),f.style(c,"display","")):(f.style(a.domNode,"display",""),f.style(c,"display","none"))},_onChangeColumn:function(a){this._checkValidCriteria();
a=this.dlg.getColumnType(a);this._setConditionsByType(a);this._setValueBoxByType(a);this._updateValueBox()},_onChangeCondition:function(a){this._checkValidCriteria();a=a=="range";if(a^this._isRange)this._isRange=a,this._setValueBoxByType(this.dlg.getColumnType(this._colSelect.get("value")));this._updateValueBox()},_updateValueBox:function(){this._curValueBox.set("disabled",this._condSelect.get("value")=="isempty")},_checkValidCriteria:function(){setTimeout(h.hitch(this,function(){this.updateRuleTitle();
this.dlg._updatePane()}),0)},_createValueBox:function(a,c){var b=h.hitch(c.cbox,"_checkValidCriteria");return new a(h.mixin(c,{tabIndex:j.valueBox,onKeyPress:b,onChange:b,"class":"dojoxGridFCBoxValueBox"}))},_createRangeBox:function(a,c){var b=h.hitch(c.cbox,"_checkValidCriteria");h.mixin(c,{tabIndex:j.valueBox,onKeyPress:b,onChange:b});var b=f.create("div",{"class":"dojoxGridFCBoxValueBox"}),d=new a(c),e=f.create("span",{"class":"dojoxGridFCBoxRangeValueTxt",innerHTML:this.plugin.nls.rangeTo}),g=
new a(c);f.addClass(d.domNode,"dojoxGridFCBoxStartValue");f.addClass(g.domNode,"dojoxGridFCBoxEndValue");b.appendChild(d.domNode);b.appendChild(e);b.appendChild(g.domNode);b.domNode=b;b.set=function(a,b){h.isObject(b)&&(d.set("value",b.start),g.set("value",b.end))};b.get=function(){var a=d.get("value"),b=g.get("value");return a&&b?{start:a,end:b}:""};return b},changeCurrentColumn:function(){var a=this.dlg.curColIdx;this._colSelect.removeOption(this._colOptions);this._colOptions=this._getColumnOptions();
this._colSelect.addOption(this._colOptions);this._colSelect.set("value",a>=0?String(a):"anycolumn");this.updateRuleTitle(!0)},curColumn:function(){return this._colSelect.getOptions(this._colSelect.get("value")).label},curCondition:function(){return this._condSelect.getOptions(this._condSelect.get("value")).label},curValue:function(){if(this._condSelect.get("value")=="isempty")return"";return this._curValueBox?this._curValueBox.get("value"):""},save:function(){if(this.isEmpty())return null;var a=this._colSelect.get("value"),
c=this.dlg.getColumnType(a),b=this.curValue(),d=this._condSelect.get("value");return{column:a,condition:d,value:b,formattedVal:this.formatValue(c,d,b),type:c,colTxt:this.curColumn(),condTxt:this.curCondition()}},load:function(a){var c=[this._onChangeColumn,this._onChangeCondition];this._onChangeColumn=this._onChangeCondition=function(){};a.column&&this._colSelect.set("value",a.column);a.condition&&this._condSelect.set("value",a.condition);a.type?this._setValueBoxByType(a.type):a.type=this.dlg.getColumnType(this._colSelect.get("value"));
var b=a.value||"";(b||a.type!="date"&&a.type!="time")&&this._curValueBox.set("value",b);this._updateValueBox();setTimeout(h.hitch(this,function(){this._onChangeColumn=c[0];this._onChangeCondition=c[1]}),0)},getExpr:function(){if(this.isEmpty())return null;var a=this._colSelect.get("value");return this.dlg.getExprForCriteria({type:this.dlg.getColumnType(a),column:a,condition:this._condSelect.get("value"),value:this.curValue()})},isEmpty:function(){if(this._condSelect.get("value")=="isempty")return!1;
var a=this.curValue();return a===""||a===null||typeof a=="undefined"||typeof a=="number"&&isNaN(a)},updateRuleTitle:function(a){var c=this._pane._buttonWidget.titleTextNode,b=["<div class='dojoxEllipsis'>"];if(a||this.isEmpty())c.title=o.substitute(this.plugin.nls.ruleTitleTemplate,[this._ruleIndex||1]),b.push(c.title);else{var d=this.dlg.getColumnType(this._colSelect.get("value")),a=this.curColumn(),e=this.curCondition(),d=this.formatValue(d,this._condSelect.get("value"),this.curValue());b.push(a,
"&nbsp;<span class='dojoxGridRuleTitleCondition'>",e,"</span>&nbsp;",d);c.title=[a," ",e," ",d].join("")}c.innerHTML=b.join("");if(m("mozilla"))f.create("div",{style:"width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 9999;"},c).title=c.title},updateRuleIndex:function(a){if(this._ruleIndex!=a)this._ruleIndex=a,this.isEmpty()&&this.updateRuleTitle()},setAriaInfo:function(a){var c=o.substitute,b=this.plugin.nls;this._colSelect.domNode.setAttribute("aria-label",c(b.waiColumnSelectTemplate,
[a]));this._condSelect.domNode.setAttribute("aria-label",c(b.waiConditionSelectTemplate,[a]));this._pane._removeCBoxBtn.domNode.setAttribute("aria-label",c(b.waiRemoveRuleButtonTemplate,[a]));this._index=a},_getUsableConditions:function(a){var c=h.clone(this.dlg._dataTypeMap[a].conditions),a=(this.plugin.args.disabledConditions||{})[a],b=parseInt(this._colSelect.get("value"),10),b=isNaN(b)?(this.plugin.args.disabledConditions||{}).anycolumn:this.plugin.grid.layout.cells[b].disabledConditions;h.isArray(a)||
(a=[]);h.isArray(b)||(b=[]);a=a.concat(b);if(a.length){var d={};i.forEach(a,function(a){h.isString(a)&&(d[a.toLowerCase()]=!0)});return i.filter(c,function(a){return!(a.value in d)})}return c},_setConditionsByType:function(a){var c=this._condSelect;c.removeOption(c.options);c.addOption(this._getUsableConditions(a));this._showSelectOrLabel(this._condSelect,this._condSelectAlt)},_setValueBoxByType:function(a){if(this._curValueBox){this.valueNode.removeChild(this._curValueBox.domNode);try{this._curValueBox.destroyRecursive()}catch(c){}delete this._curValueBox}var b=
this.dlg._dataTypeMap[a].valueBoxCls[this._getValueBoxClsInfo(this._colSelect.get("value"),a)],a=this._getValueBoxArgByType(a);this._curValueBox=this[this._isRange?"_createRangeBox":"_createValueBox"](b,a);this.valueNode.appendChild(this._curValueBox.domNode);this._curValueBox.domNode.setAttribute("aria-label",o.substitute(this.plugin.nls.waiValueBoxTemplate,[this._index]));this.dlg.onRendered(this)},_getValueBoxArgByType:function(a){var c=this.plugin.grid,b=c.layout.cells[parseInt(this._colSelect.get("value"),
10)],d={cbox:this};if(a=="string"){if(b&&(b.suggestion||b.autoComplete))f.mixin(d,{store:c.store,searchAttr:b.field||b.name,fetchProperties:{sort:[{attribute:b.field||b.name}],query:c.query,queryOptions:c.queryOptions}})}else a=="boolean"&&f.mixin(d,this.dlg.builder.defaultArgs["boolean"]);b&&b.dataTypeArgs&&f.mixin(d,b.dataTypeArgs);return d},formatValue:function(a,c,b){if(c=="isempty")return"";if(a=="date"||a=="time"){var a={selector:a},d=x.format;if(c=="range")return o.substitute(this.plugin.nls.rangeTemplate,
[d(b.start,a),d(b.end,a)]);return d(b,a)}else if(a=="boolean")return b?this._curValueBox._lblTrue:this._curValueBox._lblFalse;return b},_getValueBoxClsInfo:function(a,c){var b=this.plugin.grid.layout.cells[parseInt(a,10)];if(c=="string")return b&&(b.suggestion||b.autoComplete)?"ac":"dft";return"dft"}}),M=l("dojox.grid.enhanced.plugins.filter.UniqueComboBox",A,{_openResultList:function(a){var c={},b=this.store,d=this.searchAttr;arguments[0]=i.filter(a,function(a){var a=b.getValue(a,d),g=c[a];c[a]=
!0;return!g});this.inherited(arguments)},_onKey:function(a){a.charOrCode===k.ENTER&&this._opened&&u.stop(a);this.inherited(arguments)}}),N=l("dojox.grid.enhanced.plugins.filter.BooleanValueBox",[q,r,s],{templateString:p("dojox.grid","enhanced/templates/FilterBoolValueBox.html"),widgetsInTemplate:!0,constructor:function(a){var c=a.cbox.plugin.nls;this._baseId=a.cbox.id;this._lblTrue=a.trueLabel||c.trueLabel||"true";this._lblFalse=a.falseLabel||c.falseLabel||"false";this.args=a},postCreate:function(){this.onChange()},
onChange:function(){},get:function(){return this.rbTrue.get("checked")},set:function(a,c){this.inherited(arguments);a=="value"&&(this.rbTrue.set("checked",!!c),this.rbFalse.set("checked",!c))}});return l("dojox.grid.enhanced.plugins.filter.FilterDefDialog",null,{curColIdx:-1,_relOpCls:"logicall",_savedCriterias:null,plugin:null,constructor:function(a){var b;b=this.plugin=a.plugin,a=b;this.builder=new y;this._setupData();this._cboxes=[];this.defaultType=a.args.defaultType||"string";(this.filterDefPane=
new L({dlg:this})).startup();(this._defPane=new z({refNode:this.plugin.grid.domNode,title:a.nls.filterDefDialogTitle,"class":"dojoxGridFDTitlePane",iconClass:"dojoxGridFDPaneIcon",content:this.filterDefPane})).startup();this._defPane.connect(a.grid.layer("filter"),"filterDef",h.hitch(this,"_onSetFilter"));a.grid.setFilter=h.hitch(this,"setFilter");a.grid.getFilter=h.hitch(this,"getFilter");a.grid.getFilterRelation=h.hitch(this,function(){return this._relOpCls});a.connect(a.grid.layout,"moveColumn",
h.hitch(this,"onMoveColumn"))},onMoveColumn:function(a,c,b,d,e){if(this._savedCriterias&&b!=d){e&&--d;var g=b<d?b:d,h=b<d?d:b,f=d>g?1:-1;i.forEach(this._savedCriterias,function(a){var c=parseInt(a.column,10);if(!isNaN(c)&&c>=g&&c<=h)a.column=String(c==b?c+(h-g)*f:c-f)})}},destroy:function(){this._defPane.destroyRecursive();this._cboxes=this._dataTypeMap=this.builder=this.filterDefPane=this._defPane=null;var a=this.plugin.grid;a.setFilter=null;a.getFilter=null;this.plugin=a.getFilterRelation=null},
_setupData:function(){var a=this.plugin.nls;this._dataTypeMap={number:{valueBoxCls:{dft:C},conditions:[{label:a.conditionEqual,value:"equalto",selected:!0},{label:a.conditionNotEqual,value:"notequalto"},{label:a.conditionLess,value:"lessthan"},{label:a.conditionLessEqual,value:"lessthanorequalto"},{label:a.conditionLarger,value:"largerthan"},{label:a.conditionLargerEqual,value:"largerthanorequalto"},{label:a.conditionIsEmpty,value:"isempty"}]},string:{valueBoxCls:{dft:B,ac:M},conditions:[{label:a.conditionContains,
value:"contains",selected:!0},{label:a.conditionIs,value:"equalto"},{label:a.conditionStartsWith,value:"startswith"},{label:a.conditionEndWith,value:"endswith"},{label:a.conditionNotContain,value:"notcontains"},{label:a.conditionIsNot,value:"notequalto"},{label:a.conditionNotStartWith,value:"notstartswith"},{label:a.conditionNotEndWith,value:"notendswith"},{label:a.conditionIsEmpty,value:"isempty"}]},date:{valueBoxCls:{dft:D},conditions:[{label:a.conditionIs,value:"equalto",selected:!0},{label:a.conditionBefore,
value:"lessthan"},{label:a.conditionAfter,value:"largerthan"},{label:a.conditionRange,value:"range"},{label:a.conditionIsEmpty,value:"isempty"}]},time:{valueBoxCls:{dft:E},conditions:[{label:a.conditionIs,value:"equalto",selected:!0},{label:a.conditionBefore,value:"lessthan"},{label:a.conditionAfter,value:"largerthan"},{label:a.conditionRange,value:"range"},{label:a.conditionIsEmpty,value:"isempty"}]},"boolean":{valueBoxCls:{dft:N},conditions:[{label:a.conditionIs,value:"equalto",selected:!0},{label:a.conditionIsEmpty,
value:"isempty"}]}}},setFilter:function(a,c){a=a||[];h.isArray(a)||(a=[a]);var b=function(){if(a.length){this._savedCriterias=i.map(a,function(a){var b=a.type||this.defaultType;return{type:b,column:String(a.column),condition:a.condition,value:a.value,colTxt:this.getColumnLabelByValue(String(a.column)),condTxt:this.getConditionLabelByValue(b,a.condition),formattedVal:a.formattedVal||a.value}},this);this._criteriasChanged=!0;if(c==="logicall"||c==="logicany")this._relOpCls=c;var b=i.map(a,this.getExprForCriteria,
this),b=this.builder.buildExpression(b.length==1?b[0]:{op:this._relOpCls,data:b});this.plugin.grid.layer("filter").filterDef(b);this.plugin.filterBar.toggleClearFilterBtn(!1)}this._closeDlgAndUpdateGrid()};if(this._savedCriterias){this._clearWithoutRefresh=!0;var d=n.connect(this,"clearFilter",this,function(){n.disconnect(d);this._clearWithoutRefresh=!1;b.apply(this)});this.onClearFilter()}else b.apply(this)},getFilter:function(){return h.clone(this._savedCriterias)||[]},getColumnLabelByValue:function(a){var c=
this.plugin.nls;return a.toLowerCase()=="anycolumn"?c.anyColumnOption:(a=this.plugin.grid.layout.cells[parseInt(a,10)])?a.name||a.field:""},getConditionLabelByValue:function(a,c){for(var b=this._dataTypeMap[a].conditions,d=b.length-1;d>=0;--d){var e=b[d];if(e.value==c.toLowerCase())return e.label}return""},addCriteriaBoxes:function(a){if(!(typeof a!="number"||a<=0)){var c=this._cboxes,b=this.filterDefPane.cboxContainer,d=this.plugin.args.ruleCount,e=c.length;for(d>0&&e+a>d&&(a=d-e);a>0;--a)d=new v({dlg:this}),
c.push(d),b.addChild(d);b.startup();this._updatePane();this._updateCBoxTitles();b.selectChild(c[c.length-1]);this.filterDefPane.criteriaPane.scrollTop=1E6;if(c.length===4)m("ie")<=6&&!this.__alreadyResizedForIE6?(a=f.position(b.domNode),a.w-=I.getScrollbar().w,b.resize(a),this.__alreadyResizedForIE6=!0):b.resize()}},removeCriteriaBoxes:function(a,c){var b=this._cboxes,d=this.filterDefPane.cboxContainer,e=b.length,g=e-a,f=e-1,j=i.indexOf(b,d.selectedChildWidget.content);if(h.isArray(a)){f=a;f.sort();
a=f.length;for(g=e-1;g>=0&&i.indexOf(f,g)>=0;--g);if(g>=0){g!=j&&d.selectChild(b[g]);for(g=a-1;g>=0;--g)f[g]>=0&&f[g]<e&&(d.removeChild(b[f[g]]),b.splice(f[g],1))}}else{if(c===!0)if(a>=0&&a<e)g=f=a,a=1;else return;else if(a instanceof v)e=a,a=1,g=f=i.indexOf(b,e);else if(typeof a!="number"||a<=0)return;else a>=e&&(a=f,g=1);if(f<g)return;for(j>=g&&j<=f&&d.selectChild(b[g?g-1:f+1]);f>=g;--f)d.removeChild(b[f]);b.splice(g,a)}this._updatePane();this._updateCBoxTitles();b.length===3&&d.resize()},getCriteria:function(a){if(typeof a!=
"number")return this._savedCriterias?this._savedCriterias.length:0;if(this._savedCriterias&&this._savedCriterias[a])return h.mixin({relation:this._relOpCls=="logicall"?this.plugin.nls.and:this.plugin.nls.or},this._savedCriterias[a]);return null},getExprForCriteria:function(a){if(a.column=="anycolumn"){var c=i.filter(this.plugin.grid.layout.cells,function(a){return!(a.filterable===!1||a.hidden)});return{op:"logicany",data:i.map(c,function(b){return this.getExprForColumn(a.value,b.index,a.type,a.condition)},
this)}}else return this.getExprForColumn(a.value,a.column,a.type,a.condition)},getExprForColumn:function(a,c,b,d){var c=parseInt(c,10),e=this.plugin.grid.layout.cells[c],f=e.field||e.name,c={datatype:b||this.getColumnType(c),args:e.dataTypeArgs,isColumn:!0},e=[h.mixin({data:this.plugin.args.isServerSide?f:e},c)];c.isColumn=!1;d=="range"?e.push(h.mixin({data:a.start},c),h.mixin({data:a.end},c)):d!="isempty"&&e.push(h.mixin({data:a},c));return{op:d,data:e}},getColumnType:function(a){a=this.plugin.grid.layout.cells[parseInt(a,
10)];if(!a||!a.datatype)return this.defaultType;a=String(a.datatype).toLowerCase();return this._dataTypeMap[a]?a:this.defaultType},clearFilter:function(a){if(this._savedCriterias){this._savedCriterias=null;this.plugin.grid.layer("filter").filterDef(null);try{this.plugin.filterBar.toggleClearFilterBtn(!0),this.filterDefPane._clearFilterBtn.set("disabled",!0),this.removeCriteriaBoxes(this._cboxes.length-1),this._cboxes[0].load({})}catch(c){}a?this.closeDialog():this._closeDlgAndUpdateGrid()}},showDialog:function(a){this._defPane.show();
this.plugin.filterStatusTip.closeDialog();this._prepareDialog(a)},closeDialog:function(){this._defPane.open&&this._defPane.hide()},onFilter:function(){this.canFilter()&&(this._defineFilter(),this._closeDlgAndUpdateGrid(),this.plugin.filterBar.toggleClearFilterBtn(!1))},onClearFilter:function(){this._savedCriterias&&(this._savedCriterias.length>=this.plugin.ruleCountToConfirmClearFilter?this.plugin.clearFilterDialog.show():this.clearFilter(this._clearWithoutRefresh))},onCancel:function(){var a=this._savedCriterias,
c=this._cboxes;a?(this.addCriteriaBoxes(a.length-c.length),this.removeCriteriaBoxes(c.length-a.length),i.forEach(a,function(a,d){c[d].load(a)})):(this.removeCriteriaBoxes(c.length-1),c[0].load({}));this.closeDialog()},onRendered:function(a){m("ff")?(a=this._defPane,a._getFocusItems(a.domNode),t.focus(a._firstFocusItem)):(a=J._getTabNavigable(f.byId(a.domNode)),t.focus(a.lowest||a.first))},_onSetFilter:function(a){a===null&&this._savedCriterias&&this.clearFilter()},_prepareDialog:function(a){var c=
this._savedCriterias,b=this._cboxes,d;this.curColIdx=a;if(c){if(this._criteriasChanged){this.filterDefPane._relSelect.set("value",this._relOpCls==="logicall"?"0":"1");this._criteriasChanged=!1;var e=c.length>b.length?c.length-b.length:0;this.addCriteriaBoxes(e);this.removeCriteriaBoxes(b.length-c.length);this.filterDefPane._clearFilterBtn.set("disabled",!1);for(a=0;a<b.length-e;++a)b[a].load(c[a]);if(e>0)var f=[],h=n.connect(this,"onRendered",function(a){var d=i.indexOf(b,a);f[d]||(f[d]=!0,--e===
0&&n.disconnect(h),a.load(c[d]))})}}else if(b.length===0)this.addCriteriaBoxes(1);else for(a=0;d=b[a];++a)d.changeCurrentColumn();this.filterDefPane.cboxContainer.resize()},_defineFilter:function(){var a=this._cboxes,c=function(b){return i.filter(i.map(a,function(a){return a[b]()}),function(a){return!!a})},b=c("getExpr");this._savedCriterias=c("save");b=b.length==1?b[0]:{op:this._relOpCls,data:b};b=this.builder.buildExpression(b);this.plugin.grid.layer("filter").filterDef(b);this.filterDefPane._clearFilterBtn.set("disabled",
!1)},_updateCBoxTitles:function(){for(var a=this._cboxes,c=a.length;c>0;--c)a[c-1].updateRuleIndex(c),a[c-1].setAriaInfo(c)},_updatePane:function(){var a=this.filterDefPane;a._addCBoxBtn.set("disabled",this._cboxes.length==this.plugin.args.ruleCount);a._filterBtn.set("disabled",!this.canFilter())},canFilter:function(){return i.filter(this._cboxes,function(a){return!a.isEmpty()}).length>0},_closeDlgAndUpdateGrid:function(){this.closeDialog();var a=this.plugin.grid;a.showMessage(a.loadingMessage);setTimeout(h.hitch(a,
a._refresh),this._defPane.duration+10)}})});