//>>built
define("dojox/grid/enhanced/plugins/Rearrange",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/connect","../../EnhancedGrid","../_Plugin","./_RowMapLayer"],function(q,r,s,k,n,t,u,v){q=s("dojox.grid.enhanced.plugins.Rearrange",u,{name:"rearrange",constructor:function(a,b){this.grid=a;this.setArgs(b);var f=new v(a);dojox.grid.enhanced.plugins.wrap(a,"_storeLayerFetch",f)},setArgs:function(a){this.args=r.mixin(this.args||{},a||{});this.args.setIdentifierForNewItem=
this.args.setIdentifierForNewItem||function(b){return b}},destroy:function(){this.inherited(arguments);this.grid.unwrap("rowmap")},onSetStore:function(){this.grid.layer("rowmap").clearMapping()},_hasIdentity:function(a){var b=this.grid,f=b.store,e=b.layout.cells;if(f.getFeatures()["dojo.data.api.Identity"]&&k.some(a,function(a){return f.getIdentityAttributes(b._by_idx[a.r].item)==e[a.c].field}))return!0;return!1},moveColumns:function(a,b){var f=this.grid,e=f.layout,g=e.cells,h,c,d=0,j=!0;h={};var i=
{};a.sort(function(a,b){return a-b});for(c=0;c<a.length;++c)h[a[c]]=c,a[c]<b&&++d;var l=0,m=0,k=Math.max(a[a.length-1],b);k==g.length&&--k;var o=Math.min(a[0],b);for(c=o;c<=k;++c){var p=h[c];p>=0?i[c]=b-d+p:c<b?(i[c]=o+l,++l):c>=b&&(i[c]=b+a.length-d+m,++m)}d=0;b==g.length&&(--b,j=!1);f._notRefreshSelection=!0;for(c=0;c<a.length;++c){h=a[c];h<b&&(h-=d);++d;if(h!=b)e.moveColumn(g[h].view.idx,g[b].view.idx,h,b,j),g=e.cells;b<=h&&++b}delete f._notRefreshSelection;n.publish("dojox/grid/rearrange/move/"+
f.id,["col",i,a])},moveRows:function(a,b){var f=this.grid,e={},g=[],h=[],c=a.length,d,j,i;for(d=0;d<c;++d){h=a[d];if(h>=b)break;g.push(h)}h=a.slice(d);d=g;if(c=d.length){j={};k.forEach(d,function(a){j[a]=!0});e[d[0]]=b-c;g=0;d=d[g]+1;for(i=d-1;d<b;++d)j[d]?(++g,e[d]=b-c+g):(e[d]=i,++i)}d=h;if(c=d.length){j={};k.forEach(d,function(a){j[a]=!0});e[d[c-1]]=b+c-1;g=c-1;d=d[g]-1;for(i=d+1;d>=b;--d)j[d]?(--g,e[d]=b+g):(e[d]=i,--i)}var l=r.clone(e);f.layer("rowmap").setMapping(e);f.forEachLayer(function(a){return a.name()!=
"rowmap"?(a.invalidate(),!0):!1},!1);f.selection.selected=[];f._noInternalMapping=!0;f._refresh();setTimeout(function(){n.publish("dojox/grid/rearrange/move/"+f.id,["row",l,a]);f._noInternalMapping=!1},0)},moveCells:function(a,b){var f=this.grid,e=f.store;if(e.getFeatures()["dojo.data.api.Write"]&&!(a.min.row==b.min.row&&a.min.col==b.min.col)){var g=f.layout.cells,h,c,d,j,i=[],l=[];h=a.min.row;for(d=b.min.row;h<=a.max.row;++h,++d){c=a.min.col;for(j=b.min.col;c<=a.max.col;++c,++j){for(;g[c]&&g[c].hidden;)++c;
for(;g[j]&&g[j].hidden;)++j;i.push({r:h,c:c});l.push({r:d,c:j,v:g[c].get(h,f._by_idx[h].item)})}}this._hasIdentity(i.concat(l))?console.warn("Can not write to identity!"):(k.forEach(i,function(a){e.setValue(f._by_idx[a.r].item,g[a.c].field,"")}),k.forEach(l,function(a){e.setValue(f._by_idx[a.r].item,g[a.c].field,a.v)}),e.save({onComplete:function(){n.publish("dojox/grid/rearrange/move/"+f.id,["cell",{from:a,to:b}])}}))}},copyCells:function(a,b){var f=this.grid,e=f.store;if(e.getFeatures()["dojo.data.api.Write"]&&
!(a.min.row==b.min.row&&a.min.col==b.min.col)){var g=f.layout.cells,h,c,d,j,i=[];h=a.min.row;for(d=b.min.row;h<=a.max.row;++h,++d){c=a.min.col;for(j=b.min.col;c<=a.max.col;++c,++j){for(;g[c]&&g[c].hidden;)++c;for(;g[j]&&g[j].hidden;)++j;i.push({r:d,c:j,v:g[c].get(h,f._by_idx[h].item)})}}this._hasIdentity(i)?console.warn("Can not write to identity!"):(k.forEach(i,function(a){e.setValue(f._by_idx[a.r].item,g[a.c].field,a.v)}),e.save({onComplete:function(){setTimeout(function(){n.publish("dojox/grid/rearrange/copy/"+
f.id,["cell",{from:a,to:b}])},0)}}))}},changeCells:function(a,b,f){var e=this.grid,g=e.store;if(g.getFeatures()["dojo.data.api.Write"]){var h=e.layout.cells,c=a.layout.cells,d,j,i,l,m=[];d=b.min.row;for(i=f.min.row;d<=b.max.row;++d,++i){j=b.min.col;for(l=f.min.col;j<=b.max.col;++j,++l){for(;c[j]&&c[j].hidden;)++j;for(;h[l]&&h[l].hidden;)++l;m.push({r:i,c:l,v:c[j].get(d,a._by_idx[d].item)})}}this._hasIdentity(m)?console.warn("Can not write to identity!"):(k.forEach(m,function(a){g.setValue(e._by_idx[a.r].item,
h[a.c].field,a.v)}),g.save({onComplete:function(){n.publish("dojox/grid/rearrange/change/"+e.id,["cell",f])}}))}},clearCells:function(a){var b=this.grid,f=b.store;if(f.getFeatures()["dojo.data.api.Write"]){var e=b.layout.cells,g,h,c=[];for(g=a.min.row;g<=a.max.row;++g)for(h=a.min.col;h<=a.max.col;++h){for(;e[h]&&e[h].hidden;)++h;c.push({r:g,c:h})}this._hasIdentity(c)?console.warn("Can not write to identity!"):(k.forEach(c,function(a){f.setValue(b._by_idx[a.r].item,e[a.c].field,"")}),f.save({onComplete:function(){n.publish("dojox/grid/rearrange/change/"+
b.id,["cell",a])}}))}},insertRows:function(a,b,f){try{var e=this.grid,g=e.store,h=e.rowCount,c={},d={idx:0},j=[],i,l=f<0;_this=this;var m=b.length;if(l)f=0;else for(i=f;i<e.rowCount;++i)c[i]=i+m;if(g.getFeatures()["dojo.data.api.Write"]){if(a){var q=a.store,o,p;if(l)p=k.map(e.layout.cells,function(a){return a.field});else{for(i=0;!o;++i)o=e._by_idx[i];p=g.getAttributes(o.item)}var s=[];k.forEach(b,function(b,e){var i={},l=a._by_idx[b];if(l){k.forEach(p,function(a){i[a]=q.getValue(l.item,a)});i=_this.args.setIdentifierForNewItem(i,
g,h+d.idx)||i;try{g.newItem(i),j.push(f+e),c[h+d.idx]=f+e,++d.idx}catch(m){console.log("insertRows newItem:",m,i)}}else s.push(b)})}else if(b.length&&r.isObject(b[0]))k.forEach(b,function(a,b){var e=_this.args.setIdentifierForNewItem(a,g,h+d.idx)||a;try{g.newItem(e),j.push(f+b),c[h+d.idx]=f+b,++d.idx}catch(i){console.log("insertRows newItem:",i,e)}});else return;e.layer("rowmap").setMapping(c);g.save({onComplete:function(){e._refresh();setTimeout(function(){n.publish("dojox/grid/rearrange/insert/"+
e.id,["row",j])},0)}})}}catch(t){console.log("insertRows:",t)}},removeRows:function(a){var b=this.grid,f=b.store;try{k.forEach(k.map(a,function(a){return b._by_idx[a]}),function(a){a&&f.deleteItem(a.item)}),f.save({onComplete:function(){n.publish("dojox/grid/rearrange/remove/"+b.id,["row",a])}})}catch(e){console.log("removeRows:",e)}},_getPageInfo:function(){var a=this.grid.scroller,b=a.page,f=a.page,e=a.firstVisibleRow,g=a.lastVisibleRow,h=a.rowsPerPage,c,d,j,i=[];k.forEach(a.pageNodes[0],function(a,
k){a&&(j=!1,c=k*h,d=(k+1)*h-1,e>=c&&e<=d&&(b=k,j=!0),g>=c&&g<=d&&(f=k,j=!0),!j&&(c>g||d<e)&&i.push(k))});return{topPage:b,bottomPage:f,invalidPages:i}}});t.registerPlugin(q);return q});