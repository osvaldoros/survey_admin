//>>built
define("dojox/grid/_FocusManager",["dojo/_base/array","dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojo/_base/event","dojo/_base/sniff","dojo/query","./util","dojo/_base/html"],function(m,o,p,d,f,n,q,k,h){return p("dojox.grid._FocusManager",null,{constructor:function(a){this.grid=a;this.cell=null;this.rowIndex=-1;this._connects=[];this._headerConnects=[];this.headerMenu=this.grid.headerMenu;this._connects.push(d.connect(this.grid.domNode,"onfocus",this,"doFocus"));this._connects.push(d.connect(this.grid.domNode,
"onblur",this,"doBlur"));this._connects.push(d.connect(this.grid.domNode,"mousedown",this,"_mouseDown"));this._connects.push(d.connect(this.grid.domNode,"mouseup",this,"_mouseUp"));this._connects.push(d.connect(this.grid.domNode,"oncontextmenu",this,"doContextMenu"));this._connects.push(d.connect(this.grid.lastFocusNode,"onfocus",this,"doLastNodeFocus"));this._connects.push(d.connect(this.grid.lastFocusNode,"onblur",this,"doLastNodeBlur"));this._connects.push(d.connect(this.grid,"_onFetchComplete",
this,"_delayedCellFocus"));this._connects.push(d.connect(this.grid,"postrender",this,"_delayedHeaderFocus"))},destroy:function(){m.forEach(this._connects,d.disconnect);m.forEach(this._headerConnects,d.disconnect);delete this.grid;delete this.cell},_colHeadNode:null,_colHeadFocusIdx:null,_contextMenuBindNode:null,tabbingOut:!1,focusClass:"dojoxGridCellFocus",focusView:null,initFocusView:function(){this.focusView=this.grid.views.getFirstScrollingView()||this.focusView||this.grid.views.views[0];this._initColumnHeaders()},
isFocusCell:function(a,b){return this.cell==a&&this.rowIndex==b},isLastFocusCell:function(){if(this.cell)return this.rowIndex==this.grid.rowCount-1&&this.cell.index==this.grid.layout.cellCount-1;return!1},isFirstFocusCell:function(){if(this.cell)return this.rowIndex===0&&this.cell.index===0;return!1},isNoFocusCell:function(){return this.rowIndex<0||!this.cell},isNavHeader:function(){return!!this._colHeadNode},getHeaderIndex:function(){return this._colHeadNode?m.indexOf(this._findHeaderCells(),this._colHeadNode):
-1},_focusifyCellNode:function(a){var b=this.cell&&this.cell.getNode(this.rowIndex);if(b&&(h.toggleClass(b,this.focusClass,a),a)){a=this.scrollIntoView();try{if(!this.grid.edit.isEditing()&&(k.fire(b,"focus"),a))this.cell.view.scrollboxNode.scrollLeft=a}catch(c){}}},_delayedCellFocus:function(){if(!this.isNavHeader()&&this.grid.focused){var a=this.cell&&this.cell.getNode(this.rowIndex);if(a)try{this.grid.edit.isEditing()||(h.toggleClass(a,this.focusClass,!0),this._colHeadNode&&this.blurHeader(),k.fire(a,
"focus"))}catch(b){}}},_delayedHeaderFocus:function(){this.isNavHeader()&&(this.focusHeader(),this.grid.domNode.focus())},_initColumnHeaders:function(){m.forEach(this._headerConnects,d.disconnect);this._headerConnects=[];for(var a=this._findHeaderCells(),b=0;b<a.length;b++)this._headerConnects.push(d.connect(a[b],"onfocus",this,"doColHeaderFocus")),this._headerConnects.push(d.connect(a[b],"onblur",this,"doColHeaderBlur"))},_findHeaderCells:function(){for(var a=q("th",this.grid.viewsHeaderNode),b=
[],c=0;c<a.length;c++){var e=a[c],i=h.hasAttr(e,"tabIndex"),g=h.attr(e,"tabIndex");i&&g<0&&b.push(e)}return b},_setActiveColHeader:function(a,b,c){this.grid.domNode.setAttribute("aria-activedescendant",a.id);c!=null&&c>=0&&c!=b&&h.toggleClass(this._findHeaderCells()[c],this.focusClass,!1);h.toggleClass(a,this.focusClass,!0);this._colHeadNode=a;this._colHeadFocusIdx=b;this._scrollHeader(this._colHeadFocusIdx)},scrollIntoView:function(){var a=this.cell?this._scrollInfo(this.cell):null;if(!a||!a.s)return null;
var b=this.grid.scroller.findScrollTop(this.rowIndex);if(a.n&&a.sr)if(a.n.offsetLeft+a.n.offsetWidth>a.sr.l+a.sr.w)a.s.scrollLeft=a.n.offsetLeft+a.n.offsetWidth-a.sr.w;else if(a.n.offsetLeft<a.sr.l)a.s.scrollLeft=a.n.offsetLeft;a.r&&a.sr&&(b+a.r.offsetHeight>a.sr.t+a.sr.h?this.grid.setScrollTop(b+a.r.offsetHeight-a.sr.h):b<a.sr.t&&this.grid.setScrollTop(b));return a.s.scrollLeft},_scrollInfo:function(a,b){if(a){var c=a.view.scrollboxNode,e={w:c.clientWidth,l:c.scrollLeft,t:c.scrollTop,h:c.clientHeight},
i=a.view.getRowNode(this.rowIndex);return{c:a,s:c,sr:e,n:b?b:a.getNode(this.rowIndex),r:i}}return null},_scrollHeader:function(a){var b=null;if(this._colHeadNode){var c=this.grid.getCell(a);if(!c)return;b=this._scrollInfo(c,c.getNode(0))}if(b&&b.s&&b.sr&&b.n)if(b.n.offsetLeft+b.n.offsetWidth>b.sr.l+b.sr.w)b.s.scrollLeft=b.n.offsetLeft+b.n.offsetWidth-b.sr.w;else if(b.n.offsetLeft<b.sr.l)b.s.scrollLeft=b.n.offsetLeft;else if(n("ie")<=7&&c&&c.view.headerNode)c.view.headerNode.scrollLeft=b.s.scrollLeft},
_isHeaderHidden:function(){var a=this.focusView;if(!a)for(var b=0,c;c=this.grid.views.views[b];b++)if(c.headerNode){a=c;break}return a&&h.getComputedStyle(a.headerNode).display=="none"},colSizeAdjust:function(a,b,c){var e=this._findHeaderCells(),i=this.focusView;if(!i)for(var g=0,d;d=this.grid.views.views[g];g++)if(d.header.tableMap.map){i=d;break}g=e[b];if(i&&!(b==e.length-1&&b===0))i.content.baseDecorateEvent(a),a.cellNode=g,a.cellIndex=i.content.getCellNodeIndex(a.cellNode),a.cell=a.cellIndex>=
0?this.grid.getCell(a.cellIndex):null,i.header.canResize(a)&&(b={l:c},a=i.header.colResizeSetup(a,!1),i.header.doResizeColumn(a,null,b),i.update())},styleRow:function(){},setFocusIndex:function(a,b){this.setFocusCell(this.grid.getCell(b),a)},setFocusCell:function(a,b){if(a&&!this.isFocusCell(a,b))this.tabbingOut=!1,this._colHeadNode&&this.blurHeader(),this._colHeadNode=this._colHeadFocusIdx=null,this.focusGridView(),this._focusifyCellNode(!1),this.cell=a,this.rowIndex=b,this._focusifyCellNode(!0);
if(n("opera"))setTimeout(o.hitch(this.grid,"onCellFocus",this.cell,this.rowIndex),1);else this.grid.onCellFocus(this.cell,this.rowIndex)},next:function(){if(this.cell){var a=this.rowIndex,b=this.cell.index+1,c=this.grid.layout.cellCount-1,e=this.grid.rowCount-1;b>c&&(b=0,a++);a>e&&(b=c,a=e);if(this.grid.edit.isEditing()&&(c=this.grid.getCell(b),!this.isLastFocusCell()&&(!c.editable||this.grid.canEdit&&!this.grid.canEdit(c,a)))){this.cell=c;this.rowIndex=a;this.next();return}this.setFocusIndex(a,b)}},
previous:function(){if(this.cell){var a=this.rowIndex||0,b=(this.cell.index||0)-1;b<0&&(b=this.grid.layout.cellCount-1,a--);a<0&&(b=a=0);if(this.grid.edit.isEditing()){var c=this.grid.getCell(b);if(!this.isFirstFocusCell()&&!c.editable){this.cell=c;this.rowIndex=a;this.previous();return}}this.setFocusIndex(a,b)}},move:function(a,b){var c=b<0?-1:1;if(this.isNavHeader()){var e=this._findHeaderCells(),d=currentIdx=m.indexOf(e,this._colHeadNode);for(currentIdx+=b;currentIdx>=0&&currentIdx<e.length&&e[currentIdx].style.display==
"none";)currentIdx+=c;currentIdx>=0&&currentIdx<e.length&&this._setActiveColHeader(e[currentIdx],currentIdx,d)}else if(this.cell){var g=this.grid.scroller,e=this.rowIndex,d=this.grid.rowCount-1,f=Math.min(d,Math.max(0,e+a));a&&(a>0?f>g.getLastPageRow(g.page)&&this.grid.setScrollTop(this.grid.scrollTop+g.findScrollTop(f)-g.findScrollTop(e)):a<0&&f<=g.getPageRow(g.page)&&this.grid.setScrollTop(this.grid.scrollTop-g.findScrollTop(e)-g.findScrollTop(f)));for(var g=this.grid.layout.cellCount-1,k=this.cell.index,
j=Math.min(g,Math.max(0,k+b)),l=this.grid.getCell(j);j>=0&&j<g&&l&&l.hidden===!0;)j+=c,l=this.grid.getCell(j);if(!l||l.hidden===!0)j=k;c=l.getNode(f);!c&&a?f+a>=0&&f+a<=d&&this.move(a>0?++a:--a,b):(!c||h.style(c,"display")==="none")&&b?j+a>=0&&j+a<=g&&this.move(a,b>0?++b:--b):(this.setFocusIndex(f,j),a&&this.grid.updateRow(e))}},previousKey:function(a){if(this.grid.edit.isEditing())f.stop(a),this.previous();else if(!this.isNavHeader()&&!this._isHeaderHidden())this.grid.domNode.focus(),f.stop(a);else{this.tabOut(this.grid.domNode);
if(this._colHeadFocusIdx!=null)h.toggleClass(this._findHeaderCells()[this._colHeadFocusIdx],this.focusClass,!1),this._colHeadFocusIdx=null;this._focusifyCellNode(!1)}},nextKey:function(a){a.target===this.grid.domNode&&this._colHeadFocusIdx==null?(this.focusHeader(),f.stop(a)):this.isNavHeader()?(this.blurHeader(),this.findAndFocusGridCell()||this.tabOut(this.grid.lastFocusNode),this._colHeadNode=this._colHeadFocusIdx=null):this.grid.edit.isEditing()?(f.stop(a),this.next()):this.tabOut(this.grid.lastFocusNode)},
tabOut:function(a){this.tabbingOut=!0;a.focus()},focusGridView:function(){k.fire(this.focusView,"focus")},focusGrid:function(){this.focusGridView();this._focusifyCellNode(!0)},findAndFocusGridCell:function(){var a=!0,b=this.grid.rowCount===0;this.isNoFocusCell()&&!b?(b=0,this.grid.getCell(b).hidden&&(b=this.isNavHeader()?this._colHeadFocusIdx:0),this.setFocusIndex(0,b)):this.cell&&!b?(this.focusView&&!this.focusView.rowNodes[this.rowIndex]&&this.grid.scrollToRow(this.rowIndex),this.focusGrid()):a=
!1;this._colHeadNode=this._colHeadFocusIdx=null;return a},focusHeader:function(){var a=this._findHeaderCells(),b=this._colHeadFocusIdx;if(this._isHeaderHidden())this.findAndFocusGridCell();else if(!this._colHeadFocusIdx)this._colHeadFocusIdx=this.isNoFocusCell()?0:this.cell.index;for(this._colHeadNode=a[this._colHeadFocusIdx];this._colHeadNode&&this._colHeadFocusIdx>=0&&this._colHeadFocusIdx<a.length&&this._colHeadNode.style.display=="none";)this._colHeadFocusIdx++,this._colHeadNode=a[this._colHeadFocusIdx];
if(this._colHeadNode&&this._colHeadNode.style.display!="none"){if(this.headerMenu&&this._contextMenuBindNode!=this.grid.domNode)this.headerMenu.unBindDomNode(this.grid.viewsHeaderNode),this.headerMenu.bindDomNode(this.grid.domNode),this._contextMenuBindNode=this.grid.domNode;this._setActiveColHeader(this._colHeadNode,this._colHeadFocusIdx,b);this._scrollHeader(this._colHeadFocusIdx);this._focusifyCellNode(!1)}else this.findAndFocusGridCell()},blurHeader:function(){h.removeClass(this._colHeadNode,
this.focusClass);h.removeAttr(this.grid.domNode,"aria-activedescendant");if(this.headerMenu&&this._contextMenuBindNode==this.grid.domNode){var a=this.grid.viewsHeaderNode;this.headerMenu.unBindDomNode(this.grid.domNode);this.headerMenu.bindDomNode(a);this._contextMenuBindNode=a}},doFocus:function(a){if(a&&a.target!=a.currentTarget)f.stop(a);else if(!this._clickFocus)this.tabbingOut||this.focusHeader(),this.tabbingOut=!1,f.stop(a)},doBlur:function(a){f.stop(a)},doContextMenu:function(a){this.headerMenu||
f.stop(a)},doLastNodeFocus:function(a){this.tabbingOut?this._focusifyCellNode(!1):this.grid.rowCount>0?(this.isNoFocusCell()&&this.setFocusIndex(0,0),this._focusifyCellNode(!0)):this.focusHeader();this.tabbingOut=!1;f.stop(a)},doLastNodeBlur:function(a){f.stop(a)},doColHeaderFocus:function(a){this._setActiveColHeader(a.target,h.attr(a.target,"idx"),this._colHeadFocusIdx);this._scrollHeader(this.getHeaderIndex());f.stop(a)},doColHeaderBlur:function(a){h.toggleClass(a.target,this.focusClass,!1)},_mouseDown:function(a){this._clickFocus=
dojo.some(this.grid.views.views,function(b){return b.scrollboxNode===a.target})},_mouseUp:function(){this._clickFocus=!1}})});