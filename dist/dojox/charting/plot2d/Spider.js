//>>built
define("dojox/charting/plot2d/Spider",["dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojo/_base/html","dojo/_base/array","dojo/dom-geometry","dojo/_base/fx","dojo/fx","dojo/_base/sniff","../Element","./_PlotEvents","dojo/_base/Color","dojox/color/_base","./common","../axis2d/common","../scaler/primitive","dojox/gfx","dojox/gfx/matrix","dojox/gfx/fx","dojox/lang/functional","dojox/lang/utils","dojo/fx/easing"],function(H,V,I,W,J,N,O,X,Y,Z,$,aa,P,x,Q,R,y,K,S,T,U,C){function ba(a){a=(new P.Color(a)).toHsl();
a.s==0?a.l=a.l<50?100:0:(a.s=100,a.l=a.l<50?75:a.l>75?50:a.l-50>75-a.l?50:75);a=P.fromHsl(a);a.a=0.7;return a}return V("dojox.charting.plot2d.Spider",[Z,$],{defaultParams:{labels:!0,ticks:!1,fixed:!0,precision:1,labelOffset:-10,labelStyle:"default",htmlLabels:!0,startAngle:-90,divisions:3,axisColor:"",axisWidth:0,spiderColor:"",spiderWidth:0,seriesWidth:0,seriesFillAlpha:0.2,spiderOrigin:0.16,markerSize:3,spiderType:"polygon",animationType:C.backOut,axisTickFont:"",axisTickFontColor:"",axisFont:"",
axisFontColor:""},optionalParams:{radius:0,font:"",fontColor:""},constructor:function(a,b){this.opt=H.clone(this.defaultParams);U.updateWithObject(this.opt,b);U.updateWithPattern(this.opt,b,this.optionalParams);this.series=[];this.dyn=[];this.datas={};this.labelKey=[];this.oldSeriePoints={};this.animations={}},clear:function(){this.dirty=!0;this.dyn=[];this.series=[];this.datas={};this.labelKey=[];this.oldSeriePoints={};this.animations={};return this},setAxis:function(){return this},addSeries:function(a){this.series.push(a);
for(var b in a.data){var d=a.data[b],e=this.datas[b];e?(e.vlist.push(d),e.min=Math.min(e.min,d),e.max=Math.max(e.max,d)):this.datas[b]={min:d,max:d,vlist:[d]}}if(this.labelKey.length<=0)for(b in a.data)this.labelKey.push(b);return this},getSeriesStats:function(){return x.collectSimpleStats(this.series)},calculateAxes:function(a){this.initializeScalers(a,this.getSeriesStats());return this},getRequiredColors:function(){return this.series.length},initializeScalers:function(a,b){this._hAxis?(this._hAxis.initialized()||
this._hAxis.calculate(b.hmin,b.hmax,a.width),this._hScaler=this._hAxis.getScaler()):this._hScaler=R.buildScaler(b.hmin,b.hmax,a.width);this._vAxis?(this._vAxis.initialized()||this._vAxis.calculate(b.vmin,b.vmax,a.height),this._vScaler=this._vAxis.getScaler()):this._vScaler=R.buildScaler(b.vmin,b.vmax,a.height);return this},render:function(a,b){if(!this.dirty)return this;this.dirty=!1;this.cleanGroup();var d=this.group,e=this.chart.theme;this.resetEvents();if(!this.series||!this.series.length)return this;
var c=this.opt,g=e.axis,f=(a.width-b.l-b.r)/2,i=(a.height-b.t-b.b)/2,l=Math.min(f,i),o=c.font||g.majorTick&&g.majorTick.font||g.tick&&g.tick.font||"normal normal normal 7pt Tahoma",j=c.axisFont||g.tick&&g.tick.titleFont||"normal normal normal 11pt Tahoma",r=c.axisTickFontColor||g.majorTick&&g.majorTick.fontColor||g.tick&&g.tick.fontColor||"silver",D=c.axisFontColor||g.tick&&g.tick.titleFontColor||"black",t=c.axisColor||g.tick&&g.tick.axisColor||"silver",k=c.spiderColor||g.tick&&g.tick.spiderColor||
"silver",ca=c.axisWidth||g.stroke&&g.stroke.width||2,u=c.spiderWidth||g.stroke&&g.stroke.width||2,g=c.seriesWidth||g.stroke&&g.stroke.width||2,n=y.normalizedLength(y.splitFontString(j).size),B=K._degToRad(c.startAngle),x,p,L,q,z,v,s=c.spiderOrigin,A=c.divisions>=3?c.divisions:3,C=c.markerSize,H=c.spiderType,I=c.animationType,h=c.labelOffset<-10?c.labelOffset:-10;c.labels&&(l=J.map(this.series,function(a){return a.name},this),l=T.foldl1(T.map(l,function(a){return y._base._getTextBox(a,{font:e.series.font}).w},
this),"Math.max(a, b)")/2,l=Math.min(f-2*l,i-n)+h,x=l-h);if("radius"in c)l=c.radius,x=l-h;l/=1.2;f={cx:b.l+f,cy:b.t+i,r:l};for(i=this.series.length-1;i>=0;i--){var m=this.series[i];if(!this.dirty&&!m.dirty)e.skip();else if(m.cleanGroup(),h=m.data,h!==null&&(n=this._getObjectLength(h),!p||p.length<=0))if(p=[],L=[],v=[],this._buildPoints(p,n,f,l,B,!0),this._buildPoints(L,n,f,l*s,B,!0),this._buildPoints(v,n,f,x,B),A>2){q=[];z=[];for(h=0;h<A-2;h++)q[h]=[],this._buildPoints(q[h],n,f,l*(s+(1-s)*(h+1)/(A-
1)),B,!0),z[h]=l*(s+(1-s)*(h+1)/(A-1))}}n=d.createGroup();t={color:t,width:ca};i={color:k,width:u};for(h=p.length-1;h>=0;--h)k=p[h],u={x:k.x+(k.x-f.cx)*0.2,y:k.y+(k.y-f.cy)*0.2},k={x:k.x+(k.x-f.cx)*0.2/2,y:k.y+(k.y-f.cy)*0.2/2},n.createLine({x1:f.cx,y1:f.cy,x2:u.x,y2:u.y}).setStroke(t),this._drawArrow(n,u,k,t);n=d.createGroup();for(h=v.length-1;h>=0;--h)k=v[h],u=y._base._getTextBox(this.labelKey[h],{font:j}).w||0,t=this.opt.htmlLabels&&y.renderer!="vml"?"html":"gfx",k=Q.createText[t](this.chart,n,
!N.isBodyLtr()&&t=="html"?k.x+u-a.width:k.x,k.y,"middle",this.labelKey[h],j,D),this.opt.htmlLabels&&this.htmlElements.push(k);j=d.createGroup();if(H=="polygon"){if(j.createPolyline(p).setStroke(i),j.createPolyline(L).setStroke(i),q.length>0)for(h=q.length-1;h>=0;--h)j.createPolyline(q[h]).setStroke(i)}else if(this._getObjectLength(this.datas),j.createCircle({cx:f.cx,cy:f.cy,r:l}).setStroke(i),j.createCircle({cx:f.cx,cy:f.cy,r:l*s}).setStroke(i),z.length>0)for(h=z.length-1;h>=0;--h)j.createCircle({cx:f.cx,
cy:f.cy,r:z[h]}).setStroke(i);z=d.createGroup();n=this._getObjectLength(this.datas);p=0;for(var E in this.datas){j=this.datas[E];q=j.min;j=j.max;j-=q;D=B+2*Math.PI*p/n;for(i=0;i<A;i++)v=q+j*i/(A-1),k=this._getCoordinate(f,l*(s+(1-s)*i/(A-1)),D),v=this._getLabel(v),u=y._base._getTextBox(v,{font:o}).w||0,t=this.opt.htmlLabels&&y.renderer!="vml"?"html":"gfx",this.opt.htmlLabels&&this.htmlElements.push(Q.createText[t](this.chart,z,!N.isBodyLtr()&&t=="html"?k.x+u-a.width:k.x,k.y,"start",v,o,r));p++}this.chart.seriesShapes=
{};for(i=this.series.length-1;i>=0;i--)if(m=this.series[i],h=m.data,h!==null){var w=[];p=0;var F=[];for(E in h)j=this.datas[E],q=j.min,j=j.max,j-=q,o=h[E],D=B+2*Math.PI*p/n,k=this._getCoordinate(f,l*(s+(1-s)*(o-q)/j),D),w.push(k),F.push({sname:m.name,key:E,data:o}),p++;w[w.length]=w[0];F[F.length]=F[0];var o=this._getBoundary(w),r=e.next("spider",[c,m]),M=m.group,G=y.normalizeColor(r.series.fill),r={color:r.series.fill,width:g};G.a=c.seriesFillAlpha;m.dyn={fill:G,stroke:r};r=this._createSeriesEntry(M,
this.oldSeriePoints[m.name]||L,w,G,r,l,s,C,I);this.chart.seriesShapes[m.name]=r;this.oldSeriePoints[m.name]=w;this._connectEvents({element:"spider_poly",index:i,id:"spider_poly_"+m.name,run:m,plot:this,shape:r.poly,parent:M,brect:o,cx:f.cx,cy:f.cy,cr:l,f:G,s:d});this._connectEvents({element:"spider_plot",index:i,id:"spider_plot_"+m.name,run:m,plot:this,shape:m.group});J.forEach(r.circles,function(a,b){a.getShape();this._connectEvents({element:"spider_circle",index:b,id:"spider_circle_"+m.name+b,run:m,
plot:this,shape:a,parent:M,tdata:F[b],cx:w[b].x,cy:w[b].y,f:G,s:d})},this)}return this},_createSeriesEntry:function(a,b,d,e,c,g,f,i,l){for(var o=a.createPolyline(b).setFill(e).setStroke(c),j=[],g=0;g<b.length;g++)f=b[g],f=a.createCircle({cx:f.x,cy:f.y,r:i}).setFill(e).setStroke(c),j.push(f);e=J.map(d,function(a,c){var d=new O.Animation({duration:1E3,easing:l,curve:[b[c].y,a.y]}),e=j[c];I.connect(d,"onAnimate",function(a){var b=o.getShape();b.points[c].y=a;o.setShape(b);b=e.getShape();b.cy=a;e.setShape(b)});
return d});d=J.map(d,function(a,c){var d=new O.Animation({duration:1E3,easing:l,curve:[b[c].x,a.x]}),e=j[c];I.connect(d,"onAnimate",function(a){var b=o.getShape();b.points[c].x=a;o.setShape(b);b=e.getShape();b.cx=a;e.setShape(b)});return d});X.combine(e.concat(d)).play();return{group:a,poly:o,circles:j}},plotEvent:function(a){var b=a.id?a.id:"default";b in this.animations?(b=this.animations[b],b.anim&&b.anim.stop(!0)):b=this.animations[b]={};if(a.element=="spider_poly"){if(!b.color){var d=a.shape.getFill();
if(!d||!(d instanceof aa))return;b.color={start:d,end:ba(d)}}var d=b.color.start,e=b.color.end;if(a.type=="onmouseout")var c=d,d=e,e=c;b.anim=S.animateFill({shape:a.shape,duration:800,easing:C.backOut,color:{start:d,end:e}});b.anim.play()}else if(a.element=="spider_circle"){if(a.type=="onmouseover"){e=K.identity;d=1.5;e={type:"rect"};e.x=a.cx;e.y=a.cy;e.width=e.height=1;c=W.coords(this.chart.node,!0);e.x+=c.x;e.y+=c.y;e.x=Math.round(e.x);e.y=Math.round(e.y);e.width=Math.ceil(e.width);e.height=Math.ceil(e.height);
this.aroundRect=e;var g=["after","before"];x.doIfLoaded("dijit/Tooltip",dojo.hitch(this,function(b){b.show(a.tdata.sname+"<br/>"+a.tdata.key+"<br/>"+a.tdata.data,this.aroundRect,g)}))}else e=K.scaleAt(1.5,a.cx,a.cy),d=1/1.5,x.doIfLoaded("dijit/Tooltip",dojo.hitch(this,function(a){this.aroundRect&&a.hide(this.aroundRect)}));c=a.shape.getShape();e=K.scaleAt(1.5,c.cx,c.cy);b.anim=S.animateTransform({shape:a.shape,duration:200,easing:C.backOut,transform:[{name:"scaleAt",start:[1,c.cx,c.cy],end:[d,c.cx,
c.cy]},e]});b.anim.play()}else a.element=="spider_plot"&&a.type=="onmouseover"&&!Y("ie")&&a.shape.moveToFront()},_getBoundary:function(a){for(var b=a[0].x,d=a[0].x,e=a[0].y,c=a[0].y,g=0;g<a.length;g++)var f=a[g],b=Math.max(f.x,b),e=Math.max(f.y,e),d=Math.min(f.x,d),c=Math.min(f.y,c);return{x:d,y:c,width:b-d,height:e-c}},_drawArrow:function(a,b,d,e){var c=Math.sqrt(Math.pow(d.x-b.x,2)+Math.pow(d.y-b.y,2)),g=(d.y-b.y)/c,f=(d.x-b.x)/c;a.createPolyline([b,{x:d.x+c/3*-g,y:d.y+c/3*f},{x:d.x+c/3*g,y:d.y+
c/3*-f}]).setFill(e.color).setStroke(e)},_buildPoints:function(a,b,d,e,c,g){for(var f=0;f<b;f++)a.push(this._getCoordinate(d,e,c+2*Math.PI*f/b));g&&a.push(this._getCoordinate(d,e,c+2*Math.PI))},_getCoordinate:function(a,b,d){return{x:a.cx+b*Math.cos(d),y:a.cy+b*Math.sin(d)}},_getObjectLength:function(a){var b=0;if(H.isObject(a))for(var d in a)b++;return b},_getLabel:function(a){return x.getLabel(a,this.opt.fixed,this.opt.precision)}})});