//>>built
define("dojox/rpc/OfflineRest",["dojo","dojox","dojox/data/ClientFilter","dojox/rpc/Rest","dojox/storage"],function(g,d){function k(a){return a.replace(/[^0-9A-Za-z_]/g,"_")}function n(a,c){if(l&&!p&&(c||a&&a.__id))d.storage.put(k(c||a.__id),typeof a=="object"?d.json.ref.toJson(a):a,function(){},i)}function r(a){return a instanceof Error&&(a.status==503||a.status>12E3||!a.status)}function s(){if(l){var a=d.storage.get("dirty",i);if(a)for(var c in a)t(c,a)}}function q(){f.sendChanges();f.downloadChanges()}
function u(a,c,b,e,h){a=="delete"?d.storage.remove(k(c),i):d.storage.put(k(b),e,function(){},i);if(a=h&&h._store)a.updateResultSet(a._localBaseResults,a._localBaseFetch),d.storage.put(k(h._getRequest(a._localBaseFetch.query).url),d.json.ref.toJson(a._localBaseResults),function(){},i)}function t(a,c){var b=c[a],e=d.rpc.JsonRest.getServiceAndId(b.id),e=v(b.method,e.service,e.id,b.content);c[a]=b;d.storage.put("dirty",c,function(){},i);e.addBoth(function(c){if(r(c))return null;var b=d.storage.get("dirty",
i)||{};delete b[a];d.storage.put("dirty",b,function(){},i);return c});return e}var m=d.rpc.Rest,i="dojox_rpc_OfflineRest",l,o=m._index;d.storage.manager.addOnLoad(function(){l=d.storage.manager.available;for(var a in o)n(o[a],a)});var p,f,x=setInterval(q,15E3);g.connect(document,"ononline",q);f=d.rpc.OfflineRest={turnOffAutoSync:function(){clearInterval(x)},sync:q,sendChanges:s,downloadChanges:function(){},addStore:function(a,c){f.stores.push(a);a.fetch({queryOptions:{cache:!0},query:c,onComplete:function(c,
d){a._localBaseResults=c;a._localBaseFetch=d}})}};f.stores=[];var y=m._get;m._get=function(a,c){try{s();if(window.navigator&&navigator.onLine===!1)throw Error();var b=y(a,c)}catch(e){b=new g.Deferred,b.errback(e)}var h=d.rpc._sync;b.addCallback(function(d){n(d,a._getRequest(c).url);return d});b.addErrback(function(e){if(l)if(r(e)){var w={},j=function(a,c){if(w[a])return c;var b=g.fromJson(d.storage.get(k(a),i))||c;w[a]=b;for(var e in b){var h=b[e];if(a=h&&h.$ref)a.substring&&a.substring(0,4)=="cid:"&&
(a=a.substring(4)),b[e]=j(a,h)}if(b instanceof Array)for(e=0;e<b.length;e++)b[e]===void 0&&b.splice(e--,1);return b};p=!0;var f=j(a._getRequest(c).url);if(!f)return e;p=!1;return f}else return e;else{if(h)return Error("Storage manager not loaded, can not continue");b=new g.Deferred;b.addCallback(arguments.callee);d.storage.manager.addOnLoad(function(){b.callback()});return b}});return b};g.addOnLoad(function(){g.connect(d.data,"restListener",function(a){var c=a.channel,b=a.event.toLowerCase(),e=d.rpc.JsonRest&&
d.rpc.JsonRest.getServiceAndId(c).service;u(b,c,b=="post"?c+a.result.id:c,g.toJson(a.result),e)})});var v=m._change;m._change=function(a,c,b,e){if(!l)return v.apply(this,arguments);var h=c._getRequest(b).url;u(a,h,d.rpc.JsonRest._contentId,e,c);var g=d.storage.get("dirty",i)||{};if(a=="put"||a=="delete")var f=h;else{var f=0,j;for(j in g)isNaN(parseInt(j))||(f=j);f++}g[f]={method:a,id:h,content:e};return t(f,g)};g.connect(o,"onLoad",n);g.connect(o,"onUpdate",n);return d.rpc.OfflineRest});