//>>built
define("dojox/form/uploader/plugins/HTML5",["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo"],function(e,d,g,f){e=e("dojox.form.uploader.plugins.HTML5",[],{errMsg:"Error uploading files. Try checking permissions",uploadType:"html5",postCreate:function(){this.connectForm();this.inherited(arguments);this.uploadOnSelect&&this.connect(this,"onChange",function(a){this.upload(a[0])})},_drop:function(a){f.stopEvent(a);this._files=a.dataTransfer.files;this.onChange(this.getFileList())},upload:function(a){this.onBegin(this.getFileList());
this.supports("FormData")?this.uploadWithFormData(a):this.supports("sendAsBinary")&&this.sendAsBinary(a)},addDropTarget:function(a,b){b||(this.connect(a,"dragenter",f.stopEvent),this.connect(a,"dragover",f.stopEvent),this.connect(a,"dragleave",f.stopEvent));this.connect(a,"drop","_drop")},sendAsBinary:function(a){if(this.getUrl()){var b="---------------------------"+(new Date).getTime(),c=this.createXhr();c.setRequestHeader("Content-Type","multipart/form-data; boundary="+b);if(a=this._buildRequestBody(a,
b))console.log("msg:",a),console.log("xhr:",c),c.sendAsBinary(a);else this.onError(this.errMsg)}else console.error("No upload url found.",this)},uploadWithFormData:function(a){if(this.getUrl()){var b=new FormData;g.forEach(this._files,function(a){b.append(this.name+"s[]",a)},this);if(a)for(var c in a)b.append(c,a[c]);this.createXhr().send(b)}else console.error("No upload url found.",this)},_xhrProgress:function(a){if(a.lengthComputable){var b={bytesLoaded:a.loaded,bytesTotal:a.total,type:a.type,timeStamp:a.timeStamp};
a.type=="load"?(b.percent="100%",b.decimal=1):(b.decimal=a.loaded/a.total,b.percent=Math.ceil(a.loaded/a.total*100)+"%");this.onProgress(b)}},createXhr:function(){var a=new XMLHttpRequest,b;a.upload.addEventListener("progress",d.hitch(this,"_xhrProgress"),!1);a.addEventListener("load",d.hitch(this,"_xhrProgress"),!1);a.addEventListener("error",d.hitch(this,function(a){this.onError(a);clearInterval(b)}),!1);a.addEventListener("abort",d.hitch(this,function(a){this.onAbort(a);clearInterval(b)}),!1);
a.onreadystatechange=d.hitch(this,function(){a.readyState===4&&(clearInterval(b),this.onComplete(JSON.parse(a.responseText.replace(/^\{\}&&/,""))))});a.open("POST",this.getUrl());b=setInterval(d.hitch(this,function(){}),250);return a},_buildRequestBody:function(a,b){var c="",b="--"+b,d=[],e=this._files;g.forEach(e,function(a,e){var f=this.name+"s[]",g=a.fileName,h;try{h=a.getAsBinary()+"\r\n",c+=b+"\r\n",c+="Content-Disposition: form-data; ",c+='name="'+f+'"; ',c+='filename="'+g+'"\r\n',c+="Content-Type: "+
this.getMimeType()+"\r\n\r\n",c+=h}catch(i){d.push({index:e,name:g})}},this);d.length&&d.length>=e.length&&(this.onError({message:this.errMsg,filesInError:d}),c=!1);if(!c)return!1;if(a)for(var f in a)c+=b+"\r\n",c+="Content-Disposition: form-data; ",c+='name="'+f+'"\r\n\r\n',c+=a[f]+"\r\n";c+=b+"--\r\n";return c}});dojox.form.addUploaderPlugin(e);return e});