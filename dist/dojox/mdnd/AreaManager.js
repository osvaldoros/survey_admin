//>>built
define("dojox/mdnd/AreaManager",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/connect","dojo/_base/window","dojo/_base/array","dojo/query","dojo/_base/html","./Moveable"],function(b){var i=b.declare("dojox.mdnd.AreaManager",null,{autoRefresh:!0,areaClass:"dojoxDndArea",dragHandleClass:"dojoxDragHandle",constructor:function(){this._areaList=[];this.resizeHandler=b.connect(b.global,"onresize",this,function(){this._dropMode.updateAreas(this._areaList)});this._oldIndexArea=this._currentIndexArea=
this._oldDropIndex=this._currentDropIndex=this._sourceIndexArea=this._sourceDropIndex=-1},init:function(){this.registerByClass()},registerByNode:function(a,c){var d=this._getIndexArea(a);if(a&&d==-1){var d=(d=a.getAttribute("accept"))?d.split(/\s*,\s*/):["text"],e={node:a,items:[],coords:{},margin:null,accept:d,initItems:!1};b.forEach(this._getChildren(a),function(a){this._setMarginArea(e,a);e.items.push(this._addMoveableItem(a))},this);this._areaList=this._dropMode.addArea(this._areaList,e);c||this._dropMode.updateAreas(this._areaList);
b.publish("/dojox/mdnd/manager/register",[a])}},registerByClass:function(){b.query("."+this.areaClass).forEach(function(a){this.registerByNode(a,!0)},this);this._dropMode.updateAreas(this._areaList)},unregister:function(a){a=this._getIndexArea(a);if(a!=-1)return b.forEach(this._areaList[a].items,function(a){this._deleteMoveableItem(a)},this),this._areaList.splice(a,1),this._dropMode.updateAreas(this._areaList),!0;return!1},_addMoveableItem:function(a){a.setAttribute("tabIndex","0");var c=this._searchDragHandle(a),
d=new dojox.mdnd.Moveable({handle:c,skip:!0},a);b.addClass(c||a,"dragHandle");c=a.getAttribute("dndType");c={item:d,type:c?c.split(/\s*,\s*/):["text"],handlers:[b.connect(d,"onDragStart",this,"onDragStart")]};if(dijit&&dijit.byNode){var e=dijit.byNode(a);if(e)c.type=e.dndType?e.dndType.split(/\s*,\s*/):["text"],c.handlers.push(b.connect(e,"uninitialize",this,function(){this.removeDragItem(a.parentNode,d.node)}))}return c},_deleteMoveableItem:function(a){b.forEach(a.handlers,function(a){b.disconnect(a)});
var c=a.item.node,d=this._searchDragHandle(c);b.removeClass(d||c,"dragHandle");a.item.destroy()},_getIndexArea:function(a){if(a)for(var c=0;c<this._areaList.length;c++)if(this._areaList[c].node===a)return c;return-1},_searchDragHandle:function(a){if(a){var c=this.dragHandleClass.split(" "),d=c.length,e="";b.forEach(c,function(a,c){e+="."+a;c!=d-1&&(e+=", ")});return b.query(e,a)[0]}},addDragItem:function(a,c,d,b){var g=!0;b||(g=a&&c&&(c.parentNode===null||c.parentNode&&c.parentNode.nodeType!==1));
if(g&&(b=this._getIndexArea(a),b!==-1)){var g=this._addMoveableItem(c),f=this._areaList[b].items;if(0<=d&&d<f.length){var h=f.slice(0,d),i=f.slice(d,f.length);h[h.length]=g;this._areaList[b].items=h.concat(i);a.insertBefore(c,f[d].item.node)}else this._areaList[b].items.push(g),a.appendChild(c);this._setMarginArea(this._areaList[b],c);this._areaList[b].initItems=!1;return!0}return!1},removeDragItem:function(a,c){var b=this._getIndexArea(a);if(a&&b!==-1)for(var b=this._areaList[b].items,e=0;e<b.length;e++)if(b[e].item.node===
c)return this._deleteMoveableItem(b[e]),b.splice(e,1),a.removeChild(c);return null},_getChildren:function(a){var c=[];b.forEach(a.childNodes,function(a){if(a.nodeType==1)if(dijit&&dijit.byNode){var b=dijit.byNode(a);b?b.dragRestriction||c.push(a):c.push(a)}else c.push(a)});return c},_setMarginArea:function(a,c){if(a&&a.margin===null&&c)a.margin=b._getMarginExtents(c)},findCurrentIndexArea:function(a,b){this._oldIndexArea=this._currentIndexArea;this._currentIndexArea=this._dropMode.getTargetArea(this._areaList,
a,this._currentIndexArea);if(this._currentIndexArea!=this._oldIndexArea){if(this._oldIndexArea!=-1)this.onDragExit(a,b);if(this._currentIndexArea!=-1)this.onDragEnter(a,b)}return this._currentIndexArea},_isAccepted:function(a,b){this._accept=!1;for(var d=0;d<b.length;++d)for(var e=0;e<a.length;++e)if(a[e]==b[d]){this._accept=!0;break}},onDragStart:function(a,c,d){this.autoRefresh&&this._dropMode.updateAreas(this._areaList);var e=b.isWebKit?b.body():b.body().parentNode;if(!this._cover)this._cover=
b.create("div",{"class":"dndCover"}),this._cover2=b.clone(this._cover),b.addClass(this._cover2,"dndCover2");this._cover.style.height=this._cover2.style.height=e.scrollHeight+"px";b.body().appendChild(this._cover);b.body().appendChild(this._cover2);this._dragStartHandler=b.connect(a.ownerDocument,"ondragstart",b,"stopEvent");this._sourceIndexArea=this._lastValidIndexArea=this._currentIndexArea=this._getIndexArea(a.parentNode);for(var e=this._areaList[this._sourceIndexArea],g=e.items,f=0;f<g.length;f++)if(g[f].item.node==
a){this._dragItem=g[f];this._dragItem.handlers.push(b.connect(this._dragItem.item,"onDrag",this,"onDrag"));this._dragItem.handlers.push(b.connect(this._dragItem.item,"onDragEnd",this,"onDrop"));g.splice(f,1);this._currentDropIndex=this._sourceDropIndex=f;break}g=null;if(this._sourceDropIndex!==e.items.length)g=e.items[this._sourceDropIndex].item.node;if(b.isIE>7)this._eventsIE7=[b.connect(this._cover,"onmouseover",b,"stopEvent"),b.connect(this._cover,"onmouseout",b,"stopEvent"),b.connect(this._cover,
"onmouseenter",b,"stopEvent"),b.connect(this._cover,"onmouseleave",b,"stopEvent")];f=a.style;f.left=c.x+"px";f.top=c.y+"px";if(f.position=="relative"||f.position=="")f.position="absolute";this._cover.appendChild(a);this._dropIndicator.place(e.node,g,d);b.addClass(a,"dragNode");this._accept=!0;b.publish("/dojox/mdnd/drag/start",[a,e,this._sourceDropIndex])},onDragEnter:function(){this._currentIndexArea===this._sourceIndexArea?this._accept=!0:this._isAccepted(this._dragItem.type,this._areaList[this._currentIndexArea].accept)},
onDragExit:function(){this._accept=!1},onDrag:function(a,b,d,e){a=this._dropMode.getDragPoint(b,d,e);this.findCurrentIndexArea(a,d);this._currentIndexArea!==-1&&this._accept&&this.placeDropIndicator(a,d)},placeDropIndicator:function(a,b){this._oldDropIndex=this._currentDropIndex;var d=this._areaList[this._currentIndexArea];d.initItems||this._dropMode.initItems(d);this._currentDropIndex=this._dropMode.getDropIndex(d,a);this._currentIndexArea===this._oldIndexArea&&this._oldDropIndex===this._currentDropIndex||
this._placeDropIndicator(b);return this._currentDropIndex},_placeDropIndicator:function(a){var b=this._areaList[this._currentIndexArea];this._dropMode.refreshItems(this._areaList[this._lastValidIndexArea],this._oldDropIndex,a,!1);var d=null;if(this._currentDropIndex!=-1)d=b.items[this._currentDropIndex].item.node;this._dropIndicator.place(b.node,d);this._lastValidIndexArea=this._currentIndexArea;this._dropMode.refreshItems(b,this._currentDropIndex,a,!0)},onDropCancel:function(){if(!this._accept){var a=
this._getIndexArea(this._dropIndicator.node.parentNode);this._currentIndexArea=a!=-1?a:0}},onDrop:function(a){this.onDropCancel();var c=this._areaList[this._currentIndexArea];b.removeClass(a,"dragNode");var d=a.style;d.position="relative";d.left="0";d.top="0";d.width="auto";c.node==this._dropIndicator.node.parentNode?c.node.insertBefore(a,this._dropIndicator.node):(c.node.appendChild(a),this._currentDropIndex=c.items.length);d=this._currentDropIndex;if(d==-1)d=c.items.length;var e=c.items,g=e.slice(0,
d),e=e.slice(d,e.length);g[g.length]=this._dragItem;c.items=g.concat(e);this._setMarginArea(c,a);b.forEach(this._areaList,function(a){a.initItems=!1});b.disconnect(this._dragItem.handlers.pop());b.disconnect(this._dragItem.handlers.pop());this._resetAfterDrop();this._cover&&(b.body().removeChild(this._cover),b.body().removeChild(this._cover2));b.publish("/dojox/mdnd/drop",[a,c,d])},_resetAfterDrop:function(){this._accept=!1;this._dragItem=null;this._sourceDropIndex=this._sourceIndexArea=this._oldDropIndex=
this._currentIndexArea=this._currentDropIndex=-1;this._dropIndicator.remove();this._dragStartHandler&&b.disconnect(this._dragStartHandler);b.isIE>7&&b.forEach(this._eventsIE7,b.disconnect)},destroy:function(){for(;this._areaList.length>0;)if(!this.unregister(this._areaList[0].node))throw Error("Error while destroying AreaManager");b.disconnect(this.resizeHandler);this._dropIndicator.destroy();this._dropMode.destroy();dojox.mdnd.autoScroll&&dojox.mdnd.autoScroll.destroy();this.refreshListener&&b.unsubscribe(this.refreshListener);
this._cover&&(b._destroyElement(this._cover),b._destroyElement(this._cover2),delete this._cover,delete this._cover2)}});dijit&&dijit._Widget&&b.extend(dijit._Widget,{dndType:"text"});dojox.mdnd._areaManager=null;dojox.mdnd.areaManager=function(){if(!dojox.mdnd._areaManager)dojox.mdnd._areaManager=new dojox.mdnd.AreaManager;return dojox.mdnd._areaManager};return i});