//>>built
define("dojox/mdnd/adapter/DndToDojo",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/html","dojo/_base/connect","dojo/_base/window","dojo/_base/array","dojox/mdnd/PureSource","dojox/mdnd/LazyManager"],function(a){var h=a.declare("dojox.mdnd.adapter.DndToDojo",null,{_dojoList:null,_currentDojoArea:null,_dojoxManager:null,_dragStartHandler:null,_dropHandler:null,_moveHandler:null,_moveUpHandler:null,_draggedNode:null,constructor:function(){this._dojoList=[];this._currentDojoArea=null;this._dojoxManager=
dojox.mdnd.areaManager();this._dragStartHandler=a.subscribe("/dojox/mdnd/drag/start",this,function(b){this._draggedNode=b;this._moveHandler=a.connect(a.doc,"onmousemove",this,"onMouseMove")});this._dropHandler=a.subscribe("/dojox/mdnd/drop",this,function(){this._currentDojoArea&&a.publish("/dojox/mdnd/adapter/dndToDojo/cancel",[this._currentDojoArea.node,this._currentDojoArea.type,this._draggedNode,this.accept]);this._currentDojoArea=this._draggedNode=null;a.disconnect(this._moveHandler)})},_getIndexDojoArea:function(b){if(b)for(var a=
0,d=this._dojoList.length;a<d;a++)if(this._dojoList[a].node===b)return a;return-1},_initCoordinates:function(b){if(b){var b=a.position(b,!0),c={};c.x=b.x;c.y=b.y;c.x1=b.x+b.w;c.y1=b.y+b.h;return c}return null},register:function(a,c,d){if(this._getIndexDojoArea(a)==-1){var e=this._initCoordinates(a);this._dojoList.push({node:a,type:c,dojo:d?d:!1,coords:e});if(d&&!this._lazyManager)this._lazyManager=new dojox.mdnd.LazyManager}},unregisterByNode:function(a){a=this._getIndexDojoArea(a);a!=-1&&this._dojoList.splice(a,
1)},unregisterByType:function(b){if(b){var c=[];a.forEach(this._dojoList,function(a){a.type!=b&&c.push(a)});this._dojoList=c}},unregister:function(){this._dojoList=[]},refresh:function(){var b=this._dojoList;this.unregister();a.forEach(b,function(a){a.coords=this._initCoordinates(a.node)},this);this._dojoList=b},refreshByType:function(b){var c=this._dojoList;this.unregister();a.forEach(c,function(a){if(a.type==b)a.coords=this._initCoordinates(a.node)},this);this._dojoList=c},_getHoverDojoArea:function(a){this._oldDojoArea=
this._currentDojoArea;this._currentDojoArea=null;for(var c=a.x,a=a.y,d=this._dojoList.length,e=0;e<d;e++){var g=this._dojoList[e],f=g.coords;if(f.x<=c&&c<=f.x1&&f.y<=a&&a<=f.y1){this._currentDojoArea=g;break}}},onMouseMove:function(a){this._getHoverDojoArea({x:a.pageX,y:a.pageY});if(this._currentDojoArea!=this._oldDojoArea)if(this._currentDojoArea==null)this.onDragExit(a);else{if(this._oldDojoArea!=null)this.onDragExit(a);this.onDragEnter(a)}},isAccepted:function(){return!0},onDragEnter:function(b){if(this._currentDojoArea.dojo){a.disconnect(this._dojoxManager._dragItem.handlers.pop());
a.disconnect(this._dojoxManager._dragItem.handlers.pop());a.disconnect(this._dojoxManager._dragItem.item.events.pop());a.body().removeChild(this._dojoxManager._cover);a.body().removeChild(this._dojoxManager._cover2);var c=this._dojoxManager._dragItem.item.node;dojox.mdnd.adapter._dndFromDojo&&dojox.mdnd.adapter._dndFromDojo.unsubscribeDnd();a.style(c,{position:"relative",top:"0",left:"0"});this._lazyManager.startDrag(b,c);var d=a.connect(this._lazyManager.manager,"overSource",this,function(){a.disconnect(d);
if(this._lazyManager.manager.canDropFlag)this._dojoxManager._dropIndicator.node.style.display="none"});this.cancelHandler=a.subscribe("/dnd/cancel",this,function(){var b=this._dojoxManager._dragItem.item;b.events=[a.connect(b.handle,"onmousedown",b,"onMouseDown")];a.body().appendChild(this._dojoxManager._cover);a.body().appendChild(this._dojoxManager._cover2);this._dojoxManager._cover.appendChild(b.node);this._dojoxManager._dragItem.handlers.push(a.connect(this._dojoxManager._dragItem.item,"onDrag",
this._dojoxManager,"onDrag"));this._dojoxManager._dragItem.handlers.push(a.connect(this._dojoxManager._dragItem.item,"onDragEnd",this._dojoxManager,"onDrop"));this._draggedNode.style.display="";this._dojoxManager.onDrop(this._draggedNode);a.unsubscribe(this.cancelHandler);a.unsubscribe(this.dropHandler);dojox.mdnd.adapter._dndFromDojo&&dojox.mdnd.adapter._dndFromDojo.subscribeDnd()});this.dropHandler=a.subscribe("/dnd/drop/before",this,function(){a.unsubscribe(this.cancelHandler);a.unsubscribe(this.dropHandler);
this.onDrop()})}else if(this.accept=this.isAccepted(this._dojoxManager._dragItem.item.node,this._currentDojoArea))if(a.disconnect(this._dojoxManager._dragItem.handlers.pop()),a.disconnect(this._dojoxManager._dragItem.handlers.pop()),this._dojoxManager._dropIndicator.node.style.display="none",!this._moveUpHandler)this._moveUpHandler=a.connect(a.doc,"onmouseup",this,"onDrop");a.publish("/dojox/mdnd/adapter/dndToDojo/over",[this._currentDojoArea.node,this._currentDojoArea.type,this._draggedNode,this.accept])},
onDragExit:function(b){if(this._oldDojoArea.dojo){a.unsubscribe(this.cancelHandler);a.unsubscribe(this.dropHandler);var c=this._dojoxManager._dragItem.item;this._dojoxManager._dragItem.item.events.push(a.connect(c.node.ownerDocument,"onmousemove",c,"onMove"));a.body().appendChild(this._dojoxManager._cover);a.body().appendChild(this._dojoxManager._cover2);this._dojoxManager._cover.appendChild(c.node);var d=c.node.style;d.position="absolute";d.left=c.offsetDrag.l+b.pageX+"px";d.top=c.offsetDrag.t+b.pageX+
"px";d.display="";this._lazyManager.cancelDrag();dojox.mdnd.adapter._dndFromDojo&&dojox.mdnd.adapter._dndFromDojo.subscribeDnd();if(this._dojoxManager._dropIndicator.node.style.display=="none")this._dojoxManager._dropIndicator.node.style.display="";this._dojoxManager._dragItem.handlers.push(a.connect(this._dojoxManager._dragItem.item,"onDrag",this._dojoxManager,"onDrag"));this._dojoxManager._dragItem.handlers.push(a.connect(this._dojoxManager._dragItem.item,"onDragEnd",this._dojoxManager,"onDrop"));
this._dojoxManager._dragItem.item.onMove(b)}else if(this.accept){if(this._moveUpHandler)a.disconnect(this._moveUpHandler),this._moveUpHandler=null;if(this._dojoxManager._dropIndicator.node.style.display=="none")this._dojoxManager._dropIndicator.node.style.display="";this._dojoxManager._dragItem.handlers.push(a.connect(this._dojoxManager._dragItem.item,"onDrag",this._dojoxManager,"onDrag"));this._dojoxManager._dragItem.handlers.push(a.connect(this._dojoxManager._dragItem.item,"onDragEnd",this._dojoxManager,
"onDrop"));this._dojoxManager._dragItem.item.onMove(b)}a.publish("/dojox/mdnd/adapter/dndToDojo/out",[this._oldDojoArea.node,this._oldDojoArea.type,this._draggedNode,this.accept])},onDrop:function(){this._currentDojoArea.dojo&&dojox.mdnd.adapter._dndFromDojo&&dojox.mdnd.adapter._dndFromDojo.subscribeDnd();if(this._dojoxManager._dropIndicator.node.style.display=="none")this._dojoxManager._dropIndicator.node.style.display="";this._dojoxManager._cover.parentNode&&this._dojoxManager._cover.parentNode.nodeType==
1&&(a.body().removeChild(this._dojoxManager._cover),a.body().removeChild(this._dojoxManager._cover2));this._draggedNode.parentNode==this._dojoxManager._cover&&this._dojoxManager._cover.removeChild(this._draggedNode);a.disconnect(this._moveHandler);a.disconnect(this._moveUpHandler);this._moveHandler=this._moveUpHandler=null;a.publish("/dojox/mdnd/adapter/dndToDojo/drop",[this._draggedNode,this._currentDojoArea.node,this._currentDojoArea.type]);a.removeClass(this._draggedNode,"dragNode");var b=this._draggedNode.style;
b.position="relative";b.left="0";b.top="0";b.width="auto";a.forEach(this._dojoxManager._dragItem.handlers,a.disconnect);this._dojoxManager._deleteMoveableItem(this._dojoxManager._dragItem);this._currentDojoArea=this._draggedNode=null;this._dojoxManager._resetAfterDrop()}});dojox.mdnd.adapter._dndToDojo=null;dojox.mdnd.adapter.dndToDojo=function(){if(!dojox.mdnd.adapter._dndToDojo)dojox.mdnd.adapter._dndToDojo=new dojox.mdnd.adapter.DndToDojo;return dojox.mdnd.adapter._dndToDojo};return h});