//>>built
define("dojox/geo/openlayers/Map",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/html","dojox/main","dojox/geo/openlayers/TouchInteractionSupport","dojox/geo/openlayers/Layer","dojox/geo/openlayers/Patch"],function(l,m,n,j,o,k,g,p,i,q){l.experimental("dojox.geo.openlayers.Map");n.getObject("geo.openlayers",!0,g);g.geo.openlayers.BaseLayerType={OSM:"OSM",WMS:"WMS",GOOGLE:"Google",VIRTUAL_EARTH:"VirtualEarth",BING:"VirtualEarth",YAHOO:"Yahoo",
ARCGIS:"ArcGIS"};g.geo.openlayers.EPSG4326=new OpenLayers.Projection("EPSG:4326");var r=/^\s*(\d{1,3})[D\u00b0]\s*(\d{1,2})[M']\s*(\d{1,2}\.?\d*)\s*(S|"|'')\s*([NSEWnsew]{0,1})\s*$/i;g.geo.openlayers.parseDMS=function(a,b){var c=r.exec(a);if(c==null||c.length<5)return parseFloat(a);var d=parseFloat(c[1]),e=parseFloat(c[2]),f=parseFloat(c[3]),c=c[5];if(b){c=c.toLowerCase();d+=(e+f/60)/60;if(c=="w"||c=="s")d=-d;return d}return[d,e,f,c]};q.patchGFX();return m("dojox.geo.openlayers.Map",null,{olMap:null,
_tp:null,constructor:function(a,b){b||(b={});a=k.byId(a);this._tp={x:0,y:0};var c=b.openLayersMapOptions;c||(c={controls:[new OpenLayers.Control.ScaleLine({maxWidth:200}),new OpenLayers.Control.Navigation]});if(b.accessible){var d=new OpenLayers.Control.KeyboardDefaults;if(!c.controls)c.controls=[];c.controls.push(d)}k.style(a,{width:"100%",height:"100%",dir:"ltr"});this.olMap=c=new OpenLayers.Map(a,c);this._layerDictionary={olLayers:[],layers:[]};if(b.touchHandler)this._touchControl=new p(c);this.addLayer(this._createBaseLayer(b));
this.initialFit(b)},initialFit:function(a){(a=a.initialLocation)||(a=[-160,70,160,-70]);this.fitTo(a)},setBaseLayerType:function(a){if(a==this.baseLayerType)return null;var b=null;if(typeof a=="string")b={baseLayerName:a,baseLayerType:a},this.baseLayerType=a;else if(typeof a=="object")b=a,this.baseLayerType=b.baseLayerType;a=null;if(b!=null&&(a=this._createBaseLayer(b),a!=null)){var b=this.olMap,c=b.getZoom(),d=b.getCenter(),e=!!d&&!!b.baseLayer&&!!b.baseLayer.map;if(e){var f=b.getProjectionObject();
f!=null&&(d=d.transform(f,g.geo.openlayers.EPSG4326))}f=b.baseLayer;f!=null&&this.removeLayer(this._getLayer(f));a!=null&&this.addLayer(a);e&&(f=b.getProjectionObject(),f!=null&&(d=d.transform(g.geo.openlayers.EPSG4326,f)),b.setCenter(d,c))}return a},getBaseLayerType:function(){return this.baseLayerType},getScale:function(a){var b;b=this.olMap;if(a){if(!b.getUnits())return null;a=OpenLayers.INCHES_PER_UNIT;b=(b.getGeodesicPixelSize().w||1.0E-6)*a.km*OpenLayers.DOTS_PER_INCH}else b=b.getScale();return b},
getOLMap:function(){return this.olMap},_createBaseLayer:function(a){var b=null,c=a.baseLayerType,d=a.baseLayerUrl,e=a.baseLayerName,a=a.baseLayerOptions;e||(e=c);a||(a={});switch(c){case g.geo.openlayers.BaseLayerType.OSM:a.transitionEffect="resize";b=new i(e,{olLayer:new OpenLayers.Layer.OSM(e,d,a)});break;case g.geo.openlayers.BaseLayerType.WMS:if(!d&&(d="http://labs.metacarta.com/wms/vmap0",!a.layers))a.layers="basic";b=new i(e,{olLayer:new OpenLayers.Layer.WMS(e,d,a,{transitionEffect:"resize"})});
break;case g.geo.openlayers.BaseLayerType.GOOGLE:b=new i(e,{olLayer:new OpenLayers.Layer.Google(e,a)});break;case g.geo.openlayers.BaseLayerType.VIRTUAL_EARTH:b=new i(e,{olLayer:new OpenLayers.Layer.VirtualEarth(e,a)});break;case g.geo.openlayers.BaseLayerType.YAHOO:b=new i(e,{olLayer:new OpenLayers.Layer.Yahoo(e,a)});break;case g.geo.openlayers.BaseLayerType.ARCGIS:d||(d="http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer/export"),b=new i(e,{olLayer:new OpenLayers.Layer.ArcGIS93Rest(e,
d,a,{})})}if(b==null)c instanceof OpenLayers.Layer?b=c:(a.transitionEffect="resize",b=new i(e,{olLayer:new OpenLayers.Layer.OSM(e,d,a)}),this.baseLayerType=g.geo.openlayers.BaseLayerType.OSM);return b},removeLayer:function(a){var b=this.olMap,c=j.indexOf(this._layerDictionary.layers,a);c>0&&this._layerDictionary.layers.splice(c,1);var a=a.olLayer,d=j.indexOf(this._layerDictionary.olLayers,a);d>0&&this._layerDictionary.olLayers.splice(c,d);b.removeLayer(a,!1)},layerIndex:function(a,b){var c=this.olMap;
if(!b)return c.getLayerIndex(a.olLayer);c.setLayerIndex(a.olLayer,b);this._layerDictionary.layers.sort(function(a,b){return c.getLayerIndex(a.olLayer)-c.getLayerIndex(b.olLayer)});this._layerDictionary.olLayers.sort(function(a,b){return c.getLayerIndex(a)-c.getLayerIndex(b)});return b},addLayer:function(a){a.dojoMap=this;var b=this.olMap,c=a.olLayer;this._layerDictionary.olLayers.push(c);this._layerDictionary.layers.push(a);b.addLayer(c);a.added()},_getLayer:function(a){a=j.indexOf(this._layerDictionary.olLayers,
a);if(a!=-1)return this._layerDictionary.layers[a];return null},getLayer:function(a,b){var c=this.olMap.getBy("layers",a,b),d=[];j.forEach(c,function(a){d.push(this._getLayer(a))},this);return d},getLayerCount:function(){var a=this.olMap;if(a.layers==null)return 0;return a.layers.length},fitTo:function(a){var b=this.olMap,c=g.geo.openlayers.EPSG4326;if(a==null)a=this.transformXY(0,0,c),b.setCenter(new OpenLayers.LonLat(a.x,a.y));else{var d=null,e=typeof a=="string"?o.fromJson(a):a,f;if(e.hasOwnProperty("bounds")){var h=
e.bounds,d=new OpenLayers.Bounds;f=this.transformXY(h[0],h[1],c);d.left=f.x;d.top=f.y;f=this.transformXY(h[2],h[3],c);d.right=f.x;d.bottom=f.y}if(d==null&&e.hasOwnProperty("position"))h=e.position,e=e.hasOwnProperty("extent")?e.extent:1,typeof e=="string"&&(e=parseFloat(e)),d=new OpenLayers.Bounds,f=this.transformXY(h[0]-e,h[1]+e,c),d.left=f.x,d.top=f.y,f=this.transformXY(h[0]+e,h[1]-e,c),d.right=f.x,d.bottom=f.y;if(d==null&&a.length==4)d=new OpenLayers.Bounds,f=this.transformXY(a[0],a[1],c),d.left=
f.x,d.top=f.y,f=this.transformXY(a[2],a[3],c),d.right=f.x,d.bottom=f.y;d!=null&&b.zoomToExtent(d,!0)}},transform:function(a,b,c){return this.transformXY(a.x,a.y,b,c)},transformXY:function(a,b,c,d){var e=this._tp;e.x=a;e.y=b;if(!c)c=g.geo.openlayers.EPSG4326;d||(d=this.olMap.getProjectionObject());return e=OpenLayers.Projection.transform(e,c,d)}})});